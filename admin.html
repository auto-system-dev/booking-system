<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訂房系統管理後台</title>
    <link rel="stylesheet" href="admin.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Quill 富文本編輯器 -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
</head>
<body>
    <div class="admin-container">
        <!-- 側邊欄 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>🏨 管理後台</h1>
            </div>
            <nav class="sidebar-nav">
                <a href="#bookings" class="nav-item active" data-section="bookings">
                    <span class="nav-icon">📋</span>
                    <span>訂房記錄</span>
                </a>
                <a href="#statistics" class="nav-item" data-section="statistics">
                    <span class="nav-icon">📊</span>
                    <span>統計資料</span>
                </a>
                <a href="#room-types" class="nav-item" data-section="room-types">
                    <span class="nav-icon">🛏️</span>
                    <span>房型管理</span>
                </a>
                <a href="#settings" class="nav-item" data-section="settings">
                    <span class="nav-icon">⚙️</span>
                    <span>系統設定</span>
                </a>
                <a href="#email-templates" class="nav-item" data-section="email-templates">
                    <span class="nav-icon">📧</span>
                    <span>郵件模板</span>
                </a>
            </nav>
        </aside>

        <!-- 主內容區 -->
        <main class="main-content">
            <!-- 訂房記錄區 -->
            <section id="bookings-section" class="content-section active">
                <div class="section-header">
                    <h2>📋 訂房記錄管理</h2>
                    <div class="header-actions">
                        <button class="btn-refresh" onclick="loadBookings()">
                            <span>🔄</span> 重新整理
                        </button>
                    </div>
                </div>

                <!-- 搜尋和篩選 -->
                <div class="filter-bar">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="搜尋訂房編號、姓名、Email..." onkeyup="filterBookings()">
                        <span class="search-icon">🔍</span>
                    </div>
                    <div class="filter-group">
                        <select id="roomTypeFilter" onchange="filterBookings()">
                            <option value="">所有房型</option>
                            <option value="標準雙人房">標準雙人房</option>
                            <option value="豪華雙人房">豪華雙人房</option>
                            <option value="尊爵套房">尊爵套房</option>
                            <option value="家庭四人房">家庭四人房</option>
                        </select>
                        <select id="statusFilter" onchange="filterBookings()">
                            <option value="">所有付款狀態</option>
                            <option value="paid">已付款</option>
                            <option value="pending">待付款</option>
                            <option value="failed">付款失敗</option>
                            <option value="refunded">已退款</option>
                        </select>
                        <input type="date" id="checkInDateFilter" onchange="filterBookings()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="入住日期">
                    </div>
                </div>

                <!-- 訂房記錄表格 -->
                <div class="table-container">
                    <table class="bookings-table">
                        <thead>
                            <tr>
                                <th>訂房編號</th>
                                <th>客戶姓名</th>
                                <th>房型</th>
                                <th onclick="sortByCheckInDate()" style="cursor: pointer; user-select: none;">
                                    入住日期 
                                    <span id="checkInDateSortIcon" style="font-size: 12px; color: #667eea;">⇅</span>
                                </th>
                                <th>住宿天數</th>
                                <th>總金額</th>
                                <th>應付金額</th>
                                <th>付款方式</th>
                                <th>付款狀態</th>
                                <th>訂房狀態</th>
                                <th>郵件狀態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTableBody">
                            <tr>
                                <td colspan="12" class="loading">載入中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分頁 -->
                <div class="pagination" id="pagination"></div>
            </section>

            <!-- 統計資料區 -->
            <section id="statistics-section" class="content-section">
                <div class="section-header">
                    <h2>📊 統計資料</h2>
                    <button class="btn-refresh" onclick="loadStatistics()">
                        <span>🔄</span> 重新整理
                    </button>
                </div>

                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-icon">📋</div>
                        <div class="stat-value" id="totalBookings">-</div>
                        <div class="stat-label">總訂房數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">💰</div>
                        <div class="stat-value" id="totalRevenue">-</div>
                        <div class="stat-label">總營收</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📅</div>
                        <div class="stat-value" id="recentBookings">-</div>
                        <div class="stat-label">近7天訂房</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📧</div>
                        <div class="stat-value" id="emailSent">-</div>
                        <div class="stat-label">郵件已發送</div>
                    </div>
                </div>

                <!-- 房型統計 -->
                <div class="room-stats">
                    <h3>房型統計</h3>
                    <div class="room-stats-list" id="roomStatsList">
                        <div class="loading">載入中...</div>
                    </div>
                </div>
            </section>

            <!-- 房型管理區 -->
            <section id="room-types-section" class="content-section">
                <div class="section-header">
                    <h2>🛏️ 房型管理</h2>
                    <div class="header-actions">
                        <button class="btn-primary" onclick="showAddRoomTypeModal()">
                            <span>➕</span> 新增房型
                        </button>
                        <button class="btn-refresh" id="roomTypeFilterBtn" onclick="toggleRoomTypeFilter()">
                            <span>📋</span> 顯示所有房型
                        </button>
                        <button class="btn-refresh" onclick="loadRoomTypes()">
                            <span>🔄</span> 重新整理
                        </button>
                    </div>
                </div>

                <div class="room-types-container">
                    <table class="bookings-table">
                        <thead>
                            <tr>
                                <th>排序</th>
                                <th>圖示</th>
                                <th>房型代碼</th>
                                <th>房型名稱</th>
                                <th>價格/晚</th>
                                <th>狀態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="roomTypesTableBody">
                            <tr>
                                <td colspan="7" class="loading">載入中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 系統設定區 -->
            <section id="settings-section" class="content-section">
                <div class="section-header">
                    <h2>⚙️ 系統設定</h2>
                    <button class="btn-refresh" onclick="loadSettings()">
                        <span>🔄</span> 重新整理
                    </button>
                </div>

                <div class="settings-container">
                    <div class="settings-card">
                        <h3>付款設定</h3>
                        <div class="form-group">
                            <label>訂金百分比</label>
                            <div class="input-group">
                                <input type="number" id="depositPercentage" min="0" max="100" step="1" placeholder="30">
                                <span class="input-suffix">%</span>
                            </div>
                            <small>設定訂金佔總金額的百分比（例如：30 表示 30%）</small>
                        </div>
                        <div class="form-group">
                            <label>銀行名稱</label>
                            <input type="text" id="bankName" placeholder="例如：XXX銀行">
                            <small>銀行全名</small>
                        </div>
                        <div class="form-group">
                            <label>分行名稱</label>
                            <input type="text" id="bankBranch" placeholder="例如：XXX分行">
                            <small>分行全名</small>
                        </div>
                        <div class="form-group">
                            <label>帳號</label>
                            <input type="text" id="bankAccount" placeholder="例如：1234567890123">
                            <small>匯款帳號</small>
                        </div>
                        <div class="form-group">
                            <label>戶名</label>
                            <input type="text" id="accountName" placeholder="例如：XXX">
                            <small>帳戶戶名</small>
                        </div>
                    </div>
                    
                    <div class="settings-card" style="margin-top: 20px;">
                        <h3>付款方式設定</h3>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="enableTransfer" style="width: 20px; height: 20px;">
                                <span>啟用匯款轉帳</span>
                            </label>
                            <small>勾選後，客戶在前台可以選擇匯款轉帳付款</small>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="enableCard" style="width: 20px; height: 20px;">
                                <span>啟用線上刷卡</span>
                            </label>
                            <small>勾選後，客戶在前台可以選擇線上刷卡付款（需填寫綠界串接碼）</small>
                        </div>
                    </div>
                    
                    <div class="settings-card" style="margin-top: 20px;">
                        <h3>綠界支付設定</h3>
                        <div class="form-group">
                            <label>MerchantID（商店代號）</label>
                            <input type="text" id="ecpayMerchantID" placeholder="例如：2000132">
                            <small>綠界提供的商店代號</small>
                        </div>
                        <div class="form-group">
                            <label>HashKey（金鑰）</label>
                            <input type="text" id="ecpayHashKey" placeholder="例如：5294y06JbISpM5x9">
                            <small>綠界提供的 HashKey</small>
                        </div>
                        <div class="form-group">
                            <label>HashIV（向量）</label>
                            <input type="text" id="ecpayHashIV" placeholder="例如：v77hoKGq4kWxNNIS">
                            <small>綠界提供的 HashIV</small>
                        </div>
                        <button class="btn-save" onclick="saveSettings()">儲存設定</button>
                    </div>
                </div>
            </section>

            <!-- 郵件模板區 -->
            <section id="email-templates-section" class="content-section">
                <div class="section-header">
                    <h2>📧 郵件模板管理</h2>
                    <button class="btn-refresh" onclick="loadEmailTemplates()">
                        <span>🔄</span> 重新整理
                    </button>
                </div>

                <div class="email-templates-container">
                    <div class="templates-list" id="emailTemplatesList">
                        <div class="loading">載入中...</div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- 訂房詳情模態框 -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>訂房詳情</h3>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 詳情內容將動態載入 -->
            </div>
        </div>
    </div>

    <!-- 郵件模板編輯模態框 -->
    <div id="emailTemplateModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="emailTemplateModalTitle">編輯郵件模板</h2>
                <button class="modal-close" onclick="closeEmailTemplateModal()">&times;</button>
            </div>
            <form id="emailTemplateForm" onsubmit="saveEmailTemplate(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label>模板名稱</label>
                        <input type="text" id="emailTemplateName" required>
                    </div>
                    <div class="form-group">
                        <label>郵件主旨</label>
                        <input type="text" id="emailTemplateSubject" required>
                    </div>
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <label style="margin: 0;">郵件內容</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button type="button" id="toggleEditorModeBtn" class="btn-secondary" style="padding: 5px 15px; font-size: 12px;">
                                    <span id="editorModeText">切換到 HTML 模式</span>
                                </button>
                                <div class="variable-buttons" style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    <button type="button" class="btn-var" onclick="insertVariable('{{guestName}}')" title="插入客戶姓名">姓名</button>
                                    <button type="button" class="btn-var" onclick="insertVariable('{{bookingId}}')" title="插入訂房編號">訂房編號</button>
                                    <button type="button" class="btn-var" onclick="insertVariable('{{checkInDate}}')" title="插入入住日期">入住日期</button>
                                    <button type="button" class="btn-var" onclick="insertVariable('{{checkOutDate}}')" title="插入退房日期">退房日期</button>
                                    <button type="button" class="btn-var" onclick="insertVariable('{{roomType}}')" title="插入房型">房型</button>
                                    <button type="button" class="btn-var" onclick="insertVariable('{{finalAmount}}')" title="插入應付金額">應付金額</button>
                                </div>
                            </div>
                        </div>
                        <!-- 富文本編輯器容器 -->
                        <div id="emailTemplateEditor" style="height: 400px; background: white; border: 1px solid #ddd; border-radius: 4px;"></div>
                        <!-- HTML 原始碼編輯器（隱藏） -->
                        <textarea id="emailTemplateContent" rows="20" required style="display: none; font-family: monospace; font-size: 12px; width: 100%;"></textarea>
                        <small style="margin-top: 10px; display: block; color: #666;">
                            💡 提示：使用上方按鈕插入變數，或直接點擊「姓名」、「訂房編號」等按鈕快速插入。點擊「切換到 HTML 模式」可查看/編輯原始 HTML 代碼。
                        </small>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="emailTemplateEnabled" style="width: 20px; height: 20px;">
                            <span>啟用此模板</span>
                        </label>
                    </div>
                    
                    <!-- 入住提醒設定 -->
                    <div id="checkinReminderSettings" class="form-group" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 15px;">
                        <h3 style="margin-top: 0; font-size: 16px; color: #333;">發送時間設定</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label>入住前幾天發送</label>
                                <input type="number" id="daysBeforeCheckin" min="0" max="30" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label>發送時間（24小時制）</label>
                                <input type="number" id="sendHourCheckin" min="0" max="23" value="9" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 感謝入住設定 -->
                    <div id="feedbackRequestSettings" class="form-group" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 15px;">
                        <h3 style="margin-top: 0; font-size: 16px; color: #333;">發送時間設定</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label>退房後幾天發送</label>
                                <input type="number" id="daysAfterCheckout" min="0" max="30" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label>發送時間（24小時制）</label>
                                <input type="number" id="sendHourFeedback" min="0" max="23" value="10" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 匯款提醒設定 -->
                    <div id="paymentReminderSettings" class="form-group" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 15px;">
                        <h3 style="margin-top: 0; font-size: 16px; color: #333;">發送時間設定</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label>訂房後幾天發送（保留天數）</label>
                                <input type="number" id="daysReserved" min="1" max="30" value="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <small style="color: #666; display: block; margin-top: 5px;">超過此天數未付款，訂房狀態將自動改為「已取消」</small>
                            </div>
                            <div>
                                <label>發送時間（24小時制）</label>
                                <input type="number" id="sendHourPaymentReminder" min="0" max="23" value="9" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn-primary">儲存</button>
                    <button type="button" class="btn-secondary" onclick="closeEmailTemplateModal()">取消</button>
                </div>
            </form>
        </div>
    </div>

    <script src="admin.js?v=20241212"></script>
</body>
</html>

