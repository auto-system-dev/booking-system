<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訂房系統管理後台</title>
    <link rel="stylesheet" href="admin.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <!-- Quill 富文本編輯器 -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
</head>
<body>
    <!-- 登入頁面 -->
    <div id="loginPage" class="login-page" style="display: none;">
        <div class="login-container">
            <div class="login-box">
                <div class="login-box-header">
                    <h2>管理後台登入</h2>
                    <p class="subtitle">登入以管理訂房系統</p>
                </div>
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>帳號</label>
                        <input type="text" id="loginUsername" name="username" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label>密碼</label>
                        <input type="password" id="loginPassword" name="password" required autocomplete="current-password">
                    </div>
                    <div id="loginError" class="error-message" style="display: none;"></div>
                    <button type="submit" class="btn-primary" style="width: 100%; margin-top: 20px;">登入</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 管理後台主頁面 -->
    <div id="adminPage" class="admin-container" style="display: none;">
        <!-- 側邊欄 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>管理後台</h1>
            </div>
            <nav class="sidebar-nav">
                <a href="#dashboard" class="nav-item" data-section="dashboard">
                    <span class="nav-icon"><span class="material-symbols-outlined">speed</span></span>
                    <span>儀表板</span>
                </a>
                <a href="#bookings" class="nav-item active" data-section="bookings">
                    <span class="nav-icon"><span class="material-symbols-outlined">event_note</span></span>
                    <span>訂房記錄</span>
                </a>
                <a href="#customers" class="nav-item" data-section="customers">
                    <span class="nav-icon"><span class="material-symbols-outlined">people</span></span>
                    <span>客戶管理</span>
                </a>
                <a href="#statistics" class="nav-item" data-section="statistics">
                    <span class="nav-icon"><span class="material-symbols-outlined">monitoring</span></span>
                    <span>統計資料</span>
                </a>
                <a href="#room-types" class="nav-item" data-section="room-types">
                    <span class="nav-icon"><span class="material-symbols-outlined">king_bed</span></span>
                    <span>房型管理</span>
                </a>
                <a href="#addons" class="nav-item" data-section="addons">
                    <span class="nav-icon"><span class="material-symbols-outlined">add_shopping_cart</span></span>
                    <span>加購商品</span>
                </a>
                <a href="#settings" class="nav-item" data-section="settings">
                    <span class="nav-icon"><span class="material-symbols-outlined">settings</span></span>
                    <span>系統設定</span>
                </a>
                <a href="#email-templates" class="nav-item" data-section="email-templates">
                    <span class="nav-icon"><span class="material-symbols-outlined">mail</span></span>
                    <span>郵件模板</span>
                </a>
            </nav>
            <div class="sidebar-footer" style="margin-top: auto; padding: 20px; border-top: 1px solid #e0e0e0;">
                <div style="margin-bottom: 10px; color: #666; font-size: 14px;">
                    <span id="adminInfo">管理員：<span id="currentAdminUsername">-</span></span>
                </div>
                <button class="btn-secondary" onclick="handleLogout()" style="width: 100%;">
                    <span class="material-symbols-outlined">logout</span> 登出
                </button>
            </div>
        </aside>

        <!-- 主內容區 -->
        <main class="main-content">
            <!-- 儀表板區 -->
            <section id="dashboard-section" class="content-section">
                <div class="section-header">
                    <h2><span class="material-symbols-outlined" style="font-size: 28px; vertical-align: middle; margin-right: 8px;">speed</span> 儀表板</h2>
                    <button class="btn-refresh" onclick="loadDashboard()">
                        <span class="material-symbols-outlined">refresh</span> 重新整理
                    </button>
                </div>

                <div class="dashboard-grid">
                    <!-- 今日房況卡片 -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-icon"><span class="material-symbols-outlined">room_service</span></div>
                        <div class="dashboard-card-title">今日房況</div>
                        <div class="dashboard-card-subtitle">住房/退房為今日</div>
                        <div class="dashboard-card-metrics">
                            <div class="dashboard-metric">
                                <div class="dashboard-metric-label">今日住房</div>
                                <div class="dashboard-metric-value" id="todayCheckIns">0</div>
                            </div>
                            <div class="dashboard-metric">
                                <div class="dashboard-metric-label">今日退房</div>
                                <div class="dashboard-metric-value" id="todayCheckOuts">0</div>
                            </div>
                        </div>
                        <button class="dashboard-card-button" onclick="switchSection('bookings')">前往訂單列表</button>
                    </div>

                    <!-- 今日訂單卡片 -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-icon"><span class="material-symbols-outlined">order_approve</span></div>
                        <div class="dashboard-card-title">今日訂單</div>
                        <div class="dashboard-card-subtitle">訂購日為今日</div>
                        <div class="dashboard-card-metrics">
                            <div class="dashboard-metric">
                                <div class="dashboard-metric-label">匯款轉帳</div>
                                <div class="dashboard-metric-value" id="todayTransferOrders">0</div>
                            </div>
                            <div class="dashboard-metric">
                                <div class="dashboard-metric-label">線上刷卡</div>
                                <div class="dashboard-metric-value" id="todayCardOrders">0</div>
                            </div>
                        </div>
                        <button class="dashboard-card-button" onclick="switchSection('bookings')">前往訂單列表</button>
                    </div>

                    <!-- 訂房狀態卡片 -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-icon"><span class="material-symbols-outlined">king_bed</span></div>
                        <div class="dashboard-card-title">訂房狀態</div>
                        <div class="dashboard-card-subtitle">所有訂單狀態統計</div>
                        <div class="dashboard-card-metrics">
                            <div class="dashboard-metric">
                                <div class="dashboard-metric-label">有效</div>
                                <div class="dashboard-metric-value" id="activeBookings">0</div>
                            </div>
                            <div class="dashboard-metric">
                                <div class="dashboard-metric-label">保留</div>
                                <div class="dashboard-metric-value" id="reservedBookings">0</div>
                            </div>
                            <div class="dashboard-metric">
                                <div class="dashboard-metric-label">取消</div>
                                <div class="dashboard-metric-value" id="cancelledBookings">0</div>
                            </div>
                        </div>
                        <button class="dashboard-card-button" onclick="switchSection('bookings')">前往訂單列表</button>
                    </div>
                </div>
            </section>

            <!-- 訂房記錄區 -->
            <section id="bookings-section" class="content-section active">
                <div class="section-header">
                    <h2><span class="material-symbols-outlined" style="font-size: 28px; vertical-align: middle; margin-right: 8px;">event_note</span> 訂房記錄管理</h2>
                    <div class="header-actions">
                        <button class="btn-refresh" onclick="reloadCurrentBookingView()">
                            <span class="material-symbols-outlined">refresh</span> 重新整理
                        </button>
                    </div>
                </div>

                <!-- 視圖切換標籤 -->
                <div class="view-tabs" style="margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
                    <button class="view-tab active" data-view="list" onclick="switchBookingView('list')">
                        <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle; margin-right: 5px;">list</span> 列表
                    </button>
                    <button class="view-tab" data-view="calendar" onclick="switchBookingView('calendar')">
                        <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle; margin-right: 5px;">calendar_month</span> 日曆
                    </button>
                </div>

                <!-- 列表視圖 -->
                <div id="bookingListView" class="booking-view">
                <!-- 搜尋和篩選 -->
                <div class="filter-bar" id="bookingListFilters">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="搜尋訂房編號、姓名、Email..." onkeyup="filterBookings()">
                        <span class="search-icon"><span class="material-symbols-outlined" style="font-size: 20px; vertical-align: middle;">search</span></span>
                    </div>
                    <div class="filter-group">
                        <select id="roomTypeFilter" onchange="filterBookings()">
                            <option value="">所有房型</option>
                            <option value="標準雙人房">標準雙人房</option>
                            <option value="豪華雙人房">豪華雙人房</option>
                            <option value="尊爵套房">尊爵套房</option>
                            <option value="家庭四人房">家庭四人房</option>
                        </select>
                        <select id="statusFilter" onchange="filterBookings()">
                            <option value="">所有付款狀態</option>
                            <option value="paid">已付款</option>
                            <option value="pending">待付款</option>
                            <option value="failed">付款失敗</option>
                            <option value="refunded">已退款</option>
                        </select>
                        <input
                            type="date"
                            id="checkInDateFilter"
                            onchange="filterBookings()"
                            style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                        >
                    </div>
                </div>

                <!-- 訂房記錄表格 -->
                <div class="table-container">
                    <table class="bookings-table">
                        <thead>
                            <tr>
                                <th>訂房編號</th>
                                <th>客戶姓名</th>
                                <th>房型</th>
                                <th>人數</th>
                                <th onclick="sortByCheckInDate()" style="cursor: pointer; user-select: none;">
                                    入住日期 
                                    <span id="checkInDateSortIcon" style="font-size: 12px; color: #667eea;">⇅</span>
                                </th>
                                <th>住宿天數</th>
                                <th>應付金額</th>
                                <th>付款方式</th>
                                <th>付款狀態</th>
                                <th>訂房狀態</th>
                                <th>郵件狀態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTableBody">
                            <tr>
                                <td colspan="12" class="loading">載入中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分頁 -->
                <div class="pagination" id="pagination"></div>
                </div>

                <!-- 日曆視圖 -->
                <div id="bookingCalendarView" class="booking-view" style="display: none;">
                    <div class="calendar-controls" style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                        <button class="btn-primary" onclick="changeCalendarMonth(-1)">
                            <span class="material-symbols-outlined">chevron_left</span> 上一週
                        </button>
                        <h3 id="calendarMonthTitle" style="margin: 0; font-size: 20px; font-weight: 600;"></h3>
                        <button class="btn-primary" onclick="changeCalendarMonth(1)">
                            下一週 <span class="material-symbols-outlined">chevron_right</span>
                        </button>
                    </div>
                    <div id="bookingCalendarContainer" class="calendar-container">
                        <div class="loading">載入日曆中...</div>
                    </div>
                    <!-- 日曆使用提示（右下角） -->
                    <div style="margin-top: 8px; font-size: 13px; color: #666; display: flex; justify-content: flex-end; align-items: center; gap: 6px;">
                        <span class="material-symbols-outlined" style="font-size: 18px; color: #2C8EC4;">info</span>
                        <span>提示：<strong>點選空白格可以快速新增訂房</strong>，點選已有訂單可以查看詳情。</span>
                    </div>
                </div>
            </section>

            <!-- 客戶管理區 -->
            <section id="customers-section" class="content-section">
                <div class="section-header">
                    <h2><span class="material-symbols-outlined" style="font-size: 28px; vertical-align: middle; margin-right: 8px;">people</span> 客戶管理</h2>
                    <div class="header-actions">
                        <button class="btn-refresh" onclick="loadCustomers()">
                            <span class="material-symbols-outlined">refresh</span> 重新整理
                        </button>
                    </div>
                </div>

                <!-- 搜尋和篩選 -->
                <div class="filter-bar">
                    <div class="search-box">
                        <input type="text" id="customerSearchInput" placeholder="搜尋客戶姓名、電話、Email..." onkeyup="filterCustomers()">
                        <span class="search-icon"><span class="material-symbols-outlined" style="font-size: 20px; vertical-align: middle;">search</span></span>
                    </div>
                </div>

                <!-- 客戶列表表格 -->
                <div class="table-container">
                    <table class="bookings-table">
                        <thead>
                            <tr>
                                <th style="text-align: left;">客戶姓名</th>
                                <th style="text-align: left;">電話</th>
                                <th style="text-align: left;">Email</th>
                                <th style="text-align: center;">訂房次數</th>
                                <th style="text-align: right;">總消費金額</th>
                                <th style="text-align: left;">最後訂房日期</th>
                                <th style="text-align: center;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody">
                            <tr>
                                <td colspan="7" class="loading">載入中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 統計資料區 -->
            <section id="statistics-section" class="content-section">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">
                    <h2 style="display: flex; align-items: center; gap: 8px; margin: 0;">
                        <span class="material-symbols-outlined" style="font-size: 28px;">monitoring</span>
                        <span>統計資料</span>
                    </h2>
                    <div class="header-actions" style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <div class="date-range-filter" style="display: flex; align-items: center; gap: 6px;">
                            <label for="statsStartDate" style="font-size: 13px; color: #666;">期間</label>
                            <input type="date" id="statsStartDate" style="padding: 4px 8px; font-size: 13px;">
                            <span>~</span>
                            <input type="date" id="statsEndDate" style="padding: 4px 8px; font-size: 13px;">
                        </div>
                        <button class="btn-secondary" onclick="applyStatisticsFilter()">套用</button>
                        <button class="btn-refresh" onclick="resetStatisticsFilter()">
                            <span class="material-symbols-outlined">refresh</span> 全部期間
                        </button>
                    </div>
                </div>

                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-symbols-outlined">event_note</span></div>
                        <div class="stat-value" id="totalBookings">-</div>
                        <div class="stat-label">總訂房數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-symbols-outlined">money_bag</span></div>
                        <div class="stat-value" id="totalRevenue">-</div>
                        <div class="stat-label">總營收</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-symbols-outlined">event</span></div>
                        <div class="stat-value" id="recentBookings">-</div>
                        <div class="stat-label" id="recentBookingsLabel">期間內訂房數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><span class="material-symbols-outlined">mail</span></div>
                        <div class="stat-value" id="emailSent">-</div>
                        <div class="stat-label">郵件已發送</div>
                    </div>
                </div>

                <!-- 房型統計 -->
                <div class="room-stats">
                    <h3>房型統計</h3>
                    <div class="room-stats-list" id="roomStatsList">
                        <div class="loading">載入中...</div>
                    </div>
                </div>
            </section>

            <!-- 房型管理區（包含假日管理分頁） -->
            <section id="room-types-section" class="content-section">
                <div class="section-header">
                    <h2><span class="material-symbols-outlined" style="font-size: 28px; vertical-align: middle; margin-right: 8px;">king_bed</span> 房型管理</h2>
                    <div class="header-actions">
                        <button class="btn-primary" id="addRoomTypeBtn" onclick="showAddRoomTypeModal()" style="display: none;">
                            <span class="material-symbols-outlined">add</span> 新增房型
                        </button>
                        <button class="btn-refresh" id="roomTypeRefreshBtn" onclick="loadRoomTypes()" style="display: none;">
                            <span class="material-symbols-outlined">refresh</span> 重新整理
                        </button>
                        <button class="btn-refresh" id="holidayRefreshBtn" onclick="loadHolidays()" style="display: none;">
                            <span class="material-symbols-outlined">refresh</span> 重新整理
                        </button>
                    </div>
                </div>

                <!-- 分頁切換 -->
                <div class="tab-container" style="margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
                    <button class="tab-button active" onclick="switchRoomTypeTab('room-types')" id="roomTypesTab">
                        <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle; margin-right: 5px;">king_bed</span>
                        房型管理
                    </button>
                    <button class="tab-button" onclick="switchRoomTypeTab('holidays')" id="holidaysTab">
                        <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle; margin-right: 5px;">event</span>
                        假日管理
                    </button>
                </div>

                <!-- 房型管理內容 -->
                <div id="roomTypesTabContent" class="tab-content">
                    <div class="room-types-container">
                    <table class="bookings-table">
                        <thead>
                            <tr>
                                <th>排序</th>
                                <th>圖示</th>
                                <th>房型代碼</th>
                                <th>房型名稱</th>
                                <th>入住人數</th>
                                <th>加床人數</th>
                                <th>平日價格/晚</th>
                                <th>假日加價/晚</th>
                                <th>狀態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="roomTypesTableBody">
                            <tr>
                                <td colspan="10" class="loading">載入中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                </div>

                <!-- 假日管理內容 -->
                <div id="holidaysTabContent" class="tab-content" style="display: none;">
                    <!-- 平日/假日設定 -->
                    <div class="settings-card" style="margin-bottom: 20px;">
                        <h3>平日/假日設定</h3>
                        <div class="form-group">
                            <label>選擇假日（勾選的日期將視為假日，未勾選的日期為平日）</label>
                            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 10px;">
                                <label style="display: flex; flex-direction: column; align-items: center; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                    <input type="checkbox" id="weekdaySun" value="0" style="width: 20px; height: 20px; margin-bottom: 5px;" onchange="updateWeekdaySettings()">
                                    <span style="font-weight: 600;">週日</span>
                                </label>
                                <label style="display: flex; flex-direction: column; align-items: center; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                    <input type="checkbox" id="weekdayMon" value="1" style="width: 20px; height: 20px; margin-bottom: 5px;" onchange="updateWeekdaySettings()">
                                    <span style="font-weight: 600;">週一</span>
                                </label>
                                <label style="display: flex; flex-direction: column; align-items: center; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                    <input type="checkbox" id="weekdayTue" value="2" style="width: 20px; height: 20px; margin-bottom: 5px;" onchange="updateWeekdaySettings()">
                                    <span style="font-weight: 600;">週二</span>
                                </label>
                                <label style="display: flex; flex-direction: column; align-items: center; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                    <input type="checkbox" id="weekdayWed" value="3" style="width: 20px; height: 20px; margin-bottom: 5px;" onchange="updateWeekdaySettings()">
                                    <span style="font-weight: 600;">週三</span>
                                </label>
                                <label style="display: flex; flex-direction: column; align-items: center; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                    <input type="checkbox" id="weekdayThu" value="4" style="width: 20px; height: 20px; margin-bottom: 5px;" onchange="updateWeekdaySettings()">
                                    <span style="font-weight: 600;">週四</span>
                                </label>
                                <label style="display: flex; flex-direction: column; align-items: center; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                    <input type="checkbox" id="weekdayFri" value="5" style="width: 20px; height: 20px; margin-bottom: 5px;" onchange="updateWeekdaySettings()">
                                    <span style="font-weight: 600;">週五</span>
                                </label>
                                <label style="display: flex; flex-direction: column; align-items: center; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                    <input type="checkbox" id="weekdaySat" value="6" style="width: 20px; height: 20px; margin-bottom: 5px;" onchange="updateWeekdaySettings()">
                                    <span style="font-weight: 600;">週六</span>
                                </label>
                            </div>
                            <small style="display: block; margin-top: 10px; color: #666;">
                                💡 提示：勾選的日期將使用「假日價格（平日價格 + 假日加價）」，未勾選的日期將使用「平日價格」。<br>
                                例如：勾選週六、週日，則週一到週五為平日；或勾選週五到週日，則週一到週四為平日。
                            </small>
                        </div>
                        <button class="btn-save" onclick="saveWeekdaySettings()" style="margin-top: 15px;">儲存平日/假日設定</button>
                    </div>

                    <!-- 假日管理內容 -->
                    <div class="settings-container">
                        <div class="settings-card">
                            <h3>新增單一假日</h3>
                            <div class="form-group">
                                <label>日期</label>
                                <input type="date" id="holidayDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div class="form-group">
                                <label>假日名稱（選填）</label>
                                <input type="text" id="holidayName" placeholder="例如：元旦" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <button type="button" class="btn-save" onclick="addHoliday()">新增</button>
                        </div>
                        
                        <div class="settings-card" style="margin-top: 20px;">
                            <h3>新增連續假期</h3>
                            <div class="form-group">
                                <label>開始日期</label>
                                <input type="date" id="holidayStartDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div class="form-group">
                                <label>結束日期</label>
                                <input type="date" id="holidayEndDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div class="form-group">
                                <label>假日名稱（選填）</label>
                                <input type="text" id="holidayRangeName" placeholder="例如：春節連假" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <button type="button" class="btn-save" onclick="addHolidayRange()">新增</button>
                        </div>
                        
                        <div class="settings-card" style="margin-top: 20px;">
                            <h3>假日列表</h3>
                            <div id="holidaysList" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: #f9f9f9;">
                                <div class="loading">載入中...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 加購商品管理區 -->
            <section id="addons-section" class="content-section">
                <div class="section-header">
                    <h2><span class="material-symbols-outlined" style="font-size: 28px; vertical-align: middle; margin-right: 8px;">add_shopping_cart</span> 加購商品管理</h2>
                    <div class="header-actions">
                        <button class="btn-primary" onclick="showAddAddonModal()">
                            <span class="material-symbols-outlined">add</span> 新增加購商品
                        </button>
                        <button class="btn-refresh" onclick="loadAddons()">
                            <span class="material-symbols-outlined">refresh</span> 重新整理
                        </button>
                    </div>
                </div>

                <!-- 前台啟用開關 -->
                <div class="settings-card" style="margin-bottom: 20px;">
                    <h3>前台啟用設定</h3>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="enableAddonsFrontend" style="width: 20px; height: 20px;" onchange="toggleAddonsFrontend(this.checked)">
                            <span>啟用前台加購商品功能</span>
                        </label>
                        <small>關閉後，前台將不顯示加購商品選項，也不計算加購商品價格</small>
                    </div>
                </div>

                <div class="room-types-container">
                    <table class="bookings-table">
                        <thead>
                            <tr>
                                <th>排序</th>
                                <th>圖示</th>
                                <th>商品代碼</th>
                                <th>商品名稱</th>
                                <th>價格</th>
                                <th>狀態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="addonsTableBody">
                            <tr>
                                <td colspan="7" class="loading">載入中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>


            <!-- 系統設定區 -->
            <section id="settings-section" class="content-section">
                <div class="section-header">
                    <h2><span class="material-symbols-outlined" style="font-size: 28px; vertical-align: middle; margin-right: 8px;">settings</span> 系統設定</h2>
                    <button class="btn-refresh" onclick="loadSettings()">
                        <span class="material-symbols-outlined">refresh</span> 重新整理
                    </button>
                </div>

                <div class="settings-container">
                    <div class="settings-card">
                        <h3>付款方式設定</h3>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="enableTransfer" style="width: 20px; height: 20px;">
                                <span>啟用匯款轉帳</span>
                            </label>
                            <small>勾選後，客戶在前台可以選擇匯款轉帳付款</small>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="enableCard" style="width: 20px; height: 20px;">
                                <span>啟用線上刷卡</span>
                            </label>
                            <small>勾選後，客戶在前台可以選擇線上刷卡付款（需填寫綠界串接碼）</small>
                        </div>
                    </div>
                    
                    <div class="settings-card" style="margin-top: 20px;">
                        <h3>付款設定</h3>
                        <div class="form-group">
                            <label>訂金百分比</label>
                            <div class="input-group">
                                <input type="number" id="depositPercentage" min="0" max="100" step="1" placeholder="30">
                                <span class="input-suffix">%</span>
                            </div>
                            <small>設定訂金佔總金額的百分比（例如：30 表示 30%）</small>
                        </div>
                        <button class="btn-save" onclick="savePaymentSettings()">儲存設定</button>
                    </div>
                    
                    <!-- 匯款帳號設定區塊 -->
                    <div style="margin-top: 40px; padding-top: 30px; border-top: 1px solid #e0e0e0;">
                        <div style="display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #3498db;">
                            <span class="material-symbols-outlined" style="font-size: 24px; color: #3498db; margin-right: 10px;">account_balance</span>
                            <h3 style="margin: 0; color: #2c3e50;">匯款帳號設定</h3>
                        </div>
                        
                        <div class="settings-card" style="margin-top: 0;">
                            <div class="form-group">
                                <label>銀行名稱</label>
                                <input type="text" id="bankName" placeholder="例如：XXX銀行">
                                <small>銀行全名</small>
                            </div>
                            <div class="form-group">
                                <label>分行名稱</label>
                                <input type="text" id="bankBranch" placeholder="例如：XXX分行">
                                <small>分行全名</small>
                            </div>
                            <div class="form-group">
                                <label>帳號</label>
                                <input type="text" id="bankAccount" placeholder="例如：1234567890123">
                                <small>匯款帳號</small>
                            </div>
                            <div class="form-group">
                                <label>戶名</label>
                                <input type="text" id="accountName" placeholder="例如：XXX">
                                <small>帳戶戶名</small>
                            </div>
                            <button class="btn-save" onclick="saveRemittanceAccountSettings()">儲存設定</button>
                        </div>
                    </div>
                    
                    <!-- 綠界支付設定區塊 -->
                    <div style="margin-top: 40px; padding-top: 30px; border-top: 1px solid #e0e0e0;">
                        <div style="display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #3498db;">
                            <span class="material-symbols-outlined" style="font-size: 24px; color: #3498db; margin-right: 10px;">credit_card</span>
                            <h3 style="margin: 0; color: #2c3e50;">綠界支付設定</h3>
                        </div>
                        
                        <div class="settings-card" style="margin-top: 0;">
                            <div class="form-group">
                                <label>MerchantID（商店代號）</label>
                                <input type="text" id="ecpayMerchantID" placeholder="例如：2000132">
                                <small>綠界提供的商店代號</small>
                            </div>
                            <div class="form-group">
                                <label>HashKey（金鑰）</label>
                                <input type="text" id="ecpayHashKey" placeholder="例如：5294y06JbISpM5x9">
                                <small>綠界提供的 HashKey</small>
                            </div>
                            <div class="form-group">
                                <label>HashIV（向量）</label>
                                <input type="text" id="ecpayHashIV" placeholder="例如：v77hoKGq4kWxNNIS">
                                <small>綠界提供的 HashIV</small>
                            </div>
                            <button class="btn-save" onclick="saveEcpaySettings()">儲存設定</button>
                        </div>
                    </div>
                    
                    <!-- 旅館資訊區塊 -->
                    <div style="margin-top: 40px; padding-top: 30px; border-top: 1px solid #e0e0e0;">
                        <div style="display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #3498db;">
                            <span class="material-symbols-outlined" style="font-size: 24px; color: #3498db; margin-right: 10px;">hotel</span>
                            <h3 style="margin: 0; color: #2c3e50;">旅館資訊</h3>
                        </div>
                        
                        <div class="settings-card" style="margin-top: 0;">
                        <div class="form-group">
                            <label>旅館名稱</label>
                            <input type="text" id="hotelName" placeholder="例如：XX旅館">
                            <small>旅館或民宿的名稱</small>
                        </div>
                        <div class="form-group">
                            <label>旅館電話</label>
                            <input type="text" id="hotelPhone" placeholder="例如：02-1234-5678">
                            <small>聯絡電話</small>
                        </div>
                        <div class="form-group">
                            <label>旅館地址</label>
                            <input type="text" id="hotelAddress" placeholder="例如：台北市信義區信義路五段7號">
                            <small>完整地址</small>
                        </div>
                        <div class="form-group">
                            <label>旅館信箱</label>
                            <input type="email" id="hotelEmail" placeholder="例如：service@hotel.com">
                            <small>聯絡信箱</small>
                        </div>
                        <button class="btn-save" onclick="saveHotelInfoSettings()">儲存設定</button>
                        </div>
                    </div>
                    
                    <!-- 帳號安全設定區塊 -->
                    <div style="margin-top: 40px; padding-top: 30px; border-top: 1px solid #e0e0e0;">
                        <div style="display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #3498db;">
                            <span class="material-symbols-outlined" style="font-size: 24px; color: #3498db; margin-right: 10px;">lock</span>
                            <h3 style="margin: 0; color: #2c3e50;">帳號安全設定</h3>
                        </div>
                        
                        <div class="settings-card" style="margin-top: 0;">
                            <h3>修改管理員密碼</h3>
                        <div class="form-group">
                            <label>目前密碼</label>
                            <input type="password" id="currentPassword" placeholder="請輸入目前密碼" autocomplete="current-password">
                            <small>請輸入您目前的密碼以驗證身份</small>
                        </div>
                        <div class="form-group">
                            <label>新密碼</label>
                            <input type="password" id="newPassword" placeholder="請輸入新密碼" autocomplete="new-password">
                            <small>建議使用至少 8 個字元，包含大小寫字母、數字和符號</small>
                        </div>
                        <div class="form-group">
                            <label>確認新密碼</label>
                            <input type="password" id="confirmPassword" placeholder="請再次輸入新密碼" autocomplete="new-password">
                            <small>請再次輸入新密碼以確認</small>
                        </div>
                        <button class="btn-save" onclick="changePassword()">修改密碼</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 郵件模板區 -->
            <section id="email-templates-section" class="content-section">
                <div class="section-header">
                    <h2><span class="material-symbols-outlined" style="font-size: 28px; vertical-align: middle; margin-right: 8px;">mail</span> 郵件模板管理</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-secondary" onclick="resetEmailTemplatesToDefault()" style="display: flex; align-items: center; gap: 5px;">
                            <span class="material-symbols-outlined" style="font-size: 18px;">restart_alt</span>
                            重置為圖卡樣式
                        </button>
                        <button class="btn-refresh" onclick="loadEmailTemplates()">
                            <span class="material-symbols-outlined">refresh</span> 重新整理
                        </button>
                    </div>
                </div>

                <div class="email-templates-container">
                    <div class="templates-list" id="emailTemplatesList">
                        <div class="loading">載入中...</div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- 訂房詳情模態框 -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>訂房詳情</h3>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 詳情內容將動態載入 -->
            </div>
        </div>
    </div>

    <!-- 郵件模板編輯模態框 -->
    <div id="emailTemplateModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="emailTemplateModalTitle">編輯郵件模板</h2>
                <button class="modal-close" onclick="closeEmailTemplateModal()">&times;</button>
            </div>
            <form id="emailTemplateForm" onsubmit="saveEmailTemplate(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label>模板名稱</label>
                        <input type="text" id="emailTemplateName" required>
                    </div>
                    <div class="form-group">
                        <label>郵件主旨</label>
                        <input type="text" id="emailTemplateSubject" required>
                    </div>
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <label style="margin: 0;">郵件內容</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button type="button" id="toggleEditorModeBtn" class="btn-secondary" style="padding: 5px 15px; font-size: 12px;">
                                    <span id="editorModeText">切換到 HTML 模式</span>
                                </button>
                                <div class="variable-buttons" style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    <button type="button" class="btn-var" onclick="insertVariable('{{guestName}}')" title="插入客戶姓名">姓名</button>
                                    <button type="button" class="btn-var" onclick="insertVariable('{{bookingId}}')" title="插入訂房編號">訂房編號</button>
                                    <button type="button" class="btn-var" onclick="insertVariable('{{checkInDate}}')" title="插入入住日期">入住日期</button>
                                    <button type="button" class="btn-var" onclick="insertVariable('{{checkOutDate}}')" title="插入退房日期">退房日期</button>
                                    <button type="button" class="btn-var" onclick="insertVariable('{{roomType}}')" title="插入房型">房型</button>
                                    <button type="button" class="btn-var" onclick="insertVariable('{{finalAmount}}')" title="插入應付金額">應付金額</button>
                                </div>
                            </div>
                        </div>
                        <!-- 富文本編輯器容器 -->
                        <div id="emailTemplateEditor" style="height: 400px; background: white; border: 1px solid #ddd; border-radius: 4px;"></div>
                        <!-- HTML 原始碼編輯器（隱藏） -->
                        <textarea id="emailTemplateContent" rows="20" required style="display: none; font-family: monospace; font-size: 12px; width: 100%;"></textarea>
                        <small style="margin-top: 10px; display: block; color: #666;">
                            💡 提示：使用上方按鈕插入變數，或直接點擊「姓名」、「訂房編號」等按鈕快速插入。點擊「切換到 HTML 模式」可查看/編輯原始 HTML 代碼。
                        </small>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="emailTemplateEnabled" style="width: 20px; height: 20px;">
                            <span>啟用此模板</span>
                        </label>
                    </div>
                    
                    <!-- 入住提醒設定 -->
                    <div id="checkinReminderSettings" class="form-group" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 15px;">
                        <h3 style="margin-top: 0; font-size: 16px; color: #333;">發送時間設定</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label>入住前幾天發送</label>
                                <input type="number" id="daysBeforeCheckin" min="0" max="30" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label>發送時間（24小時制）</label>
                                <input type="number" id="sendHourCheckin" min="0" max="23" value="9" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 感謝入住設定 -->
                    <div id="feedbackRequestSettings" class="form-group" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 15px;">
                        <h3 style="margin-top: 0; font-size: 16px; color: #333;">發送時間設定</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label>退房後幾天發送</label>
                                <input type="number" id="daysAfterCheckout" min="0" max="30" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label>發送時間（24小時制）</label>
                                <input type="number" id="sendHourFeedback" min="0" max="23" value="10" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 匯款提醒設定 -->
                    <div id="paymentReminderSettings" class="form-group" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 15px;">
                        <h3 style="margin-top: 0; font-size: 16px; color: #333;">發送時間設定</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label>訂房後幾天發送（保留天數）</label>
                                <input type="number" id="daysReserved" min="1" max="30" value="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <small style="color: #666; display: block; margin-top: 5px;">超過此天數未付款，訂房狀態將自動改為「已取消」</small>
                            </div>
                            <div>
                                <label>發送時間（24小時制）</label>
                                <input type="number" id="sendHourPaymentReminder" min="0" max="23" value="9" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 測試郵件功能 -->
                    <div class="form-group" style="background: #f0f8ff; padding: 15px; border-radius: 5px; margin-top: 20px; border: 1px solid #2C8EC4;">
                        <h3 style="margin-top: 0; font-size: 16px; color: #333; display: flex; align-items: center; gap: 8px;">
                            <span class="material-symbols-outlined" style="font-size: 20px;">mail</span>
                            測試郵件
                        </h3>
                        <p style="color: #666; font-size: 13px; margin: 8px 0 12px 0;">輸入 Email 地址以發送測試郵件，查看郵件實際效果</p>
                        <div style="display: flex; gap: 10px; align-items: flex-end;">
                            <div style="flex: 1;">
                                <label style="font-size: 13px; color: #666; margin-bottom: 5px; display: block;">Email 地址</label>
                                <input type="email" id="testEmailAddress" placeholder="example@email.com" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            </div>
                            <button type="button" id="sendTestEmailBtn" class="btn-primary" style="padding: 8px 20px; white-space: nowrap;" onclick="sendTestEmail()">
                                <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle; margin-right: 4px;">send</span>
                                發送測試郵件
                            </button>
                        </div>
                        <div id="testEmailStatus" style="margin-top: 10px; font-size: 13px; display: none;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn-primary">儲存</button>
                    <button type="button" class="btn-primary btn-danger" onclick="closeEmailTemplateModal()">取消</button>
                </div>
            </form>
        </div>
    </div>

    <script src="admin.js?v=20241212"></script>
</body>
</html>

