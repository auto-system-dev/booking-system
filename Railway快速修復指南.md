# Railway 快速修復指南

## 🔴 當前問題

從日誌看到：
```
⚠️  警告: 正式環境仍在使用測試環境的 MerchantID !
請設定 ECPAY_MERCHANT_ID_PROD 環境變數或在資料庫中設定 ecpay_merchant_id_prod
```

**原因：**
- Railway 上設定了 `NODE_ENV=production`
- 但沒有設定正式環境的綠界支付參數
- 系統回退到使用測試環境的 MerchantID（2000132）

---

## ✅ 解決方案（二選一）

### 方案 A：在 Railway 使用測試參數（推薦，如果還沒有正式帳號）

**適用情況：**
- 還在開發/測試階段
- 還沒有申請綠界正式商店帳號
- 想要測試支付功能

**步驟：**

1. 在 Railway 後台，點擊 `booking-system` 服務
2. 進入 **Variables** 標籤
3. **刪除或修改 `NODE_ENV`**：
   - 刪除 `NODE_ENV`（如果存在）
   - 或修改為：`NODE_ENV=development`
4. 儲存後，Railway 會自動重新部署

**結果：**
- ✅ 系統會使用測試環境設定
- ✅ 不會再出現警告
- ✅ 可以使用測試參數（2000132）
- ✅ 不會真的扣款

**部署後日誌應該顯示：**
```
🌍 當前環境: 測試環境 (Test)
🧪 使用測試環境設定
📋 綠界設定:
- MerchantID: 2000****
```

---

### 方案 B：設定正式環境參數（如果已經有正式帳號）

**適用情況：**
- 已經申請綠界正式商店帳號
- 準備正式上線
- 需要真的收款

**步驟：**

1. 在 Railway 後台，點擊 `booking-system` 服務
2. 進入 **Variables** 標籤
3. 確認 `NODE_ENV=production` 已設定
4. 新增以下環境變數：
   ```
   ECPAY_MERCHANT_ID_PROD=您的正式商店代號
   ECPAY_HASH_KEY_PROD=您的正式HashKey
   ECPAY_HASH_IV_PROD=您的正式HashIV
   ```
5. 儲存後，Railway 會自動重新部署

**結果：**
- ✅ 系統會使用正式環境設定
- ✅ 不會再出現警告
- ✅ 可以真的收款

**部署後日誌應該顯示：**
```
🌍 當前環境: 正式環境 (Production)
💰 使用正式環境設定
📋 綠界設定:
- MerchantID: [您的正式商店代號]
```

---

## 🔍 如何確認修復成功

部署完成後，檢查伺服器日誌：

### 方案 A（測試環境）應該看到：
```
🌍 當前環境: 測試環境 (Test)
🧪 使用測試環境設定
📋 綠界設定:
- MerchantID: 2000****
- HashKey: 已設定
- HashIV: 已設定
```
**沒有紅色警告**

### 方案 B（正式環境）應該看到：
```
🌍 當前環境: 正式環境 (Production)
💰 使用正式環境設定
📋 綠界設定:
- MerchantID: [您的正式商店代號]
- HashKey: 已設定
- HashIV: 已設定
```
**沒有紅色警告**

---

## 📋 快速檢查清單

### 如果選擇方案 A（測試環境）：
- [ ] 刪除或修改 `NODE_ENV`（改為 `development` 或刪除）
- [ ] 重新部署
- [ ] 檢查日誌確認顯示 "測試環境"
- [ ] 確認沒有紅色警告

### 如果選擇方案 B（正式環境）：
- [ ] 確認 `NODE_ENV=production` 已設定
- [ ] 設定 `ECPAY_MERCHANT_ID_PROD`
- [ ] 設定 `ECPAY_HASH_KEY_PROD`
- [ ] 設定 `ECPAY_HASH_IV_PROD`
- [ ] 重新部署
- [ ] 檢查日誌確認顯示 "正式環境"
- [ ] 確認沒有紅色警告

---

## 💡 建議

**如果您還沒有正式商店帳號：**
- 建議使用**方案 A**（測試環境）
- 可以正常測試所有功能
- 不會真的扣款
- 等準備好再申請正式帳號

**如果您已經有正式商店帳號：**
- 使用**方案 B**（正式環境）
- 設定正式環境參數
- 可以真的收款

---

## 🆘 如果還有問題

1. **檢查環境變數**：確認 Railway 上的環境變數是否正確設定
2. **查看日誌**：檢查部署後的日誌確認環境判斷是否正確
3. **重新部署**：修改環境變數後，Railway 會自動重新部署，等待部署完成

