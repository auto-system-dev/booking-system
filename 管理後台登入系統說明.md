# 管理後台登入系統使用說明

## ✅ 已實作功能

### 1. 資料庫層面
- ✅ 管理員資料表（`admins`）
- ✅ 密碼加密（bcrypt）
- ✅ 預設管理員自動建立

### 2. 後端 API
- ✅ Session 管理（express-session）
- ✅ 登入 API（`POST /api/admin/login`）
- ✅ 登出 API（`POST /api/admin/logout`）
- ✅ 檢查登入狀態 API（`GET /api/admin/check-auth`）
- ✅ 登入驗證中間件（保護所有管理後台路由）

### 3. 前端介面
- ✅ 登入頁面（美觀的漸層背景）
- ✅ 登入表單（帳號/密碼）
- ✅ 錯誤訊息顯示
- ✅ 登出按鈕（側邊欄底部）
- ✅ 自動檢查登入狀態

---

## 🔐 預設管理員帳號

系統啟動時會自動建立預設管理員：

- **帳號**：`admin`
- **密碼**：`admin123`（或環境變數 `ADMIN_DEFAULT_PASSWORD` 設定的值）

⚠️ **重要**：請在首次登入後立即修改密碼！

---

## 📝 使用方式

### 1. 首次使用

1. **啟動伺服器**
   ```bash
   npm start
   ```

2. **訪問管理後台**
   - 打開瀏覽器訪問：`http://localhost:3000/admin`
   - 系統會自動重導向到登入頁面

3. **登入**
   - 輸入帳號：`admin`
   - 輸入密碼：`admin123`
   - 點擊「登入」按鈕

4. **修改密碼**（建議）
   - 登入後，建議立即修改預設密碼
   - （修改密碼功能可後續實作）

### 2. 日常使用

- **登入**：訪問 `/admin`，輸入帳號密碼
- **登出**：點擊側邊欄底部的「登出」按鈕
- **Session 有效期**：24 小時（可在 `server.js` 中調整）

---

## 🔒 安全性說明

### 已實作的安全功能

1. **密碼加密**
   - 使用 bcrypt 加密（10 rounds）
   - 密碼不會以明文儲存

2. **Session 管理**
   - 使用 `express-session`
   - Session ID 儲存在 HTTP-only Cookie
   - 生產環境自動使用 Secure Cookie（HTTPS）

3. **路由保護**
   - 所有 `/admin` 路由需要登入
   - 所有 `/api/admin/*` API 需要登入
   - `/api/statistics` 和 `/api/customers` 也需要登入

4. **CORS 設定**
   - 已設定 `credentials: true`，允許跨域傳送 Cookie

### 建議加強（未來）

- [ ] 登入失敗次數限制（防止暴力破解）
- [ ] 密碼強度要求
- [ ] 雙因素認證（2FA）
- [ ] Session 過期自動登出
- [ ] 修改密碼功能

---

## 🛠️ 技術細節

### 資料庫結構

```sql
CREATE TABLE admins (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    email TEXT,
    role TEXT DEFAULT 'admin',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_login DATETIME,
    is_active INTEGER DEFAULT 1
);
```

### API 端點

| 端點 | 方法 | 說明 | 需要登入 |
|------|------|------|:--------:|
| `/admin/login` | GET | 登入頁面 | ❌ |
| `/api/admin/login` | POST | 登入 | ❌ |
| `/api/admin/logout` | POST | 登出 | ❌ |
| `/api/admin/check-auth` | GET | 檢查登入狀態 | ❌ |
| `/admin` | GET | 管理後台主頁 | ✅ |
| `/api/admin/*` | ALL | 所有管理 API | ✅ |

### Session 設定

```javascript
{
    secret: process.env.SESSION_SECRET || 'your-secret-key-change-this-in-production',
    resave: false,
    saveUninitialized: false,
    cookie: {
        secure: process.env.NODE_ENV === 'production', // 生產環境使用 HTTPS
        httpOnly: true,
        maxAge: 24 * 60 * 60 * 1000 // 24 小時
    }
}
```

---

## 🔧 環境變數設定

建議在 `.env` 檔案中設定：

```env
# Session 密鑰（生產環境必須修改）
SESSION_SECRET=your-very-secure-random-string-here

# 預設管理員密碼（首次啟動時使用）
ADMIN_DEFAULT_PASSWORD=admin123

# 管理員 Email（選填）
ADMIN_EMAIL=admin@example.com
```

---

## 🚨 注意事項

1. **生產環境必須修改**
   - `SESSION_SECRET`：必須設定為隨機字串
   - 預設管理員密碼：登入後立即修改

2. **HTTPS 要求**
   - 生產環境必須使用 HTTPS
   - Session Cookie 會自動設定為 Secure

3. **Session 儲存**
   - 目前使用記憶體儲存 Session
   - 伺服器重啟後 Session 會失效
   - 未來可改用 Redis 或資料庫儲存

---

## 📋 測試步驟

### 1. 測試登入功能

1. 訪問 `http://localhost:3000/admin`
2. 應該自動顯示登入頁面
3. 輸入正確帳號密碼 → 應該成功登入
4. 輸入錯誤帳號密碼 → 應該顯示錯誤訊息

### 2. 測試登出功能

1. 登入後，點擊「登出」按鈕
2. 應該返回登入頁面
3. 再次訪問 `/admin` → 應該顯示登入頁面

### 3. 測試 API 保護

1. 未登入狀態下，直接訪問 `/api/admin/room-types`
2. 應該返回 `401 Unauthorized`
3. 登入後，再次訪問 → 應該正常返回資料

---

## 🐛 常見問題

### Q: 登入後立即被登出？

**A:** 檢查：
1. Session Secret 是否設定正確
2. CORS 設定是否包含 `credentials: true`
3. 前端 fetch 是否包含 `credentials: 'include'`

### Q: 無法登入，一直顯示錯誤？

**A:** 檢查：
1. 資料庫是否正確建立 `admins` 表
2. 預設管理員是否已建立
3. 伺服器 Console 是否有錯誤訊息

### Q: 登入後無法訪問管理後台？

**A:** 檢查：
1. Session 是否正確建立（檢查 Network → Cookies）
2. `requireAuth` 中間件是否正確設定
3. 路由順序是否正確（登入相關路由要在保護路由之前）

---

## 🎯 下一步建議

1. **修改密碼功能**
   - 在管理後台加入「修改密碼」功能
   - 要求輸入舊密碼驗證

2. **多管理員管理**
   - 新增管理員功能
   - 管理員列表
   - 管理員權限分級

3. **操作日誌**
   - 記錄所有管理員操作
   - 登入/登出記錄
   - 敏感操作記錄

4. **Session 持久化**
   - 改用 Redis 或資料庫儲存 Session
   - 支援多伺服器部署

---

**系統已成功實作管理後台登入功能！請立即測試並修改預設密碼。**

