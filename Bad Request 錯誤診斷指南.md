# Bad Request (400) 錯誤診斷指南

## 📋 錯誤來源

系統中 Bad Request (400) 錯誤可能來自以下幾個地方：

### 1. 輸入清理中間件 (`sanitizeInput`)
**位置**：`server.js` 第 412-418 行

**觸發條件**：
- 檢測到 SQL Injection 攻擊嘗試
- 檢測到 XSS 攻擊嘗試
- 輸入清理過程中發生錯誤

**錯誤訊息範例**：
```json
{
  "success": false,
  "message": "檢測到 SQL Injection 攻擊嘗試（欄位: xxx）"
}
```
或
```json
{
  "success": false,
  "message": "檢測到 XSS 攻擊嘗試（欄位: xxx）"
}
```

### 2. 驗證中間件 (`validateBooking`)
**位置**：`server.js` 第 232-268 行

**觸發條件**：
- 缺少必填欄位：`checkInDate`, `checkOutDate`, `roomType`, `guestName`, `guestPhone`, `guestEmail`
- Email 格式不正確
- 手機號碼格式不正確（必須是 09 開頭，共 10 碼）
- 日期範圍不正確（入住日期不能早於今天，退房日期必須晚於入住日期）
- 大人或孩童人數超出範圍（1-20）

**錯誤訊息範例**：
```json
{
  "success": false,
  "message": "缺少必填欄位: guestEmail, guestPhone"
}
```
或
```json
{
  "success": false,
  "message": "Email 格式不正確"
}
```

### 3. 訂房 API 驗證
**位置**：`server.js` 第 684-729 行

**觸發條件**：
- 必填欄位缺失（第 684-685 行）
- 付款方式未啟用（第 720-729 行）

**錯誤訊息範例**：
```json
{
  "message": "請填寫所有必填欄位"
}
```
或
```json
{
  "message": "匯款轉帳功能目前未啟用，請選擇其他付款方式"
}
```

### 4. 其他 API 端點的驗證
系統中還有其他 30+ 個地方會返回 400 錯誤，包括：
- 管理員 API 驗證
- 設定更新驗證
- 房型管理驗證
- 加購商品驗證
- 等等...

## 🔍 診斷步驟

### 步驟 1：檢查伺服器日誌
查看伺服器控制台輸出，尋找以下訊息：
- `輸入清理錯誤:` - 表示輸入清理失敗
- `驗證錯誤:` - 表示驗證中間件失敗
- `請填寫所有必填欄位` - 表示必填欄位缺失

### 步驟 2：檢查請求資料
確認發送的請求包含：
- ✅ 所有必填欄位
- ✅ 正確的資料格式
- ✅ 符合驗證規則的值

### 步驟 3：檢查常見問題

#### 問題 1：SQL Injection 誤判
**原因**：輸入中包含 SQL 關鍵字（如 "SELECT", "INSERT" 等）

**解決方案**：
- 檢查輸入內容是否包含 SQL 關鍵字
- 如果是正常業務資料（如產品名稱包含 "SELECT"），需要調整驗證規則

**範例**：
```
輸入：guestName = "SELECT 房型"
結果：被誤判為 SQL Injection 攻擊
```

#### 問題 2：XSS 誤判
**原因**：輸入中包含 HTML 標籤或 JavaScript 代碼

**解決方案**：
- 檢查輸入內容是否包含 `<script>`, `<iframe>` 等標籤
- 如果是正常業務資料，需要調整驗證規則

#### 問題 3：Email 格式錯誤
**原因**：Email 不符合標準格式

**驗證規則**：
- 必須包含 `@` 符號
- 必須包含域名
- 長度不能超過 255 字元

**範例**：
```
錯誤：user@example（缺少域名）
正確：user@example.com
```

#### 問題 4：手機號碼格式錯誤
**原因**：手機號碼不符合台灣格式

**驗證規則**：
- 必須以 `09` 開頭
- 必須是 10 碼數字
- 可以包含 `-` 或空格，但會被自動移除

**範例**：
```
錯誤：0912-345-678（11 碼）
錯誤：0812-345-678（不是 09 開頭）
正確：0912-345-678（10 碼，09 開頭）
```

#### 問題 5：日期格式或範圍錯誤
**原因**：日期不符合格式或邏輯

**驗證規則**：
- 格式必須是 `YYYY-MM-DD`
- 入住日期不能早於今天
- 退房日期必須晚於入住日期
- 最多只能預訂 365 天

**範例**：
```
錯誤：2024-01-01（如果今天是 2024-12-01）
錯誤：2024-12-05（退房日期早於入住日期）
正確：2024-12-02 到 2024-12-05
```

#### 問題 6：付款方式未啟用
**原因**：選擇的付款方式在系統設定中未啟用

**解決方案**：
- 檢查系統設定中的 `enable_transfer` 和 `enable_card` 設定
- 確認付款方式已啟用

## 🛠️ 除錯技巧

### 1. 啟用詳細日誌
在 `server.js` 中，訂房 API 已經有詳細的請求日誌（第 657-661 行）：
```javascript
console.log('\n========================================');
console.log('📥 收到訂房請求');
console.log('時間:', new Date().toLocaleString('zh-TW'));
console.log('請求資料:', JSON.stringify(req.body, null, 2));
console.log('========================================\n');
```

### 2. 檢查瀏覽器開發者工具
- 打開 Network 標籤
- 找到失敗的請求
- 查看 Request Payload 和 Response
- 確認錯誤訊息

### 3. 測試特定欄位
逐一測試每個必填欄位，確認哪個欄位導致錯誤。

## 📝 常見錯誤訊息對照表

| 錯誤訊息 | 可能原因 | 解決方案 |
|---------|---------|---------|
| `請填寫所有必填欄位` | 缺少必填欄位 | 檢查所有必填欄位是否都有值 |
| `Email 格式不正確` | Email 格式錯誤 | 確認 Email 符合標準格式 |
| `手機號碼格式不正確` | 手機號碼格式錯誤 | 確認是 09 開頭，10 碼數字 |
| `日期格式不正確` | 日期格式錯誤 | 確認日期是 YYYY-MM-DD 格式 |
| `入住日期不能早於今天` | 日期邏輯錯誤 | 選擇今天或未來的日期 |
| `退房日期必須晚於入住日期` | 日期邏輯錯誤 | 確認退房日期晚於入住日期 |
| `檢測到 SQL Injection 攻擊嘗試` | 輸入包含 SQL 關鍵字 | 檢查輸入內容，避免 SQL 關鍵字 |
| `檢測到 XSS 攻擊嘗試` | 輸入包含 HTML/JS 代碼 | 檢查輸入內容，避免 HTML 標籤 |
| `匯款轉帳功能目前未啟用` | 付款方式未啟用 | 檢查系統設定或選擇其他付款方式 |
| `線上刷卡功能目前未啟用` | 付款方式未啟用 | 檢查系統設定或選擇其他付款方式 |

## 🔧 如何修復

### 如果是 SQL Injection 誤判
1. 檢查 `validators.js` 第 122-132 行的 SQL Injection 檢測規則
2. 確認是否為正常業務資料
3. 如果需要，調整檢測規則或添加白名單

### 如果是驗證規則太嚴格
1. 檢查 `validators.js` 中的驗證函數
2. 根據實際需求調整驗證規則
3. 測試修改後的規則

### 如果是必填欄位問題
1. 檢查前端表單是否正確提交所有欄位
2. 檢查後端驗證規則是否與前端一致
3. 確認欄位名稱是否正確

## 📞 需要更多幫助？

如果以上方法都無法解決問題，請提供：
1. 完整的錯誤訊息
2. 請求的 URL 和 HTTP 方法
3. 請求的資料內容（隱藏敏感資訊）
4. 伺服器日誌中的相關錯誤訊息

這樣可以更準確地診斷問題。
