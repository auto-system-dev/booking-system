# 郵件寄送判斷說明

## 郵件類型

系統中有以下幾種自動發送的郵件：

1. **訂房確認信** - 訂房成功時立即發送
2. **匯款提醒** - 提醒客戶完成匯款
3. **入住提醒** - 提醒客戶即將入住
4. **感謝入住（回訪信）** - 退房後發送感謝信

---

## 1. 訂房確認信

### 發送時機
- **匯款轉帳**：訂房成功時**立即發送**
- **線上刷卡**：付款成功後**立即發送**

### 發送條件
- 匯款轉帳：訂房資料儲存成功後立即發送
- 線上刷卡：付款狀態變為 `'paid'` 且訂房狀態變為 `'active'` 後發送

### 發送對象
- 客戶（訂房確認信）
- 管理員（新訂房通知）

### 程式碼位置
- `server.js` 第 168-242 行（匯款轉帳）
- `server.js` 第 1104-1140 行（線上刷卡付款成功後）

---

## 2. 匯款提醒

### 發送時間
- **每天上午 09:00** 執行檢查

### 發送條件
查詢符合以下條件的訂房：
1. 付款方式包含「匯款」或「轉帳」
2. 付款狀態為 `'pending'`（待付款）
3. 訂房狀態為 `'active'` 或 `'reserved'`（有效或保留）
4. 訂房建立日期 = **今天 - 保留天數**（預設 3 天）
5. 尚未發送過匯款提醒（`email_sent` 不包含「匯款提醒」）

### 判斷邏輯
```javascript
// 計算保留天數前的日期
const daysAgo = new Date();
daysAgo.setDate(daysAgo.getDate() - daysReserved); // 預設 3 天
// 查詢建立日期 = daysAgo 的訂房
```

### 範例
- 如果保留天數設為 3 天
- 今天是 2025-01-10
- 則會查詢建立日期為 2025-01-07 的訂房

### 程式碼位置
- 定時任務：`server.js` 第 1557 行
- 發送函數：`server.js` 第 1409-1455 行
- 資料庫查詢：`database.js` 第 1073-1096 行

### 注意事項
⚠️ **目前問題**：程式碼中使用硬編碼的 `daysReserved = 3`，沒有從郵件模板設定中讀取 `days_reserved` 和 `send_hour_payment_reminder`。

---

## 3. 入住提醒

### 發送時間
- **每天上午 10:00** 執行檢查

### 發送條件
查詢符合以下條件的訂房：
1. 入住日期 = **明天**
2. 訂房狀態為 `'active'`（有效）
3. 付款狀態為 `'paid'`（已付款）

### 判斷邏輯
```javascript
// 計算明天的日期
const tomorrow = new Date();
tomorrow.setDate(tomorrow.getDate() + 1);
// 查詢入住日期 = tomorrow 的訂房
```

### 範例
- 今天是 2025-01-10
- 則會查詢入住日期為 2025-01-11 的訂房

### 程式碼位置
- 定時任務：`server.js` 第 1561 行
- 發送函數：`server.js` 第 1458-1496 行
- 資料庫查詢：`database.js` 第 1098-1119 行

### 注意事項
⚠️ **目前問題**：程式碼中硬編碼為「明天」，沒有從郵件模板設定中讀取 `days_before_checkin` 和 `send_hour_checkin`。

---

## 4. 感謝入住（回訪信）

### 發送時間
- **每天上午 11:00** 執行檢查

### 發送條件
查詢符合以下條件的訂房：
1. 退房日期 = **昨天**
2. 訂房狀態為 `'active'`（有效）

### 判斷邏輯
```javascript
// 計算昨天的日期
const yesterday = new Date();
yesterday.setDate(yesterday.getDate() - 1);
// 查詢退房日期 = yesterday 的訂房
```

### 範例
- 今天是 2025-01-10
- 則會查詢退房日期為 2025-01-09 的訂房

### 程式碼位置
- 定時任務：`server.js` 第 1565 行
- 發送函數：`server.js` 第 1499-1537 行
- 資料庫查詢：`database.js` 第 1121-1141 行

### 注意事項
⚠️ **目前問題**：程式碼中硬編碼為「昨天」，沒有從郵件模板設定中讀取 `days_after_checkout` 和 `send_hour_feedback`。

---

## 定時任務設定

### Cron 表達式
- **匯款提醒**：`'0 9 * * *'` - 每天 09:00
- **入住提醒**：`'0 10 * * *'` - 每天 10:00
- **回訪信**：`'0 11 * * *'` - 每天 11:00

### Cron 表達式格式
```
分 時 日 月 星期
0  9  *  *  *   = 每天 09:00
```

### 程式碼位置
`server.js` 第 1555-1566 行

---

## 郵件模板設定欄位

資料庫中的 `email_templates` 表有以下設定欄位，但**目前沒有被使用**：

### 匯款提醒模板（payment_reminder）
- `days_reserved` - 保留天數（預設 3 天）
- `send_hour_payment_reminder` - 發送時間（小時）

### 入住提醒模板（checkin_reminder）
- `days_before_checkin` - 入住前幾天發送（預設 1 天）
- `send_hour_checkin` - 發送時間（小時）

### 感謝入住模板（feedback_request）
- `days_after_checkout` - 退房後幾天發送（預設 1 天）
- `send_hour_feedback` - 發送時間（小時）

---

## 目前運作方式總結

### ✅ 已實作
1. **訂房確認信**：立即發送（匯款轉帳）或付款成功後發送（線上刷卡）
2. **定時任務**：每天固定時間執行檢查
3. **郵件發送**：符合條件的訂房會自動發送郵件

### ⚠️ 待改進
1. **匯款提醒**：目前使用硬編碼的 3 天和 09:00，沒有使用模板設定
2. **入住提醒**：目前使用硬編碼的「明天」和 10:00，沒有使用模板設定
3. **回訪信**：目前使用硬編碼的「昨天」和 11:00，沒有使用模板設定

---

## 建議改進

### 1. 使用模板設定
修改發送函數，從郵件模板中讀取設定：
- `days_reserved` / `send_hour_payment_reminder`
- `days_before_checkin` / `send_hour_checkin`
- `days_after_checkout` / `send_hour_feedback`

### 2. 動態 Cron 排程
根據模板設定動態調整 Cron 排程，而不是固定時間。

### 3. 更靈活的判斷
- 入住提醒：可以設定「入住前 N 天」發送
- 回訪信：可以設定「退房後 N 天」發送
- 匯款提醒：可以設定「保留期間的第 N 天」發送

---

## 資料庫查詢邏輯

### 匯款提醒查詢
```sql
SELECT * FROM bookings 
WHERE (payment_method LIKE '%匯款%' OR payment_method LIKE '%轉帳%')
AND payment_status = 'pending' 
AND (status = 'active' OR status = 'reserved')
AND DATE(created_at) = '今天 - 保留天數'
AND (email_sent IS NULL OR email_sent = '' OR email_sent = '0' OR email_sent NOT LIKE '%匯款提醒%')
```

### 入住提醒查詢
```sql
SELECT * FROM bookings 
WHERE check_in_date = '明天'
AND status = 'active'
AND payment_status = 'paid'
```

### 回訪信查詢
```sql
SELECT * FROM bookings 
WHERE check_out_date = '昨天'
AND status = 'active'
```

---

## 郵件狀態更新

發送郵件後，會更新 `bookings.email_sent` 欄位：
- 格式：逗號分隔的字串，例如：`"booking_confirmation,payment_reminder"`
- 類型：
  - `booking_confirmation` - 訂房確認
  - `payment_reminder` - 匯款提醒
  - `checkin_reminder` - 入住提醒
  - `feedback_request` - 感謝入住

---

## 注意事項

1. **時區問題**：目前使用伺服器本地時間，如果部署到不同時區的伺服器，可能需要調整
2. **重複發送**：系統會檢查 `email_sent` 欄位，避免重複發送相同類型的郵件
3. **模板啟用**：只有啟用的模板（`is_enabled = 1`）才會發送郵件
4. **錯誤處理**：如果發送失敗，會記錄錯誤但不影響其他訂房的發送

