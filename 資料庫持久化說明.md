# 資料庫持久化問題說明

## 🔴 問題原因

每次提交到 GitHub 後，管理後台的訂房記錄和系統設定都會消失，原因是：

1. **`.gitignore` 忽略了資料庫檔案**
   - `*.db` 檔案不會被提交到 GitHub
   - `bookings.db` 只存在於本地

2. **Railway 部署時建立新資料庫**
   - 每次從 GitHub 部署時，Railway 會建立全新的空資料庫
   - 所有訂房記錄和系統設定都會遺失

## ✅ 解決方案

### 方案 A：使用 Railway PostgreSQL（推薦）

Railway 提供免費的 PostgreSQL 服務，更適合生產環境。

#### 步驟 1：在 Railway 建立 PostgreSQL 服務

1. 登入 Railway 後台
2. 選擇您的專案
3. 點擊「+ New」→「Database」→「Add PostgreSQL」
4. Railway 會自動建立 PostgreSQL 服務並設定環境變數 `DATABASE_URL`

#### 步驟 2：安裝 PostgreSQL 套件

```bash
npm install pg
```

#### 步驟 3：修改 `database.js` 支援 PostgreSQL

需要將 SQLite 語法改為 PostgreSQL 語法。

#### 步驟 4：設定環境變數

Railway 會自動設定 `DATABASE_URL`，格式如下：
```
postgresql://user:password@host:port/database
```

### 方案 B：使用 Railway Volume 持久化 SQLite（簡單但較不穩定）

如果暫時不想遷移到 PostgreSQL，可以使用 Volume 來持久化 SQLite 檔案。

#### 步驟 1：在 Railway 建立 Volume

1. 登入 Railway 後台
2. 選擇您的專案
3. 點擊「+ New」→「Volume」
4. 命名為 `database`，掛載路徑設為 `/data`

#### 步驟 2：修改 `database.js` 使用 Volume 路徑

```javascript
// 在 Railway 上使用 Volume，本地使用當前目錄
const DB_PATH = process.env.RAILWAY_VOLUME_MOUNT_PATH 
    ? path.join(process.env.RAILWAY_VOLUME_MOUNT_PATH, 'bookings.db')
    : path.join(__dirname, 'bookings.db');
```

#### 步驟 3：設定環境變數

在 Railway 環境變數中設定：
```
RAILWAY_VOLUME_MOUNT_PATH=/data
```

## 🔄 資料遷移（如果已有資料）

如果您本地有重要的訂房記錄，需要先匯出再匯入：

### 匯出 SQLite 資料

```bash
sqlite3 bookings.db .dump > backup.sql
```

### 匯入到 PostgreSQL

需要將 SQL 語法轉換為 PostgreSQL 格式後匯入。

## ⚠️ 注意事項

1. **備份資料**
   - 在遷移前，務必備份現有資料
   - 可以使用 `sqlite3 bookings.db .dump > backup.sql` 匯出

2. **測試環境**
   - 建議先在測試環境驗證遷移流程
   - 確認資料正確後再部署到正式環境

3. **系統設定**
   - 系統設定也儲存在資料庫中
   - 遷移後需要重新設定或從備份還原

## 📝 建議

**強烈建議使用方案 A（PostgreSQL）**，因為：
- ✅ Railway 提供免費的 PostgreSQL 服務
- ✅ 更適合生產環境
- ✅ 資料不會因為部署而遺失
- ✅ 支援更好的並發處理
- ✅ 有完整的備份機制

## 🆘 如果急需解決

如果急需解決問題，可以先使用方案 B（Volume），但長期建議遷移到 PostgreSQL。

## 🔧 快速修復（臨時方案）

如果您現在就需要解決問題，可以：

1. **暫時移除 `.gitignore` 中的 `*.db`**（不推薦，但可以快速解決）
   - 移除 `.gitignore` 中的 `*.db` 行
   - 提交 `bookings.db` 到 GitHub
   - ⚠️ 注意：這會將資料庫檔案提交到公開的 GitHub，有安全風險

2. **使用 Railway Volume**（推薦臨時方案）
   - 按照方案 B 的步驟設定 Volume
   - 資料會持久化在 Volume 中，不會因為部署而遺失

