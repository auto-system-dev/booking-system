# 權限管理系統設計方案

## 📋 概述

本方案為訂房系統設計一套完整的權限管理（RBAC - Role-Based Access Control）系統，支援多角色、多權限的細粒度控制。

---

## 🎯 設計目標

1. **角色分級管理**：支援多種管理員角色（超級管理員、一般管理員、客服人員等）
2. **功能權限控制**：精確控制每個角色可訪問的功能模組
3. **資料權限控制**：控制不同角色可查看/編輯的資料範圍
4. **操作日誌記錄**：記錄所有權限相關操作，便於審計
5. **易於擴展**：未來可輕鬆新增角色和權限

---

## 🏗️ 系統架構

### 1. 資料庫設計

#### 1.1 角色表（roles）
```sql
CREATE TABLE IF NOT EXISTS roles (
    id SERIAL PRIMARY KEY,
    role_name VARCHAR(50) UNIQUE NOT NULL,        -- 角色名稱（如：super_admin, admin, staff）
    display_name VARCHAR(100) NOT NULL,          -- 顯示名稱（如：超級管理員、一般管理員）
    description TEXT,                             -- 角色描述
    is_system_role INTEGER DEFAULT 0,             -- 是否為系統內建角色（不可刪除）
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 1.2 權限表（permissions）
```sql
CREATE TABLE IF NOT EXISTS permissions (
    id SERIAL PRIMARY KEY,
    permission_code VARCHAR(100) UNIQUE NOT NULL, -- 權限代碼（如：bookings.view, bookings.edit）
    permission_name VARCHAR(100) NOT NULL,        -- 權限名稱（如：查看訂房記錄）
    module VARCHAR(50) NOT NULL,                  -- 所屬模組（如：bookings, customers, settings）
    description TEXT,                             -- 權限描述
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 1.3 角色權限關聯表（role_permissions）
```sql
CREATE TABLE IF NOT EXISTS role_permissions (
    id SERIAL PRIMARY KEY,
    role_id INTEGER NOT NULL REFERENCES roles(id) ON DELETE CASCADE,
    permission_id INTEGER NOT NULL REFERENCES permissions(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(role_id, permission_id)
);
```

#### 1.4 更新管理員表（admins）
```sql
-- 修改現有的 admins 表，將 role 改為 role_id（外鍵）
ALTER TABLE admins 
    ADD COLUMN IF NOT EXISTS role_id INTEGER REFERENCES roles(id),
    ADD COLUMN IF NOT EXISTS department VARCHAR(100),  -- 部門（選填）
    ADD COLUMN IF NOT EXISTS phone VARCHAR(20),        -- 電話（選填）
    ADD COLUMN IF NOT EXISTS notes TEXT;              -- 備註（選填）

-- 保留 role 欄位作為過渡（可選）
```

---

## 👥 預設角色設計

### 1. 超級管理員（super_admin）
- **權限範圍**：所有功能
- **適用對象**：系統擁有者、技術管理員
- **權限**：
  - ✅ 所有模組的查看、新增、編輯、刪除
  - ✅ 系統設定管理
  - ✅ 管理員帳號管理
  - ✅ 角色權限管理
  - ✅ 操作日誌查看
  - ✅ 資料備份與還原

### 2. 一般管理員（admin）
- **權限範圍**：日常營運管理
- **適用對象**：店長、經理
- **權限**：
  - ✅ 訂房記錄：查看、編輯、取消
  - ✅ 客戶管理：查看、編輯
  - ✅ 房型管理：查看、編輯
  - ✅ 加購商品：查看、編輯
  - ✅ 優惠代碼：查看、編輯
  - ✅ 統計資料：查看
  - ✅ 郵件模板：查看、編輯
  - ❌ 系統設定（僅查看）
  - ❌ 管理員帳號管理
  - ❌ 角色權限管理

### 3. 客服人員（staff）
- **權限範圍**：客戶服務相關
- **適用對象**：客服、櫃台人員
- **權限**：
  - ✅ 訂房記錄：查看、編輯（僅限自己建立的）
  - ✅ 客戶管理：查看、編輯
  - ✅ 房型管理：僅查看
  - ✅ 加購商品：僅查看
  - ❌ 優惠代碼管理
  - ❌ 統計資料
  - ❌ 系統設定
  - ❌ 郵件模板

### 4. 財務人員（finance）
- **權限範圍**：財務相關功能
- **適用對象**：會計、財務
- **權限**：
  - ✅ 訂房記錄：查看（含付款資訊）
  - ✅ 統計資料：查看（含營收報表）
  - ✅ 客戶管理：僅查看
  - ❌ 訂房編輯/取消
  - ❌ 房型管理
  - ❌ 系統設定

### 5. 只讀管理員（viewer）
- **權限範圍**：僅查看
- **適用對象**：實習生、外部顧問
- **權限**：
  - ✅ 所有模組：僅查看
  - ❌ 所有編輯、新增、刪除功能

---

## 🔐 權限代碼設計

### 權限命名規則
格式：`{模組}.{操作}`

### 模組權限列表

#### 訂房管理（bookings）
- `bookings.view` - 查看訂房記錄
- `bookings.create` - 新增訂房
- `bookings.edit` - 編輯訂房
- `bookings.delete` - 刪除訂房
- `bookings.cancel` - 取消訂房
- `bookings.export` - 匯出訂房資料

#### 客戶管理（customers）
- `customers.view` - 查看客戶資料
- `customers.create` - 新增客戶
- `customers.edit` - 編輯客戶資料
- `customers.delete` - 刪除客戶資料
- `customers.export` - 匯出客戶資料

#### 房型管理（room_types）
- `room_types.view` - 查看房型
- `room_types.create` - 新增房型
- `room_types.edit` - 編輯房型
- `room_types.delete` - 刪除房型

#### 加購商品（addons）
- `addons.view` - 查看加購商品
- `addons.create` - 新增加購商品
- `addons.edit` - 編輯加購商品
- `addons.delete` - 刪除加購商品

#### 優惠代碼（promo_codes）
- `promo_codes.view` - 查看優惠代碼
- `promo_codes.create` - 新增優惠代碼
- `promo_codes.edit` - 編輯優惠代碼
- `promo_codes.delete` - 刪除優惠代碼

#### 統計資料（statistics）
- `statistics.view` - 查看統計資料
- `statistics.export` - 匯出報表

#### 系統設定（settings）
- `settings.view` - 查看系統設定
- `settings.edit` - 編輯系統設定
- `settings.payment` - 支付設定
- `settings.email` - 郵件設定

#### 郵件模板（email_templates）
- `email_templates.view` - 查看郵件模板
- `email_templates.edit` - 編輯郵件模板

#### 管理員管理（admins）
- `admins.view` - 查看管理員列表
- `admins.create` - 新增管理員
- `admins.edit` - 編輯管理員資料
- `admins.delete` - 刪除管理員
- `admins.change_password` - 修改其他管理員密碼

#### 角色權限管理（roles）
- `roles.view` - 查看角色列表
- `roles.create` - 新增角色
- `roles.edit` - 編輯角色
- `roles.delete` - 刪除角色
- `roles.assign_permissions` - 分配權限

#### 操作日誌（logs）
- `logs.view` - 查看操作日誌
- `logs.export` - 匯出操作日誌

---

## 🛠️ 實作方案

### 階段一：資料庫與基礎架構（優先實作）

#### 1.1 建立資料表
- [ ] 建立 `roles` 表
- [ ] 建立 `permissions` 表
- [ ] 建立 `role_permissions` 關聯表
- [ ] 更新 `admins` 表結構

#### 1.2 初始化資料
- [ ] 建立預設角色（super_admin, admin, staff, finance, viewer）
- [ ] 建立所有權限代碼
- [ ] 為每個角色分配預設權限
- [ ] 將現有管理員遷移到新角色系統

#### 1.3 資料庫函數
- [ ] 建立 `getAdminPermissions(adminId)` - 取得管理員所有權限
- [ ] 建立 `hasPermission(adminId, permissionCode)` - 檢查是否有權限
- [ ] 建立 `getRolePermissions(roleId)` - 取得角色所有權限

### 階段二：後端 API 實作

#### 2.1 權限檢查中間件
```javascript
// middleware/permission.js
function checkPermission(permissionCode) {
    return async (req, res, next) => {
        if (!req.session || !req.session.admin) {
            return res.status(401).json({ success: false, message: '未登入' });
        }
        
        const adminId = req.session.admin.id;
        const hasPermission = await db.hasPermission(adminId, permissionCode);
        
        if (!hasPermission) {
            return res.status(403).json({ 
                success: false, 
                message: '您沒有權限執行此操作' 
            });
        }
        
        next();
    };
}
```

#### 2.2 角色管理 API
- [ ] `GET /api/admin/roles` - 取得角色列表
- [ ] `GET /api/admin/roles/:id` - 取得角色詳情
- [ ] `POST /api/admin/roles` - 新增角色（需 `roles.create` 權限）
- [ ] `PUT /api/admin/roles/:id` - 編輯角色（需 `roles.edit` 權限）
- [ ] `DELETE /api/admin/roles/:id` - 刪除角色（需 `roles.delete` 權限）
- [ ] `PUT /api/admin/roles/:id/permissions` - 分配權限（需 `roles.assign_permissions` 權限）

#### 2.3 管理員管理 API（擴充）
- [ ] `GET /api/admin/admins` - 取得管理員列表（需 `admins.view` 權限）
- [ ] `POST /api/admin/admins` - 新增管理員（需 `admins.create` 權限）
- [ ] `PUT /api/admin/admins/:id` - 編輯管理員（需 `admins.edit` 權限）
- [ ] `PUT /api/admin/admins/:id/role` - 變更管理員角色（需 `admins.edit` 權限）
- [ ] `DELETE /api/admin/admins/:id` - 刪除管理員（需 `admins.delete` 權限）

#### 2.4 權限檢查 API
- [ ] `GET /api/admin/permissions` - 取得所有權限列表
- [ ] `GET /api/admin/my-permissions` - 取得當前管理員的權限
- [ ] `GET /api/admin/check-permission/:code` - 檢查是否有特定權限

#### 2.5 更新現有 API
為所有現有的管理 API 加上權限檢查：
- [ ] 訂房相關 API：加上 `bookings.*` 權限檢查
- [ ] 客戶相關 API：加上 `customers.*` 權限檢查
- [ ] 房型相關 API：加上 `room_types.*` 權限檢查
- [ ] 設定相關 API：加上 `settings.*` 權限檢查
- [ ] ... 其他模組

### 階段三：前端介面實作

#### 3.1 權限檢查工具函數
```javascript
// admin.js
let currentAdminPermissions = [];

// 載入當前管理員權限
async function loadAdminPermissions() {
    try {
        const response = await fetch('/api/admin/my-permissions');
        const data = await response.json();
        if (data.success) {
            currentAdminPermissions = data.permissions;
        }
    } catch (error) {
        console.error('載入權限失敗:', error);
    }
}

// 檢查是否有權限
function hasPermission(permissionCode) {
    return currentAdminPermissions.includes(permissionCode);
}

// 根據權限顯示/隱藏元素
function checkPermissionAndShow(elementId, permissionCode) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = hasPermission(permissionCode) ? '' : 'none';
    }
}
```

#### 3.2 側邊欄權限控制
- [ ] 根據權限顯示/隱藏側邊欄選項
- [ ] 無權限的模組不顯示在選單中

#### 3.3 功能按鈕權限控制
- [ ] 新增/編輯/刪除按鈕根據權限顯示/隱藏
- [ ] 無權限時顯示提示訊息

#### 3.4 角色管理頁面
- [ ] 角色列表頁面
- [ ] 新增/編輯角色表單
- [ ] 權限分配介面（多選框或樹狀結構）

#### 3.5 管理員管理頁面
- [ ] 管理員列表頁面
- [ ] 新增/編輯管理員表單
- [ ] 角色分配下拉選單

---

## 📊 資料權限控制（進階功能）

### 1. 資料範圍控制
除了功能權限，還可以控制資料範圍：

#### 範例：客服人員只能查看自己建立的訂房
```javascript
// 在查詢訂房時加入條件
if (req.session.admin.role === 'staff') {
    query += ' WHERE created_by = $1';
    params.push(req.session.admin.id);
}
```

#### 範例：部門資料隔離
```sql
-- 在 admins 表加入 department 欄位
-- 查詢時過濾相同部門的資料
WHERE department = (SELECT department FROM admins WHERE id = $1)
```

### 2. 時間範圍控制
某些角色只能查看特定時間範圍的資料：
- 財務人員：只能查看已結算的訂房
- 客服人員：只能查看當月訂房

---

## 🔍 操作日誌增強

### 記錄權限相關操作
在 `admin_logs` 表中記錄：
- 角色變更
- 權限分配
- 管理員新增/刪除
- 權限檢查失敗（403 錯誤）

---

## 🚀 實作優先順序建議

### 第一階段（核心功能）- 已完成 ✅
1. ✅ 建立資料表結構（roles, permissions, role_permissions）
2. ✅ 初始化預設角色和權限（5 種角色 + 40+ 權限代碼）
3. ✅ 實作權限檢查中間件（checkPermission）
4. ✅ 更新登入 API，載入管理員權限到 session
5. ✅ 實作角色管理 API（CRUD）
6. ✅ 實作管理員管理 API（CRUD）
7. ✅ 實作權限查詢 API（my-permissions, check-permission）

### 第二階段（管理介面）- 已完成 ✅
1. ✅ 實作角色管理 API（CRUD + 權限分配）
2. ✅ 實作管理員管理 API（CRUD + 重設密碼）
3. ✅ 前端角色管理頁面（角色列表、權限編輯、權限參考表）
4. ✅ 前端管理員管理頁面（管理員列表、新增/編輯、重設密碼）
5. ✅ 前端權限檢查工具函數（hasPermission、updateSidebarByPermissions）

### 第三階段（完整整合）- 已完成 ✅
1. ✅ 為所有 API 加上權限檢查
   - 訂房 API：bookings.view/create/edit/cancel/delete
   - 客戶 API：customers.view/edit/delete
   - 房型 API：room_types.view/create/edit/delete
   - 加購商品 API：addons.view/create/edit/delete
   - 優惠代碼 API：promo_codes.view/create/edit/delete
   - 統計資料 API：statistics.view
   - 備份 API：backup.view/create/delete
   - 設定 API：settings.edit
   - 郵件模板 API：email_templates.view/edit/send_test
2. ✅ 前端所有功能按鈕加上權限控制
   - 訂房列表：查看/編輯/取消/刪除按鈕
   - 客戶列表：查看/編輯/刪除按鈕
   - 房型列表：編輯/刪除按鈕
   - 加購商品列表：編輯/刪除按鈕
   - 優惠代碼列表：編輯/刪除按鈕
   - 假日管理：新增/刪除按鈕
   - 會員等級：新增/編輯/刪除按鈕
3. ✅ 側邊欄權限控制
   - 使用 data-permission 屬性定義所需權限
   - 登入後自動更新可見選單項目
4. ✅ 操作日誌記錄權限操作

### 第四階段（進階功能）- 選配
1. ⚪ 資料範圍控制
2. ⚪ 時間範圍控制
3. ⚪ 權限繼承機制
4. ⚪ 臨時權限授予

---

## 🔒 安全性考量

### 1. 權限檢查層級
- **前端檢查**：提升使用者體驗，隱藏無權限功能
- **後端檢查**：必須實作，防止 API 直接呼叫
- **資料庫層級**：可選，使用 Row Level Security（PostgreSQL）

### 2. 防止權限提升
- 超級管理員角色不可被一般管理員修改
- 管理員不可將自己的角色提升為超級管理員
- 刪除管理員時，不可刪除最後一個超級管理員

### 3. Session 安全
- Session 中儲存權限列表，減少資料庫查詢
- 權限變更時，強制重新登入或更新 Session
- 定期檢查 Session 中的權限是否仍有效

---

## 📝 使用範例

### 後端 API 使用範例
```javascript
// 需要 bookings.view 權限
app.get('/api/admin/bookings', 
    requireAdmin, 
    checkPermission('bookings.view'), 
    async (req, res) => {
        // 取得訂房列表
    }
);

// 需要 bookings.edit 權限
app.put('/api/admin/bookings/:id', 
    requireAdmin, 
    checkPermission('bookings.edit'), 
    async (req, res) => {
        // 編輯訂房
    }
);
```

### 前端使用範例
```javascript
// 檢查權限並顯示按鈕
if (hasPermission('bookings.create')) {
    showCreateButton();
}

// 根據權限顯示/隱藏功能
checkPermissionAndShow('editBookingBtn', 'bookings.edit');
checkPermissionAndShow('deleteBookingBtn', 'bookings.delete');
```

---

## 🎯 版本分級建議

### 基礎版
- ✅ 基本角色管理（3 種角色：超級管理員、一般管理員、客服）
- ✅ 基本權限控制（模組級別）
- ✅ 操作日誌記錄

### 專業版
- ✅ 完整角色管理（5 種角色）
- ✅ 細粒度權限控制（操作級別）
- ✅ 管理員管理介面
- ✅ 角色權限分配介面

### 企業版
- ✅ 自訂角色功能
- ✅ 資料範圍控制
- ✅ 時間範圍控制
- ✅ 權限繼承機制
- ✅ 臨時權限授予
- ✅ 權限審計報表

---

## 📚 相關文件

- [管理後台登入系統說明.md](./管理後台登入系統說明.md)
- [功能分級方案-基礎版專業版企業版.md](./功能分級方案-基礎版專業版企業版.md)

---

## ✅ 檢查清單

### 資料庫
- [x] 建立 roles 表
- [x] 建立 permissions 表
- [x] 建立 role_permissions 表
- [x] 更新 admins 表（添加 role_id, department, phone, notes 欄位）
- [x] 初始化預設資料（5 種角色 + 40+ 權限代碼）
- [x] 自動遷移現有管理員到新角色系統

### 後端
- [x] 實作權限檢查中間件（checkPermission）
- [x] 實作角色管理 API（GET/POST/PUT/DELETE /api/admin/roles）
- [x] 實作管理員管理 API（GET/POST/PUT/DELETE /api/admin/admins）
- [x] 實作權限查詢 API（my-permissions, check-permission, permissions）
- [x] 更新登入 API 載入權限到 session
- [ ] 更新所有現有 API 加上權限檢查（第三階段）

### 前端
- [x] 實作權限檢查工具函數（hasPermission、checkPermissionAndShow）
- [x] 實作角色管理頁面（角色列表、新增/編輯角色、權限分配）
- [x] 實作管理員管理頁面（管理員列表、新增/編輯、重設密碼）
- [x] 更新側邊欄加上權限控制（permission-required class）
- [ ] 更新所有功能按鈕加上權限控制（第三階段）

### 測試
- [ ] 測試各角色的權限限制
- [ ] 測試權限變更後的 Session 更新
- [ ] 測試無權限操作的錯誤處理
- [ ] 測試操作日誌記錄

---

**建議：先從第一階段開始實作，逐步完善權限管理系統。**



