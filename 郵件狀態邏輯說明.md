# éƒµä»¶ç‹€æ…‹é‚è¼¯èªªæ˜

## ğŸ“§ éƒµä»¶ç‹€æ…‹æ¦‚è¿°

ç³»çµ±ä¸­çš„éƒµä»¶ç‹€æ…‹ï¼ˆ`email_sent`ï¼‰ç”¨æ–¼è¿½è¹¤å·²ç™¼é€çµ¦å®¢æˆ¶çš„éƒµä»¶é¡å‹ã€‚éƒµä»¶ç‹€æ…‹å¯ä»¥å„²å­˜ç‚ºï¼š
- **æ•´æ•¸æ ¼å¼**ï¼š`0`ï¼ˆæœªç™¼é€ï¼‰æˆ– `1`ï¼ˆå·²ç™¼é€ï¼‰- èˆŠæ ¼å¼ï¼Œç”¨æ–¼å‘å¾Œå…¼å®¹
- **å­—ä¸²æ ¼å¼**ï¼šå¤šå€‹éƒµä»¶é¡å‹ç”¨é€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚ï¼š`booking_confirmation,checkin_reminder`

## ğŸ“‹ éƒµä»¶é¡å‹

ç³»çµ±æ”¯æ´å››ç¨®éƒµä»¶é¡å‹ï¼š

| éƒµä»¶é¡å‹ | é¡¯ç¤ºåç¨± | èªªæ˜ | ç™¼é€æ™‚æ©Ÿ |
|---------|---------|------|---------|
| `booking_confirmation` | è¨‚æˆ¿ç¢ºèª | å®¢æˆ¶æäº¤è¨‚æˆ¿å¾Œç™¼é€ | å»ºç«‹è¨‚æˆ¿æ™‚ |
| `payment_reminder` | åŒ¯æ¬¾æé†’ | æé†’å®¢æˆ¶åŒ¯æ¬¾æœŸé™ | å®šæ™‚ä»»å‹™ï¼ˆæ¯å¤© 09:00ï¼‰ |
| `checkin_reminder` | å…¥ä½æé†’ | æé†’å®¢æˆ¶å³å°‡å…¥ä½ | å®šæ™‚ä»»å‹™ï¼ˆæ¯å¤© 10:00ï¼‰ |
| `feedback_request` | æ„Ÿè¬å…¥ä½ | é€€æˆ¿å¾Œçš„å›è¨ªä¿¡ | å®šæ™‚ä»»å‹™ï¼ˆæ¯å¤© 11:00ï¼‰ |

## ğŸ”„ éƒµä»¶ç‹€æ…‹æ›´æ–°æµç¨‹

### 1. å»ºç«‹è¨‚æˆ¿æ™‚ç™¼é€ç¢ºèªéƒµä»¶

**ä½ç½®**ï¼š`server.js` (353-503è¡Œ)

ç•¶å®¢æˆ¶æäº¤è¨‚æˆ¿è¡¨å–®æ™‚ï¼š

```javascript
// ç™¼é€ç¢ºèªéƒµä»¶çµ¦å®¢æˆ¶
const customerMailOptions = {
    from: process.env.EMAIL_USER,
    to: guestEmail,
    subject: 'ã€è¨‚æˆ¿ç¢ºèªã€‘æ‚¨çš„è¨‚æˆ¿å·²æˆåŠŸ',
    html: generateCustomerEmail(bookingData)
};

// ç™¼é€éƒµä»¶
let emailSent = false;
try {
    // ç™¼é€éƒµä»¶ï¼ˆä½¿ç”¨ Gmail API æˆ– SMTPï¼‰
    customerResult = await sendEmailViaGmailAPI(customerMailOptions);
    emailSent = true;
} catch (error) {
    console.error('ç™¼é€éƒµä»¶å¤±æ•—:', error);
    emailSent = false;
}

// å„²å­˜è¨‚æˆ¿è³‡æ–™
await db.saveBooking({
    ...bookingData,
    emailSent: emailSent,  // å¸ƒæ—å€¼ï¼štrue/false
    // ...
});

// å¦‚æœéƒµä»¶ç™¼é€æˆåŠŸï¼Œæ›´æ–°éƒµä»¶ç‹€æ…‹
if (emailSent) {
    await db.updateEmailStatus(bookingData.bookingId, true);
    // æ­¤æ™‚ email_sent = 1ï¼ˆæ•´æ•¸æ ¼å¼ï¼‰
}
```

**è¦å‰‡**ï¼š
- âœ… å»ºç«‹è¨‚æˆ¿æ™‚æœƒè‡ªå‹•ç™¼é€ã€Œè¨‚æˆ¿ç¢ºèªã€éƒµä»¶çµ¦å®¢æˆ¶
- âœ… åŒæ™‚ç™¼é€ã€Œæ–°è¨‚æˆ¿é€šçŸ¥ã€éƒµä»¶çµ¦ç®¡ç†å“¡ï¼ˆä¸å½±éŸ¿ `email_sent` ç‹€æ…‹ï¼‰
- âœ… å¦‚æœéƒµä»¶ç™¼é€æˆåŠŸï¼Œ`email_sent` è¨­ç‚º `1`
- âš ï¸ å¦‚æœéƒµä»¶ç™¼é€å¤±æ•—ï¼Œ`email_sent` ä¿æŒç‚º `0`

### 2. æ›´æ–°éƒµä»¶ç‹€æ…‹å‡½æ•¸

**ä½ç½®**ï¼š`database.js` (1166-1179è¡Œ)

```javascript
async function updateEmailStatus(bookingId, emailSent) {
    // å¦‚æœ emailSent æ˜¯å¸ƒæ—å€¼ï¼Œè½‰æ›ç‚ºæ•´æ•¸
    const value = emailSent ? 1 : 0;
    
    const sql = usePostgreSQL 
        ? `UPDATE bookings SET email_sent = $1 WHERE booking_id = $2`
        : `UPDATE bookings SET email_sent = ? WHERE booking_id = ?`;
    
    await query(sql, [value, bookingId]);
}
```

**æ³¨æ„**ï¼šæ­¤å‡½æ•¸ç›®å‰åªæ”¯æ´æ•´æ•¸æ ¼å¼ï¼ˆ0/1ï¼‰ï¼Œä¸æ”¯æ´å­—ä¸²æ ¼å¼çš„å¤šéƒµä»¶é¡å‹ã€‚

### 3. å®šæ™‚ä»»å‹™è‡ªå‹•ç™¼é€éƒµä»¶

ç³»çµ±æœ‰ä¸‰å€‹å®šæ™‚ä»»å‹™æœƒè‡ªå‹•ç™¼é€éƒµä»¶ï¼š

#### åŒ¯æ¬¾æé†’éƒµä»¶ï¼ˆæ¯å¤© 09:00ï¼‰

**ä½ç½®**ï¼š`server.js` (1656-1695è¡Œ)

```javascript
async function sendPaymentReminderEmails() {
    // 1. æŸ¥è©¢éœ€è¦ç™¼é€åŒ¯æ¬¾æé†’çš„è¨‚æˆ¿
    const bookings = await db.getBookingsForPaymentReminder();
    
    // 2. å–å¾—åŒ¯æ¬¾æé†’æ¨¡æ¿
    const template = await db.getEmailTemplateByKey('payment_reminder');
    
    // 3. ç™¼é€éƒµä»¶çµ¦æ¯å€‹è¨‚æˆ¿
    for (const booking of bookings) {
        await transporter.sendMail({
            from: process.env.EMAIL_USER,
            to: booking.guest_email,
            subject: subject,
            html: content
        });
        
        // âš ï¸ æ³¨æ„ï¼šç›®å‰å®šæ™‚ä»»å‹™ç™¼é€éƒµä»¶å¾Œï¼Œä¸æœƒæ›´æ–° email_sent ç‹€æ…‹
    }
}
```

**æŸ¥è©¢æ¢ä»¶**ï¼š
- ä»˜æ¬¾æ–¹å¼ç‚ºã€ŒåŒ¯æ¬¾è½‰å¸³ã€
- ä»˜æ¬¾ç‹€æ…‹ç‚ºã€Œå¾…ä»˜æ¬¾ã€ï¼ˆ`pending`ï¼‰
- è¨‚æˆ¿ç‹€æ…‹ç‚ºã€Œä¿ç•™ã€ï¼ˆ`reserved`ï¼‰
- è¨‚æˆ¿å»ºç«‹æ—¥æœŸåœ¨ä¿ç•™æœŸé™å…§

#### å…¥ä½æé†’éƒµä»¶ï¼ˆæ¯å¤© 10:00ï¼‰

**ä½ç½®**ï¼š`server.js` (1742-1774è¡Œ)

```javascript
async function sendCheckinReminderEmails() {
    // 1. æŸ¥è©¢éœ€è¦ç™¼é€å…¥ä½æé†’çš„è¨‚æˆ¿
    const bookings = await db.getBookingsForCheckinReminder();
    
    // 2. å–å¾—å…¥ä½æé†’æ¨¡æ¿
    const template = await db.getEmailTemplateByKey('checkin_reminder');
    
    // 3. ç™¼é€éƒµä»¶çµ¦æ¯å€‹è¨‚æˆ¿
    for (const booking of bookings) {
        await transporter.sendMail({
            from: process.env.EMAIL_USER,
            to: booking.guest_email,
            subject: subject,
            html: content
        });
        
        // âš ï¸ æ³¨æ„ï¼šç›®å‰å®šæ™‚ä»»å‹™ç™¼é€éƒµä»¶å¾Œï¼Œä¸æœƒæ›´æ–° email_sent ç‹€æ…‹
    }
}
```

**æŸ¥è©¢æ¢ä»¶**ï¼š
- è¨‚æˆ¿ç‹€æ…‹ç‚ºã€Œæœ‰æ•ˆã€ï¼ˆ`active`ï¼‰
- å…¥ä½æ—¥æœŸç‚ºæ˜å¤©
- éƒµä»¶æ¨¡æ¿ä¸­è¨­å®šçš„ `days_before_checkin` å’Œ `send_hour_checkin`

#### æ„Ÿè¬å…¥ä½éƒµä»¶ï¼ˆæ¯å¤© 11:00ï¼‰

**ä½ç½®**ï¼š`server.js` (1776-1808è¡Œ)

```javascript
async function sendFeedbackRequestEmails() {
    // 1. æŸ¥è©¢éœ€è¦ç™¼é€å›è¨ªä¿¡çš„è¨‚æˆ¿
    const bookings = await db.getBookingsForFeedbackRequest();
    
    // 2. å–å¾—å›è¨ªä¿¡æ¨¡æ¿
    const template = await db.getEmailTemplateByKey('feedback_request');
    
    // 3. ç™¼é€éƒµä»¶çµ¦æ¯å€‹è¨‚æˆ¿
    for (const booking of bookings) {
        await transporter.sendMail({
            from: process.env.EMAIL_USER,
            to: booking.guest_email,
            subject: subject,
            html: content
        });
        
        // âš ï¸ æ³¨æ„ï¼šç›®å‰å®šæ™‚ä»»å‹™ç™¼é€éƒµä»¶å¾Œï¼Œä¸æœƒæ›´æ–° email_sent ç‹€æ…‹
    }
}
```

**æŸ¥è©¢æ¢ä»¶**ï¼š
- è¨‚æˆ¿ç‹€æ…‹ç‚ºã€Œæœ‰æ•ˆã€ï¼ˆ`active`ï¼‰
- é€€æˆ¿æ—¥æœŸç‚ºæ˜¨å¤©
- éƒµä»¶æ¨¡æ¿ä¸­è¨­å®šçš„ `days_after_checkout` å’Œ `send_hour_feedback`

## ğŸ“Š éƒµä»¶ç‹€æ…‹é¡¯ç¤ºé‚è¼¯

**ä½ç½®**ï¼š`admin.js` (477-507è¡Œ)

```javascript
function getEmailStatusDisplay(emailSent) {
    // 1. å¦‚æœæœªç™¼é€ï¼Œé¡¯ç¤ºã€Œæœªç™¼é€ã€
    if (!emailSent || emailSent === '0' || emailSent === 0) {
        return '<span class="status-badge status-unsent">æœªç™¼é€</span>';
    }
    
    // 2. å¦‚æœæ˜¯å­—ä¸²æ ¼å¼ï¼Œè§£æéƒµä»¶é¡å‹
    if (typeof emailSent === 'string') {
        const emailTypes = emailSent.split(',').filter(t => t.trim());
        
        const emailTypeMap = {
            'booking_confirmation': 'è¨‚æˆ¿ç¢ºèª',
            'checkin_reminder': 'å…¥ä½æé†’',
            'feedback_request': 'æ„Ÿè¬å…¥ä½',
            'payment_reminder': 'åŒ¯æ¬¾æé†’'
        };
        
        // é¡¯ç¤ºå¤šå€‹éƒµä»¶é¡å‹çš„æ¨™ç±¤
        const badges = emailTypes.map(type => {
            const typeName = emailTypeMap[type.trim()] || type.trim();
            return `<span class="status-badge status-sent">${typeName}</span>`;
        }).join('');
        
        return badges;
    }
    
    // 3. èˆŠæ ¼å¼ï¼šåªé¡¯ç¤ºã€Œå·²ç™¼é€ã€
    return '<span class="status-badge status-sent">å·²ç™¼é€</span>';
}
```

**é¡¯ç¤ºè¦å‰‡**ï¼š
- `0` æˆ– `null` â†’ é¡¯ç¤ºã€Œæœªç™¼é€ã€ï¼ˆç´…è‰²æ¨™ç±¤ï¼‰
- `1` â†’ é¡¯ç¤ºã€Œå·²ç™¼é€ã€ï¼ˆç¶ è‰²æ¨™ç±¤ï¼‰
- `"booking_confirmation"` â†’ é¡¯ç¤ºã€Œè¨‚æˆ¿ç¢ºèªã€ï¼ˆç¶ è‰²æ¨™ç±¤ï¼‰
- `"booking_confirmation,checkin_reminder"` â†’ é¡¯ç¤ºå…©å€‹æ¨™ç±¤ï¼šã€Œè¨‚æˆ¿ç¢ºèªã€å’Œã€Œå…¥ä½æé†’ã€

## ğŸ” éƒµä»¶ç‹€æ…‹æŸ¥è©¢

### æŸ¥è©¢éœ€è¦ç™¼é€åŒ¯æ¬¾æé†’çš„è¨‚æˆ¿

**ä½ç½®**ï¼š`database.js` (1595-1620è¡Œ)

```javascript
async function getBookingsForPaymentReminder() {
    const sql = `
        SELECT * FROM bookings 
        WHERE payment_method LIKE '%åŒ¯æ¬¾%' 
        AND payment_status = 'pending'
        AND status = 'reserved'
        AND email_sent = 1  -- åªæŸ¥è©¢å·²ç™¼é€ç¢ºèªéƒµä»¶çš„è¨‚æˆ¿
    `;
}
```

**æŸ¥è©¢æ¢ä»¶**ï¼š
- ä»˜æ¬¾æ–¹å¼åŒ…å«ã€ŒåŒ¯æ¬¾ã€
- ä»˜æ¬¾ç‹€æ…‹ç‚ºã€Œå¾…ä»˜æ¬¾ã€
- è¨‚æˆ¿ç‹€æ…‹ç‚ºã€Œä¿ç•™ã€
- `email_sent = 1`ï¼ˆå·²ç™¼é€ç¢ºèªéƒµä»¶ï¼‰

### æŸ¥è©¢éœ€è¦ç™¼é€å…¥ä½æé†’çš„è¨‚æˆ¿

**ä½ç½®**ï¼š`database.js` (1633-1655è¡Œ)

```javascript
async function getBookingsForCheckinReminder() {
    const sql = `
        SELECT * FROM bookings 
        WHERE status = 'active'
        AND check_in_date = ?  -- å…¥ä½æ—¥æœŸç‚ºæ˜å¤©
        AND email_sent = 1  -- åªæŸ¥è©¢å·²ç™¼é€ç¢ºèªéƒµä»¶çš„è¨‚æˆ¿
    `;
}
```

**æŸ¥è©¢æ¢ä»¶**ï¼š
- è¨‚æˆ¿ç‹€æ…‹ç‚ºã€Œæœ‰æ•ˆã€
- å…¥ä½æ—¥æœŸç‚ºæ˜å¤©
- `email_sent = 1`ï¼ˆå·²ç™¼é€ç¢ºèªéƒµä»¶ï¼‰

### æŸ¥è©¢éœ€è¦ç™¼é€å›è¨ªä¿¡çš„è¨‚æˆ¿

**ä½ç½®**ï¼š`database.js` (1677-1699è¡Œ)

```javascript
async function getBookingsForFeedbackRequest() {
    const sql = `
        SELECT * FROM bookings 
        WHERE status = 'active'
        AND check_out_date = ?  -- é€€æˆ¿æ—¥æœŸç‚ºæ˜¨å¤©
        AND email_sent = 1  -- åªæŸ¥è©¢å·²ç™¼é€ç¢ºèªéƒµä»¶çš„è¨‚æˆ¿
    `;
}
```

**æŸ¥è©¢æ¢ä»¶**ï¼š
- è¨‚æˆ¿ç‹€æ…‹ç‚ºã€Œæœ‰æ•ˆã€
- é€€æˆ¿æ—¥æœŸç‚ºæ˜¨å¤©
- `email_sent = 1`ï¼ˆå·²ç™¼é€ç¢ºèªéƒµä»¶ï¼‰

## âš ï¸ ç›®å‰é™åˆ¶èˆ‡å•é¡Œ

### 1. å®šæ™‚ä»»å‹™ä¸æ›´æ–°éƒµä»¶ç‹€æ…‹

**å•é¡Œ**ï¼šå®šæ™‚ä»»å‹™ç™¼é€éƒµä»¶ï¼ˆåŒ¯æ¬¾æé†’ã€å…¥ä½æé†’ã€æ„Ÿè¬å…¥ä½ï¼‰å¾Œï¼Œä¸æœƒæ›´æ–° `email_sent` ç‹€æ…‹ã€‚

**å½±éŸ¿**ï¼š
- ç„¡æ³•è¿½è¹¤å“ªäº›éƒµä»¶å·²ç™¼é€
- å¯èƒ½é‡è¤‡ç™¼é€éƒµä»¶
- å¾Œå°ç„¡æ³•é¡¯ç¤ºå·²ç™¼é€çš„éƒµä»¶é¡å‹

**å»ºè­°è§£æ±ºæ–¹æ¡ˆ**ï¼š
- ä¿®æ”¹ `updateEmailStatus` å‡½æ•¸ï¼Œæ”¯æ´å­—ä¸²æ ¼å¼ï¼ˆå¤šéƒµä»¶é¡å‹ï¼‰
- å®šæ™‚ä»»å‹™ç™¼é€éƒµä»¶å¾Œï¼Œæ›´æ–° `email_sent` ç‹€æ…‹ï¼Œä¾‹å¦‚ï¼š
  ```javascript
  // ç™¼é€å…¥ä½æé†’å¾Œ
  await db.updateEmailStatus(booking.booking_id, 'booking_confirmation,checkin_reminder');
  ```

### 2. éƒµä»¶ç‹€æ…‹æ ¼å¼ä¸ä¸€è‡´

**å•é¡Œ**ï¼š
- å»ºç«‹è¨‚æˆ¿æ™‚ä½¿ç”¨æ•´æ•¸æ ¼å¼ï¼ˆ`0`/`1`ï¼‰
- å‰ç«¯é¡¯ç¤ºé‚è¼¯æ”¯æ´å­—ä¸²æ ¼å¼ï¼Œä½†å¾Œç«¯æ›´æ–°å‡½æ•¸ä¸æ”¯æ´

**å»ºè­°è§£æ±ºæ–¹æ¡ˆ**ï¼š
- çµ±ä¸€ä½¿ç”¨å­—ä¸²æ ¼å¼å„²å­˜éƒµä»¶é¡å‹
- ä¿®æ”¹ `updateEmailStatus` å‡½æ•¸ï¼Œæ”¯æ´è¿½åŠ éƒµä»¶é¡å‹

## ğŸ“š ç›¸é—œç¨‹å¼ç¢¼ä½ç½®

- **éƒµä»¶ç‹€æ…‹æ›´æ–°**ï¼š`database.js` ç¬¬ 1166-1179 è¡Œ
- **éƒµä»¶ç‹€æ…‹é¡¯ç¤º**ï¼š`admin.js` ç¬¬ 477-507 è¡Œ
- **å»ºç«‹è¨‚æˆ¿ç™¼é€éƒµä»¶**ï¼š`server.js` ç¬¬ 353-503 è¡Œ
- **åŒ¯æ¬¾æé†’å®šæ™‚ä»»å‹™**ï¼š`server.js` ç¬¬ 1656-1695 è¡Œ
- **å…¥ä½æé†’å®šæ™‚ä»»å‹™**ï¼š`server.js` ç¬¬ 1742-1774 è¡Œ
- **å›è¨ªä¿¡å®šæ™‚ä»»å‹™**ï¼š`server.js` ç¬¬ 1776-1808 è¡Œ
- **å®šæ™‚ä»»å‹™å•Ÿå‹•**ï¼š`server.js` ç¬¬ 1828-1843 è¡Œ

## ğŸ’¡ å»ºè­°æ”¹é€²

1. **æ”¯æ´å¤šéƒµä»¶é¡å‹è¿½è¹¤**
   - ä¿®æ”¹ `updateEmailStatus` å‡½æ•¸ï¼Œæ”¯æ´å­—ä¸²æ ¼å¼
   - å®šæ™‚ä»»å‹™ç™¼é€éƒµä»¶å¾Œï¼Œæ›´æ–°éƒµä»¶ç‹€æ…‹

2. **é˜²æ­¢é‡è¤‡ç™¼é€**
   - ç™¼é€éƒµä»¶å‰æª¢æŸ¥æ˜¯å¦å·²ç™¼é€éè©²é¡å‹éƒµä»¶
   - ä½¿ç”¨å­—ä¸²æ ¼å¼å„²å­˜å·²ç™¼é€çš„éƒµä»¶é¡å‹

3. **éƒµä»¶ç™¼é€è¨˜éŒ„**
   - å¯ä»¥è€ƒæ…®å»ºç«‹ç¨ç«‹çš„éƒµä»¶ç™¼é€è¨˜éŒ„è¡¨
   - è¨˜éŒ„æ¯æ¬¡éƒµä»¶ç™¼é€çš„æ™‚é–“ã€é¡å‹ã€çµæœ

