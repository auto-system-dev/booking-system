# 郵件呈現差異問題修復說明

## 📧 問題描述

系統自動發送的郵件和測試郵件的呈現方式不一樣：
- **系統自動發送郵件**：有深灰色標題欄、完整的樣式和結構
- **測試郵件**：格式較簡單，缺少樣式和結構

## 🔍 問題原因

### 1. 系統自動發送郵件

**使用函數**：`replaceTemplateVariables()`（`server.js` 第 4238 行）

**處理流程**：
1. 直接使用資料庫中的完整模板內容（`template.content`）
2. 模板包含完整的 HTML 結構：
   ```html
   <!DOCTYPE html>
   <html>
   <head>
       <meta charset="UTF-8">
       <style>
           .header { background: #262A33; color: white; ... }
           .content { background: #f9f9f9; ... }
           ...
       </style>
   </head>
   <body>
       <div class="container">
           <div class="header">...</div>
           <div class="content">...</div>
       </div>
   </body>
   </html>
   ```
3. 替換變數（`{{guestName}}`、`{{bookingId}}` 等）
4. 添加旅館資訊 footer
5. 直接發送

### 2. 測試郵件（修復前）

**使用函數**：`/api/email-templates/:key/test`（`server.js` 第 3787 行）

**問題**：
- 如果使用編輯器中的內容（`useEditorContent: true`），可能只包含 body 內容
- 編輯器可能只提取了內容部分，缺少完整的 HTML 結構和 CSS 樣式
- 導致測試郵件沒有深灰色標題欄和完整的樣式

**處理流程（修復前）**：
1. 取得內容（可能是編輯器中的部分內容）
2. 替換變數
3. 處理條件區塊
4. 添加旅館資訊 footer
5. 直接發送（可能缺少完整的 HTML 結構）

## ✅ 修復方案

### 修復內容

在 `server.js` 第 3853-3864 行，添加了檢查和修復邏輯：

```javascript
// 確保測試郵件包含完整的 HTML 結構
// 如果內容不包含完整的 HTML 結構（缺少 <!DOCTYPE html> 或 <html>），則包裝它
let testContent = content;

// 檢查是否包含完整的 HTML 結構
const hasFullHtmlStructure = testContent.includes('<!DOCTYPE html>') || 
                             (testContent.includes('<html>') && testContent.includes('</html>'));

if (!hasFullHtmlStructure) {
    // 如果沒有完整的 HTML 結構，嘗試從資料庫讀取原始模板
    const originalTemplate = await db.getEmailTemplateByKey(key);
    if (originalTemplate && originalTemplate.content) {
        // 使用原始模板的完整結構，但替換變數
        testContent = originalTemplate.content;
        console.log('⚠️ 測試郵件內容缺少完整 HTML 結構，使用資料庫中的完整模板');
    } else {
        // 如果無法取得原始模板，包裝現有內容為完整 HTML
        // ... 包裝邏輯 ...
    }
}
```

### 修復效果

1. **自動檢測**：檢查測試郵件內容是否包含完整的 HTML 結構
2. **自動修復**：如果缺少完整結構，自動使用資料庫中的完整模板
3. **向後兼容**：如果資料庫中沒有完整模板，會自動包裝為完整 HTML
4. **保持一致性**：確保測試郵件和系統自動發送郵件使用相同的結構和樣式

## 🧪 測試建議

### 測試步驟

1. **測試使用編輯器內容的郵件**：
   - 在後台編輯郵件模板
   - 點擊「發送測試郵件」
   - 確認郵件有完整的樣式（深灰色標題欄等）

2. **測試使用資料庫模板的郵件**：
   - 不修改編輯器內容
   - 直接點擊「發送測試郵件」
   - 確認郵件有完整的樣式

3. **對比系統自動發送郵件**：
   - 等待系統自動發送入住提醒郵件
   - 對比測試郵件和自動發送郵件的樣式
   - 確認兩者一致

### 預期結果

- ✅ 測試郵件應該有深灰色標題欄（`.header { background: #262A33; }`）
- ✅ 測試郵件應該有完整的樣式和結構
- ✅ 測試郵件和系統自動發送郵件的呈現方式應該一致

## 📝 相關代碼位置

- **測試郵件 API**：`server.js` 第 3787-3907 行
- **系統自動發送郵件**：`server.js` 第 4238-4341 行（`replaceTemplateVariables`）
- **郵件模板預設內容**：`database.js` 第 631-827 行

## 💡 注意事項

1. **編輯器內容**：如果編輯器只提取了部分內容，修復會自動使用資料庫中的完整模板
2. **日誌訊息**：如果檢測到缺少完整結構，會在控制台輸出警告訊息
3. **向後兼容**：即使資料庫中沒有完整模板，也會自動包裝為完整 HTML

## 🔗 相關文件

- `郵件狀態邏輯說明.md` - 郵件發送邏輯說明
- `郵件發送邏輯完整說明.md` - 完整的郵件發送邏輯
