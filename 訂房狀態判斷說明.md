# è¨‚æˆ¿ç‹€æ…‹åˆ¤æ–·èªªæ˜

## è¨‚æˆ¿ç‹€æ…‹é¡å‹

ç³»çµ±ä¸­æœ‰ä¸‰ç¨®è¨‚æˆ¿ç‹€æ…‹ï¼š

1. **`active`** (æœ‰æ•ˆ) - æ­£å¸¸æœ‰æ•ˆçš„è¨‚æˆ¿
2. **`reserved`** (ä¿ç•™) - åŒ¯æ¬¾è½‰å¸³çš„è¨‚æˆ¿ï¼Œåœ¨ä¿ç•™æœŸé–“å…§
3. **`cancelled`** (å·²å–æ¶ˆ) - å·²å–æ¶ˆçš„è¨‚æˆ¿

## ç‹€æ…‹åˆ¤æ–·é‚è¼¯

### 1. æ–°è¨‚æˆ¿æ™‚ï¼ˆ`POST /api/booking`ï¼‰

**ä½ç½®ï¼š** `server.js` ç¬¬ 214-229 è¡Œ

```javascript
// åˆ¤æ–·ä»˜æ¬¾ç‹€æ…‹
let paymentStatus = 'pending';
if (paymentMethod === 'card') {
    paymentStatus = 'pending'; // åˆ·å¡éœ€è¦ç­‰å¾…ä»˜æ¬¾å®Œæˆ
} else if (paymentMethod === 'transfer') {
    paymentStatus = 'pending'; // åŒ¯æ¬¾ä¹Ÿéœ€è¦ç­‰å¾…ç¢ºèª
}

await db.saveBooking({
    ...bookingData,
    emailSent: emailSent,
    paymentStatus: paymentStatus,
    status: 'active'  // âš ï¸ ç›®å‰æ‰€æœ‰æ–°è¨‚æˆ¿éƒ½æ˜¯ 'active'
});
```

**ç›®å‰è¡Œç‚ºï¼š**
- ç„¡è«–æ˜¯ã€Œç·šä¸Šåˆ·å¡ã€é‚„æ˜¯ã€ŒåŒ¯æ¬¾è½‰å¸³ã€ï¼Œæ–°è¨‚æˆ¿çš„ç‹€æ…‹éƒ½æ˜¯ `'active'`
- ä»˜æ¬¾ç‹€æ…‹éƒ½æ˜¯ `'pending'`

**é æœŸè¡Œç‚ºï¼ˆæ ¹æ“šéœ€æ±‚ï¼‰ï¼š**
- å¦‚æœæ˜¯ã€ŒåŒ¯æ¬¾è½‰å¸³ã€ï¼Œè¨‚æˆ¿ç‹€æ…‹æ‡‰è©²æ˜¯ `'reserved'`ï¼ˆä¿ç•™ï¼‰
- å¦‚æœæ˜¯ã€Œç·šä¸Šåˆ·å¡ã€ï¼Œè¨‚æˆ¿ç‹€æ…‹æ‡‰è©²æ˜¯ `'active'`

---

### 2. æ›´æ–°è¨‚æˆ¿æ™‚ï¼ˆ`PUT /api/bookings/:bookingId`ï¼‰

**ä½ç½®ï¼š** `server.js` ç¬¬ 561-589 è¡Œ

```javascript
app.put('/api/bookings/:bookingId', async (req, res) => {
    try {
        const { bookingId } = req.params;
        const updateData = req.body;
        
        const result = await db.updateBooking(bookingId, updateData);
        // âš ï¸ ç›®å‰æ²’æœ‰è‡ªå‹•æª¢æŸ¥ä»˜æ¬¾ç‹€æ…‹ä¸¦æ›´æ–°è¨‚æˆ¿ç‹€æ…‹çš„é‚è¼¯
    } catch (error) {
        // ...
    }
});
```

**ç›®å‰è¡Œç‚ºï¼š**
- ç›´æ¥æ›´æ–°å‚³å…¥çš„è³‡æ–™ï¼Œæ²’æœ‰è‡ªå‹•åˆ¤æ–·é‚è¼¯

**é æœŸè¡Œç‚ºï¼ˆæ ¹æ“šéœ€æ±‚ï¼‰ï¼š**
- å¦‚æœä»˜æ¬¾æ–¹å¼ç‚ºã€ŒåŒ¯æ¬¾è½‰å¸³ã€(`payment_method` åŒ…å«ã€ŒåŒ¯æ¬¾ã€æˆ–ã€Œè½‰å¸³ã€)
- ä¸”ä»˜æ¬¾ç‹€æ…‹è®Šç‚º `'paid'`ï¼ˆå·²ä»˜æ¬¾ï¼‰
- ä¸”è¨‚æˆ¿ç‹€æ…‹ç‚º `'reserved'`ï¼ˆä¿ç•™ï¼‰
- å‰‡è‡ªå‹•å°‡è¨‚æˆ¿ç‹€æ…‹æ”¹ç‚º `'active'`ï¼ˆæœ‰æ•ˆï¼‰

---

### 3. ç¶ ç•Œä»˜æ¬¾å®Œæˆæ™‚ï¼ˆ`handlePaymentResult`ï¼‰

**ä½ç½®ï¼š** `server.js` ç¬¬ 1017-1032 è¡Œ

```javascript
if (paymentResult.rtnCode === '1') {
    // ä»˜æ¬¾æˆåŠŸ - æ›´æ–°è³‡æ–™åº«ä¸­çš„ä»˜æ¬¾ç‹€æ…‹
    try {
        const bookingId = paymentResult.merchantTradeNo;
        console.log('âœ… ä»˜æ¬¾æˆåŠŸï¼Œæ›´æ–°è¨‚æˆ¿è¨˜éŒ„:', bookingId);
        
        // æ›´æ–°ä»˜æ¬¾ç‹€æ…‹ç‚ºå·²ä»˜æ¬¾
        await db.updateBooking(bookingId, {
            payment_status: 'paid'
        });
        
        console.log('âœ… ä»˜æ¬¾ç‹€æ…‹å·²æ›´æ–°ç‚ºã€Œå·²ä»˜æ¬¾ã€');
    } catch (updateError) {
        // ...
    }
}
```

**ç›®å‰è¡Œç‚ºï¼š**
- åªæ›´æ–°ä»˜æ¬¾ç‹€æ…‹ç‚º `'paid'`
- æ²’æœ‰æª¢æŸ¥æˆ–æ›´æ–°è¨‚æˆ¿ç‹€æ…‹

**é æœŸè¡Œç‚ºï¼š**
- ç·šä¸Šåˆ·å¡ä»˜æ¬¾æˆåŠŸå¾Œï¼Œè¨‚æˆ¿ç‹€æ…‹æ‡‰è©²ä¿æŒæˆ–æ›´æ–°ç‚º `'active'`

---

### 4. å–æ¶ˆè¨‚æˆ¿æ™‚ï¼ˆ`POST /api/bookings/:bookingId/cancel`ï¼‰

**ä½ç½®ï¼š** `server.js` ç¬¬ 638-650 è¡Œ

```javascript
app.post('/api/bookings/:bookingId/cancel', async (req, res) => {
    try {
        const { bookingId } = req.params;
        console.log('ğŸš« æ”¶åˆ°å–æ¶ˆè¨‚æˆ¿è«‹æ±‚ï¼Œè¨‚æˆ¿ç·¨è™Ÿ:', bookingId);
        
        const result = await db.cancelBooking(bookingId);
        // âœ… æ­£å¸¸é‹ä½œï¼šå°‡ç‹€æ…‹æ”¹ç‚º 'cancelled'
    } catch (error) {
        // ...
    }
});
```

**ç›®å‰è¡Œç‚ºï¼š**
- âœ… æ­£å¸¸é‹ä½œï¼šç›´æ¥å°‡è¨‚æˆ¿ç‹€æ…‹æ”¹ç‚º `'cancelled'`

---

### 5. åˆªé™¤è¨‚æˆ¿æ™‚ï¼ˆ`DELETE /api/bookings/:bookingId`ï¼‰

**ä½ç½®ï¼š** `server.js` ç¬¬ 593-636 è¡Œ

```javascript
app.delete('/api/bookings/:bookingId', async (req, res) => {
    try {
        // å…ˆæª¢æŸ¥è¨‚æˆ¿ç‹€æ…‹ï¼Œåªæœ‰å·²å–æ¶ˆçš„æ‰èƒ½åˆªé™¤
        const booking = await db.getBookingById(bookingId);
        
        if (booking.status !== 'cancelled') {
            return res.status(400).json({
                success: false,
                message: 'åªèƒ½åˆªé™¤å·²å–æ¶ˆçš„è¨‚æˆ¿è¨˜éŒ„'
            });
        }
        // âœ… æ­£å¸¸é‹ä½œï¼šåªæœ‰ 'cancelled' ç‹€æ…‹æ‰èƒ½åˆªé™¤
    } catch (error) {
        // ...
    }
});
```

**ç›®å‰è¡Œç‚ºï¼š**
- âœ… æ­£å¸¸é‹ä½œï¼šåªæœ‰ `'cancelled'` ç‹€æ…‹çš„è¨‚æˆ¿æ‰èƒ½åˆªé™¤

---

### 6. è‡ªå‹•å–æ¶ˆéæœŸä¿ç•™ï¼ˆå®šæ™‚ä»»å‹™ï¼‰

**ä½ç½®ï¼š** `server.js` ç¬¬ 1488 è¡Œï¼ˆæ‡‰è©²æœ‰ `cancelExpiredReservations` å‡½æ•¸ï¼‰

**é æœŸè¡Œç‚ºï¼š**
- æ¯å¤©æª¢æŸ¥ä¿ç•™æœŸé–“å·²éæœŸçš„è¨‚æˆ¿
- å¦‚æœè¨‚æˆ¿ç‹€æ…‹ç‚º `'reserved'` ä¸”ä»˜æ¬¾ç‹€æ…‹ç‚º `'pending'`
- ä¸”ä¿ç•™æœŸé–“å·²éæœŸï¼Œå‰‡è‡ªå‹•å°‡ç‹€æ…‹æ”¹ç‚º `'cancelled'`

---

## å•é¡Œç¸½çµ

### âŒ ç›®å‰ç¼ºå°‘çš„é‚è¼¯ï¼š

1. **æ–°è¨‚æˆ¿æ™‚ï¼ŒåŒ¯æ¬¾è½‰å¸³æ‡‰è©²è¨­ç‚º `'reserved'`**
   - ç›®å‰æ‰€æœ‰æ–°è¨‚æˆ¿éƒ½æ˜¯ `'active'`
   - æ‡‰è©²æ ¹æ“šä»˜æ¬¾æ–¹å¼åˆ¤æ–·ï¼šåŒ¯æ¬¾è½‰å¸³ â†’ `'reserved'`ï¼Œç·šä¸Šåˆ·å¡ â†’ `'active'`

2. **æ›´æ–°è¨‚æˆ¿æ™‚ï¼Œä»˜æ¬¾ç‹€æ…‹è®Šç‚º `'paid'` æ‡‰è©²è‡ªå‹•æ›´æ–°ç‹€æ…‹**
   - å¦‚æœä»˜æ¬¾æ–¹å¼ç‚ºã€ŒåŒ¯æ¬¾è½‰å¸³ã€ä¸”ç‹€æ…‹ç‚º `'reserved'`
   - ç•¶ä»˜æ¬¾ç‹€æ…‹è®Šç‚º `'paid'` æ™‚ï¼Œæ‡‰è©²è‡ªå‹•å°‡ç‹€æ…‹æ”¹ç‚º `'active'`

3. **ç¶ ç•Œä»˜æ¬¾å®Œæˆæ™‚ï¼Œæ‡‰è©²ç¢ºä¿ç‹€æ…‹ç‚º `'active'`**
   - ç·šä¸Šåˆ·å¡ä»˜æ¬¾æˆåŠŸå¾Œï¼Œæ‡‰è©²ç¢ºä¿è¨‚æˆ¿ç‹€æ…‹ç‚º `'active'`

---

## å»ºè­°ä¿®æ­£

### ä¿®æ­£ 1ï¼šæ–°è¨‚æˆ¿æ™‚æ ¹æ“šä»˜æ¬¾æ–¹å¼è¨­å®šç‹€æ…‹

```javascript
// åˆ¤æ–·ä»˜æ¬¾ç‹€æ…‹å’Œè¨‚æˆ¿ç‹€æ…‹
let paymentStatus = 'pending';
let bookingStatus = 'active'; // é è¨­ç‚ºæœ‰æ•ˆ

if (paymentMethod === 'card') {
    paymentStatus = 'pending'; // åˆ·å¡éœ€è¦ç­‰å¾…ä»˜æ¬¾å®Œæˆ
    bookingStatus = 'active'; // ç·šä¸Šåˆ·å¡é è¨­ç‚ºæœ‰æ•ˆ
} else if (paymentMethod === 'transfer') {
    paymentStatus = 'pending'; // åŒ¯æ¬¾ä¹Ÿéœ€è¦ç­‰å¾…ç¢ºèª
    bookingStatus = 'reserved'; // åŒ¯æ¬¾è½‰å¸³è¨­ç‚ºä¿ç•™
}

await db.saveBooking({
    ...bookingData,
    emailSent: emailSent,
    paymentStatus: paymentStatus,
    status: bookingStatus  // ä½¿ç”¨åˆ¤æ–·å¾Œçš„ç‹€æ…‹
});
```

### ä¿®æ­£ 2ï¼šæ›´æ–°è¨‚æˆ¿æ™‚è‡ªå‹•æª¢æŸ¥ä¸¦æ›´æ–°ç‹€æ…‹

```javascript
app.put('/api/bookings/:bookingId', async (req, res) => {
    try {
        const { bookingId } = req.params;
        const updateData = req.body;
        
        // å¦‚æœä»˜æ¬¾ç‹€æ…‹è®Šç‚º 'paid'ï¼Œæª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°è¨‚æˆ¿ç‹€æ…‹
        if (updateData.payment_status === 'paid') {
            // å…ˆå–å¾—ç›®å‰çš„è¨‚æˆ¿è³‡æ–™
            const currentBooking = await db.getBookingById(bookingId);
            
            if (currentBooking) {
                // æª¢æŸ¥ä»˜æ¬¾æ–¹å¼æ˜¯å¦ç‚ºåŒ¯æ¬¾è½‰å¸³
                const isTransfer = currentBooking.payment_method && 
                    (currentBooking.payment_method.includes('åŒ¯æ¬¾') || 
                     currentBooking.payment_method.includes('è½‰å¸³'));
                
                // å¦‚æœä»˜æ¬¾æ–¹å¼ç‚ºåŒ¯æ¬¾è½‰å¸³ï¼Œä¸”ç›®å‰ç‹€æ…‹ç‚º 'reserved'ï¼Œå‰‡æ”¹ç‚º 'active'
                if (isTransfer && currentBooking.status === 'reserved') {
                    updateData.status = 'active';
                    console.log('âœ… åŒ¯æ¬¾å·²ç¢ºèªï¼Œè‡ªå‹•å°‡è¨‚æˆ¿ç‹€æ…‹å¾ã€Œä¿ç•™ã€æ”¹ç‚ºã€Œæœ‰æ•ˆã€');
                }
            }
        }
        
        const result = await db.updateBooking(bookingId, updateData);
        // ...
    } catch (error) {
        // ...
    }
});
```

### ä¿®æ­£ 3ï¼šç¶ ç•Œä»˜æ¬¾å®Œæˆæ™‚ç¢ºä¿ç‹€æ…‹ç‚º 'active'

```javascript
if (paymentResult.rtnCode === '1') {
    try {
        const bookingId = paymentResult.merchantTradeNo;
        console.log('âœ… ä»˜æ¬¾æˆåŠŸï¼Œæ›´æ–°è¨‚æˆ¿è¨˜éŒ„:', bookingId);
        
        // æ›´æ–°ä»˜æ¬¾ç‹€æ…‹ç‚ºå·²ä»˜æ¬¾ï¼Œä¸¦ç¢ºä¿è¨‚æˆ¿ç‹€æ…‹ç‚ºæœ‰æ•ˆ
        await db.updateBooking(bookingId, {
            payment_status: 'paid',
            status: 'active'  // ç·šä¸Šåˆ·å¡ä»˜æ¬¾æˆåŠŸï¼Œç¢ºä¿ç‹€æ…‹ç‚ºæœ‰æ•ˆ
        });
        
        console.log('âœ… ä»˜æ¬¾ç‹€æ…‹å·²æ›´æ–°ç‚ºã€Œå·²ä»˜æ¬¾ã€ï¼Œè¨‚æˆ¿ç‹€æ…‹å·²æ›´æ–°ç‚ºã€Œæœ‰æ•ˆã€');
    } catch (updateError) {
        // ...
    }
}
```

---

## è³‡æ–™åº«æŸ¥è©¢ç›¸é—œ

### æŸ¥è©¢ä¿ç•™æœŸé–“çš„è¨‚æˆ¿

**ä½ç½®ï¼š** `database.js` ç¬¬ 1074-1096 è¡Œ

```javascript
async function getBookingsForPaymentReminder(daysReserved = 3) {
    // æŸ¥è©¢æ¢ä»¶åŒ…å«ï¼š
    // - ä»˜æ¬¾æ–¹å¼ç‚ºåŒ¯æ¬¾è½‰å¸³
    // - ä»˜æ¬¾ç‹€æ…‹ç‚º 'pending'
    // - è¨‚æˆ¿ç‹€æ…‹ç‚º 'active' æˆ– 'reserved'  // âš ï¸ é€™è£¡æŸ¥è©¢å…©ç¨®ç‹€æ…‹
    // - å»ºç«‹æ—¥æœŸç‚º N å¤©å‰
}
```

**èªªæ˜ï¼š**
- é€™å€‹æŸ¥è©¢åŒæ™‚åŒ…å« `'active'` å’Œ `'reserved'` ç‹€æ…‹
- å¦‚æœæ–°è¨‚æˆ¿æ™‚åŒ¯æ¬¾è½‰å¸³æ‡‰è©²è¨­ç‚º `'reserved'`ï¼Œé€™å€‹æŸ¥è©¢é‚è¼¯æ˜¯æ­£ç¢ºçš„

---

## ç¸½çµ

ç›®å‰ç³»çµ±çš„è¨‚æˆ¿ç‹€æ…‹åˆ¤æ–·é‚è¼¯**ä¸å®Œæ•´**ï¼Œç¼ºå°‘ä»¥ä¸‹åŠŸèƒ½ï¼š

1. âŒ æ–°è¨‚æˆ¿æ™‚ï¼ŒåŒ¯æ¬¾è½‰å¸³æ‡‰è©²è¨­ç‚º `'reserved'`ï¼ˆç›®å‰éƒ½æ˜¯ `'active'`ï¼‰
2. âŒ æ›´æ–°è¨‚æˆ¿æ™‚ï¼ŒåŒ¯æ¬¾è½‰å¸³ä»˜æ¬¾ç‹€æ…‹è®Šç‚º `'paid'` æ™‚ï¼Œæ‡‰è©²è‡ªå‹•å°‡ `'reserved'` æ”¹ç‚º `'active'`
3. âš ï¸ ç¶ ç•Œä»˜æ¬¾å®Œæˆæ™‚ï¼Œæ‡‰è©²ç¢ºä¿ç‹€æ…‹ç‚º `'active'`ï¼ˆç›®å‰åªæ›´æ–°ä»˜æ¬¾ç‹€æ…‹ï¼‰

å»ºè­°æŒ‰ç…§ä¸Šè¿°ä¿®æ­£æ–¹æ¡ˆé€²è¡Œæ›´æ–°ï¼Œä»¥ç¬¦åˆæ¥­å‹™éœ€æ±‚ã€‚

