# 訂房狀態判斷說明

## 📋 訂房狀態類型

系統中有三種訂房狀態：

| 狀態值 | 顯示名稱 | 說明 | 樣式 |
|--------|---------|------|------|
| `active` | 有效 | 訂房已確認，正常有效 | 綠色標籤 |
| `reserved` | 保留 | 訂房已建立，等待付款確認 | 黃色標籤 |
| `cancelled` | 已取消 | 訂房已取消 | 紅色標籤 |

## 🔄 狀態轉換流程

### 1. 建立訂房時的初始狀態

當客戶提交訂房表單時，系統會根據付款方式設定初始狀態：

```javascript
// 位置：server.js (481-491行)

if (paymentMethod === 'card') {
    paymentStatus = 'pending';  // 付款狀態：待付款
    bookingStatus = 'reserved'; // 訂房狀態：保留
} else if (paymentMethod === 'transfer') {
    paymentStatus = 'pending';  // 付款狀態：待付款
    bookingStatus = 'reserved'; // 訂房狀態：保留（保留3天）
}
```

**規則**：
- ✅ **線上刷卡**：初始狀態為 `reserved`（保留）
- ✅ **匯款轉帳**：初始狀態為 `reserved`（保留，預設保留3天）

### 2. 付款完成後的狀態更新

#### 線上刷卡付款完成

當綠界支付完成並回傳成功時：

```javascript
// 位置：server.js (1376-1378行)

await db.updateBooking(bookingId, {
    payment_status: 'paid'  // 只更新付款狀態，訂房狀態保持 reserved
});
```

**注意**：付款完成後，**只更新付款狀態為 `paid`**，**訂房狀態仍保持 `reserved`**。

#### 匯款轉帳付款完成

當管理員在後台手動更新付款狀態為「已付款」時：

```javascript
// 位置：server.js (879-895行)

app.put('/api/bookings/:bookingId', async (req, res) => {
    // 管理員可以手動更新付款狀態
    await db.updateBooking(bookingId, {
        payment_status: 'paid'
    });
});
```

**注意**：手動更新付款狀態時，**訂房狀態不會自動變更**。

### 3. 訂房狀態的手動更新

管理員可以在後台「編輯訂房」中手動修改訂房狀態：

- 可以將 `reserved` 改為 `active`（確認訂房）
- 可以將 `active` 或 `reserved` 改為 `cancelled`（取消訂房）

### 4. 自動取消過期保留訂房

系統有定時任務，每天凌晨 1:00 自動檢查並取消過期的保留訂房：

```javascript
// 位置：server.js (1686-1729行)

async function cancelExpiredReservations() {
    // 1. 取得所有保留狀態的訂房
    const bookings = await db.getBookingsExpiredReservation();
    
    // 2. 取得保留天數（預設3天，可在郵件模板中設定）
    let daysReserved = 3; // 從 payment_reminder 模板取得
    
    // 3. 計算保留到期日期
    const deadline = new Date(bookingDate);
    deadline.setDate(deadline.getDate() + daysReserved);
    
    // 4. 如果超過保留期限，自動取消
    if (now > deadline) {
        await db.cancelBooking(booking.booking_id);
        // 狀態變更為 'cancelled'
    }
}
```

**規則**：
- ⏰ 每天凌晨 1:00 執行
- 📅 計算方式：訂房建立日期 + 保留天數（預設3天）
- ⚠️ 只會取消 `reserved` 狀態且付款狀態為 `pending` 的訂房
- ✅ 取消後狀態變更為 `cancelled`

## 📊 狀態判斷邏輯圖

```
建立訂房
    ↓
[reserved] 保留狀態
    ↓
    ├─→ 付款完成（線上刷卡）
    │   └─→ payment_status = 'paid'
    │       status 仍為 'reserved'（需手動確認）
    │
    ├─→ 付款完成（匯款轉帳，手動更新）
    │   └─→ payment_status = 'paid'
    │       status 仍為 'reserved'（需手動確認）
    │
    ├─→ 管理員手動確認
    │   └─→ status = 'active'（有效）
    │
    └─→ 超過保留期限（自動取消）
        └─→ status = 'cancelled'（已取消）
```

## 🔍 狀態查詢

### 查詢保留狀態的訂房

```javascript
// 位置：database.js (1703-1720行)

async function getBookingsExpiredReservation() {
    // 查詢條件：
    // - status = 'reserved'（保留狀態）
    // - payment_status = 'pending'（待付款）
}
```

### 查詢所有訂房記錄

```javascript
// 位置：database.js (1182-1191行)

async function getAllBookings() {
    // 返回所有訂房記錄（包括所有狀態）
}
```

## ⚙️ 狀態更新方式

### 1. 自動更新

- **自動取消**：定時任務每天凌晨 1:00 檢查並取消過期保留訂房

### 2. 手動更新

- **後台編輯**：管理員可以在「訂房記錄管理」中編輯訂房，修改狀態
- **取消訂房**：管理員可以點擊「取消」按鈕，將狀態改為 `cancelled`

### 3. 付款完成更新

- **線上刷卡**：付款完成後自動更新 `payment_status = 'paid'`
- **匯款轉帳**：管理員手動更新 `payment_status = 'paid'`

**重要**：付款完成後，**訂房狀態不會自動變更為 `active`**，需要管理員手動確認。

## 📝 狀態欄位說明

### 付款狀態（payment_status）

| 狀態值 | 說明 |
|--------|------|
| `pending` | 待付款 |
| `paid` | 已付款 |
| `failed` | 付款失敗 |
| `refunded` | 已退款 |

### 訂房狀態（status）

| 狀態值 | 說明 | 何時設定 |
|--------|------|---------|
| `active` | 有效 | 管理員手動確認 |
| `reserved` | 保留 | 建立訂房時自動設定 |
| `cancelled` | 已取消 | 管理員取消或自動取消過期訂房 |

## 💡 建議工作流程

### 線上刷卡訂房

1. 客戶提交訂房 → 狀態：`reserved`，付款狀態：`pending`
2. 客戶完成付款 → 付款狀態：`paid`，狀態仍為：`reserved`
3. 管理員確認訂房 → 狀態：`active`

### 匯款轉帳訂房

1. 客戶提交訂房 → 狀態：`reserved`，付款狀態：`pending`
2. 客戶完成匯款 → 管理員更新付款狀態：`paid`，狀態仍為：`reserved`
3. 管理員確認訂房 → 狀態：`active`
4. 如果超過保留期限未付款 → 自動取消，狀態：`cancelled`

## 🔧 相關設定

### 保留天數設定

保留天數可以在「郵件模板」→「匯款提醒」中設定：

- 欄位：`days_reserved`
- 預設值：3 天
- 說明：匯款轉帳訂房的保留期限

### 定時任務設定

自動取消任務的執行時間：

```javascript
// 位置：server.js (1830-1832行)

// 每天凌晨 1:00 執行
cron.schedule('0 1 * * *', cancelExpiredReservations);
```

## 📚 相關程式碼位置

- **狀態初始設定**：`server.js` 第 481-491 行
- **付款完成更新**：`server.js` 第 1376-1378 行
- **取消訂房**：`database.js` 第 1280-1296 行
- **自動取消任務**：`server.js` 第 1686-1729 行
- **狀態顯示**：`admin.js` 第 457-475 行

