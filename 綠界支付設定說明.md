# 綠界支付整合說明

## 📋 功能說明

系統已整合綠界科技（ECPay）的線上刷卡服務，當客戶選擇「線上刷卡」時，會自動導向綠界支付頁面完成付款。

## 🔧 設定步驟

### 1. 取得綠界測試環境資訊

**測試環境設定（預設）：**
- 商店代號（MerchantID）：`2000132`
- HashKey：`5294y06JbISpM5x9`
- HashIV：`v77hoKGq4kWxNNIS`

這些是綠界提供的測試環境設定，已經預設在系統中。

### 2. 設定環境變數（選填）

如果需要使用自己的測試帳號，可以在 `.env` 檔案中設定：

```env
# 綠界測試環境
ECPAY_MERCHANT_ID=2000132
ECPAY_HASH_KEY=5294y06JbISpM5x9
ECPAY_HASH_IV=v77hoKGq4kWxNNIS

# 回傳網址（可選，預設為 localhost:3000）
ECPAY_RETURN_URL=http://localhost:3000/api/payment/return
ECPAY_ORDER_RESULT_URL=http://localhost:3000/api/payment/result
ECPAY_CLIENT_BACK_URL=http://localhost:3000
```

### 3. 正式環境設定

上線時，需要：

1. **申請綠界正式商店帳號**
   - 前往：https://www.ecpay.com.tw/
   - 註冊並申請商店帳號

2. **取得正式環境資訊**
   - 登入綠界商店後台
   - 取得正式環境的 MerchantID、HashKey、HashIV

3. **更新環境變數（Railway 部署）**
   
   在 Railway 專案的環境變數設定中，添加以下變數：
   
   ```env
   NODE_ENV=production
   ECPAY_MERCHANT_ID_PROD=您的正式商店代號
   ECPAY_HASH_KEY_PROD=您的正式HashKey
   ECPAY_HASH_IV_PROD=您的正式HashIV
   ```
   
   **Railway 設定步驟：**
   1. 登入 Railway 後台
   2. 選擇您的專案
   3. 進入「Variables」頁籤
   4. 點擊「+ New Variable」
   5. 依序添加上述環境變數
   6. 儲存後，Railway 會自動重新部署
   
   **注意：** 如果沒有設定 `ECPAY_MERCHANT_ID_PROD`，系統會自動使用資料庫中的設定（可在管理後台的「系統設定」中設定）。

## 🧪 測試流程

### 測試信用卡號

綠界測試環境提供的測試卡號：

- **信用卡號**：`4311-9522-2222-2222`
- **安全碼**：`222`
- **有效期限**：設定為未來的日期（例如：12/25）

### 測試步驟

1. **啟動伺服器**
   ```powershell
   & "C:\Program Files\nodejs\node.exe" server.js
   ```

2. **填寫訂房表單**
   - 選擇「線上刷卡」付款方式
   - 填寫其他必填欄位
   - 提交表單

3. **導向支付頁面**
   - 系統會自動導向綠界支付頁面
   - 使用測試卡號完成付款

4. **付款完成**
   - 付款成功後會導回系統
   - 顯示付款成功頁面

## 📊 支付流程

```
客戶提交訂房
    ↓
選擇「線上刷卡」
    ↓
系統建立訂單
    ↓
導向綠界支付頁面
    ↓
客戶完成付款
    ↓
綠界回傳付款結果
    ↓
系統更新訂單狀態
    ↓
顯示付款成功頁面
```

## 🔌 API 端點

### 1. 建立支付表單

```
POST /api/payment/create
```

**請求資料：**
```json
{
  "bookingId": "BK1765202639511"
}
```

**回應：**
```json
{
  "success": true,
  "data": {
    "actionUrl": "https://payment-stage.ecpay.com.tw/...",
    "params": {
      "MerchantID": "...",
      "MerchantTradeNo": "...",
      ...
    }
  }
}
```

### 2. 付款完成回傳（Server POST）

```
POST /api/payment/return
```

綠界會自動 POST 付款結果到此端點。

### 3. 付款完成導向（Client Redirect）

```
GET /api/payment/result
```

付款完成後，客戶會被導向此頁面。

## 📝 資料庫記錄

目前系統會：
- ✅ 儲存訂房資料
- ✅ 記錄付款方式
- ⚠️ 付款狀態需要額外欄位（可選）

如果需要記錄付款狀態，可以在資料庫中新增 `payment_status` 欄位。

## ⚠️ 注意事項

1. **測試環境限制**
   - 測試環境不會真的扣款
   - 僅用於開發測試

2. **正式環境**
   - 必須申請正式商店帳號
   - 需要通過綠界審核
   - 設定正確的回傳網址

3. **安全性**
   - 不要將 HashKey 和 HashIV 提交到公開程式碼
   - 使用環境變數管理敏感資訊
   - 確保回傳資料驗證正確

4. **回傳網址**
   - 測試環境可以使用 localhost
   - 正式環境必須使用 HTTPS
   - 需要在綠界後台設定允許的回傳網址

## 🔍 除錯

### 查看日誌

付款相關的日誌會顯示在終端機：

```
📥 收到綠界付款回傳
時間: [時間]
回傳資料: {...}
付款結果: {...}
```

### 常見問題

**問題：無法導向支付頁面**
- 檢查環境變數設定
- 確認 MerchantID、HashKey、HashIV 正確

**問題：付款驗證失敗**
- 檢查 CheckMacValue 計算是否正確
- 確認回傳資料格式

**問題：無法接收回傳**
- 檢查回傳網址設定
- 確認伺服器可以接收 POST 請求

**問題：使用正式環境參數也收不到簡訊驗證碼**
- **可能原因**：
  1. **簡訊發送次數限制（最常見原因）**：
     - ⚠️ **重要**：根據綠界科技官方說明，在綠界平台進行簡訊驗證（包括測試或正式環境），**同一手機號碼一天（24小時內）最多只能發送5次**
     - 若超過5次，會被限制，需要等到隔日才能再嘗試發送驗證碼
     - 這是為了防止惡意程式或人為重複發送，確保系統穩定與帳戶安全
     - **解決方案**：
       - 耐心等待：請於24小時後再試
       - 使用其他手機號碼進行測試
       - 改用不需要簡訊驗證的付款方式（如 ATM、超商代碼等）
  2. **手機號碼問題**：
     - 手機號碼非台灣地區號碼（綠界簡訊服務主要支援台灣地區）
     - 手機號碼輸入錯誤
     - 手機號碼格式不正確（應為 09XXXXXXXX）
  2. **簡訊服務問題**：
     - 簡訊發送延遲（通常需要 1-2 分鐘）
     - 簡訊被電信業者過濾或阻擋
     - 手機訊號不佳或收訊問題
     - 手機設定阻擋簡訊
  3. **綠界後台設定問題**：
     - 3D 驗證設定可能有問題
     - 簡訊服務未正確啟用
     - 商店帳號權限設定問題
  4. **環境問題**：
     - 雖然使用正式環境參數，但簡訊服務可能仍有限制
     - 某些銀行或卡片類型可能強制要求 3D 驗證
- **解決方案**：
  
    **方案 A：檢查簡訊發送次數限制（最優先處理）** ⚠️
  
  根據綠界科技官方說明，**同一手機號碼一天（24小時內）最多只能發送5次簡訊驗證碼**：
  
  1. **確認是否超過限制**：
     - 檢查該手機號碼在過去24小時內是否已發送超過5次簡訊
     - 如果超過，會被限制，需要等到隔日才能再嘗試
  
  2. **解決方案**：
     - **等待24小時後再試**：這是唯一的方法，無法提前解除限制
     - **使用其他手機號碼**：如果急需測試，可以使用其他未超過限制的手機號碼
     - **改用不需要簡訊驗證的付款方式**：設定 `ECPAY_CHOOSE_PAYMENT=ATM` 或其他方式
  
  3. **為什麼會有這個限制**：
     - 這是為了防止惡意程式或人為重複發送
     - 確保系統穩定與帳戶安全
     - 適用於測試環境和正式環境
  
  **方案 B：檢查並修正手機號碼**
  1. 確認手機號碼格式正確：`09XXXXXXXX`（10 位數字）
  2. 確認手機號碼為台灣地區號碼
  3. 檢查手機號碼是否輸入錯誤
  
  **方案 C：檢查手機和電信設定**
  1. 確認手機未開啟簡訊阻擋功能
  2. 檢查垃圾簡訊資料夾
  3. 確認手機訊號正常
  4. 嘗試使用其他手機號碼測試
  
  **方案 D：檢查綠界後台設定**
  1. 登入綠界商店後台：https://vendor.ecpay.com.tw/
  2. 進入「系統開發管理」→「系統介接設定」
  3. 檢查「信用卡 3D 驗證」設定：
     - 確認 3D 驗證是否已啟用
     - 檢查簡訊服務設定是否正常
  4. 檢查「付款方式設定」：
     - 確認信用卡付款方式已啟用
     - 檢查是否有其他限制設定
  
  **方案 E：改用不需要簡訊驗證的付款方式（推薦）**
  
  如果簡訊驗證持續有問題，建議改用不需要簡訊驗證的付款方式：
  
  1. **在 Railway 環境變數中設定**：
     ```
     ECPAY_CHOOSE_PAYMENT=ATM
     ```
     或使用其他方式：
     - `ATM`：ATM 虛擬帳號（客戶到 ATM 轉帳）
     - `CVS`：超商代碼（客戶到超商繳費）
     - `BARCODE`：超商條碼（客戶到超商掃碼）
     - `WebATM`：網路轉帳（客戶使用網路銀行）
     - `ALL`：讓客戶自行選擇付款方式
  
  2. **優點**：
     - ✅ 完全不需要簡訊驗證
     - ✅ 客戶可以選擇最方便的付款方式
     - ✅ 避免簡訊驗證相關問題
  
  3. **缺點**：
     - ⚠️ 需要客戶到 ATM 或超商完成付款
     - ⚠️ 付款時間可能較長
  
  **方案 E：聯絡綠界客服**
  
  如果以上方法都無法解決，建議：
  1. 聯絡綠界客服：https://www.ecpay.com.tw/
  2. 提供以下資訊：
     - 商店代號（MerchantID）
     - 訂單編號
     - 手機號碼（已遮罩部分數字）
     - 問題發生時間
     - 錯誤訊息（如果有）
  3. 詢問：
     - 簡訊服務是否正常
     - 是否有針對您商店的特殊設定
     - 是否可以關閉 3D 驗證
     - 是否有其他付款方式建議
  
- **檢查方法**：
  1. 查看伺服器日誌，確認使用的是正式環境參數
  2. 確認日誌顯示「💰 使用正式環境設定」
  3. 確認 MerchantID 不是測試環境的 `2000132`
  4. 測試時記錄：
     - 使用的手機號碼
     - 簡訊發送時間
     - 是否收到簡訊
     - 錯誤訊息（如果有）

**問題：錯誤代碼 10200094 - 請檢查是否於正式環境誤用測試環境之MerchantID**
- **原因**：在正式環境（Railway）使用了測試環境的 MerchantID（2000132）
- **解決方案**：
  1. 在 Railway 環境變數中設定 `ECPAY_MERCHANT_ID_PROD`（您的正式商店代號）
  2. 設定 `ECPAY_HASH_KEY_PROD`（您的正式 HashKey）
  3. 設定 `ECPAY_HASH_IV_PROD`（您的正式 HashIV）
  4. 確認 `NODE_ENV=production` 已設定
  5. 重新部署後測試
- **替代方案**：在管理後台的「系統設定」中設定 `ecpay_merchant_id_prod`、`ecpay_hash_key_prod`、`ecpay_hash_iv_prod`

**問題：錯誤代碼 10100060 - MerchantID Is Null**
- **原因**：MerchantID 為空值或未設定
- **解決方案**：
  1. **正式環境**：
     - 在 Railway 環境變數中設定 `ECPAY_MERCHANT_ID_PROD`、`ECPAY_HASH_KEY_PROD`、`ECPAY_HASH_IV_PROD`
     - 或在資料庫中設定 `ecpay_merchant_id_prod`、`ecpay_hash_key_prod`、`ecpay_hash_iv_prod`
  2. **測試環境**：
     - 在環境變數中設定 `ECPAY_MERCHANT_ID`、`ECPAY_HASH_KEY`、`ECPAY_HASH_IV`
     - 或在資料庫中設定 `ecpay_merchant_id`、`ecpay_hash_key`、`ecpay_hash_iv`
  3. 確認 `NODE_ENV` 設定正確（正式環境為 `production`，測試環境為其他值或未設定）
  4. 重新部署後測試
- **檢查方法**：查看伺服器日誌，確認「綠界設定」中顯示的 MerchantID 是否為「未設定」

**問題：Railway 部署失敗 - 無法取得 secrets/NODE_ENV 的狀態**
- **錯誤訊息**：
  ```
  錯誤:建置失敗:無法取得/tmp/railpack-build-XXXXX/secrets/NODE_ENV 的狀態:
  stat /tmp/railpack-build-XXXXX/secrets/NODE_ENV:沒有該檔案或目錄
  ```
- **原因**：
  - Railway 的 Railpack 建置系統誤判專案類型
  - 嘗試從檔案讀取 `NODE_ENV`，但該檔案不存在
  - `NODE_ENV` 應該透過環境變數設定，而不是檔案
- **解決方案**：
  1. **已建立 `railway.json` 設定檔案**：
     - 明確指定使用 NIXPACKS 建置器
     - 指定建置和啟動命令
     - 避免 Railpack 誤判
  
  2. **確認環境變數設定**：
     - 在 Railway 後台的 **Variables** 標籤中設定 `NODE_ENV`
     - 不要建立 `secrets/NODE_ENV` 檔案
     - `NODE_ENV` 應該作為環境變數，而不是檔案
  
  3. **重新部署**：
     - 提交 `railway.json` 檔案到 Git
     - Railway 會自動重新部署
     - 部署應該會成功
  
- **注意事項**：
  - `NODE_ENV` 必須在 Railway 後台的環境變數中設定
  - 不要嘗試建立 `secrets` 目錄或檔案
  - 如果問題持續，可以嘗試刪除並重新建立 Railway 服務

## 📚 參考資料

- 綠界技術文件：https://developers.ecpay.com.tw/
- 測試環境說明：https://www.ecpay.com.tw/Service/API_Dwnld

