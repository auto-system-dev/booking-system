# 綠界支付整合說明

## 📋 功能說明

系統已整合綠界科技（ECPay）的線上刷卡服務，當客戶選擇「線上刷卡」時，會自動導向綠界支付頁面完成付款。

## 🔧 設定步驟

### 1. 取得綠界測試環境資訊

**測試環境設定（預設）：**
- 商店代號（MerchantID）：`2000132`
- HashKey：`5294y06JbISpM5x9`
- HashIV：`v77hoKGq4kWxNNIS`

這些是綠界提供的測試環境設定，已經預設在系統中。

### 2. 設定環境變數（選填）

如果需要使用自己的測試帳號，可以在 `.env` 檔案中設定：

```env
# 綠界測試環境
ECPAY_MERCHANT_ID=2000132
ECPAY_HASH_KEY=5294y06JbISpM5x9
ECPAY_HASH_IV=v77hoKGq4kWxNNIS

# 回傳網址（可選，預設為 localhost:3000）
ECPAY_RETURN_URL=http://localhost:3000/api/payment/return
ECPAY_ORDER_RESULT_URL=http://localhost:3000/api/payment/result
ECPAY_CLIENT_BACK_URL=http://localhost:3000
```

### 3. 正式環境設定

上線時，需要：

1. **申請綠界正式商店帳號**
   - 前往：https://www.ecpay.com.tw/
   - 註冊並申請商店帳號

2. **取得正式環境資訊**
   - 登入綠界商店後台
   - 取得正式環境的 MerchantID、HashKey、HashIV

3. **更新環境變數（Railway 部署）**
   
   在 Railway 專案的環境變數設定中，添加以下變數：
   
   ```env
   NODE_ENV=production
   ECPAY_MERCHANT_ID_PROD=您的正式商店代號
   ECPAY_HASH_KEY_PROD=您的正式HashKey
   ECPAY_HASH_IV_PROD=您的正式HashIV
   ```
   
   **Railway 設定步驟：**
   1. 登入 Railway 後台
   2. 選擇您的專案
   3. 進入「Variables」頁籤
   4. 點擊「+ New Variable」
   5. 依序添加上述環境變數
   6. 儲存後，Railway 會自動重新部署
   
   **注意：** 如果沒有設定 `ECPAY_MERCHANT_ID_PROD`，系統會自動使用資料庫中的設定（可在管理後台的「系統設定」中設定）。

## 🧪 測試流程

### 測試信用卡號

綠界測試環境提供的測試卡號：

- **信用卡號**：`4311-9522-2222-2222`
- **安全碼**：`222`
- **有效期限**：設定為未來的日期（例如：12/25）

### 測試步驟

1. **啟動伺服器**
   ```powershell
   & "C:\Program Files\nodejs\node.exe" server.js
   ```

2. **填寫訂房表單**
   - 選擇「線上刷卡」付款方式
   - 填寫其他必填欄位
   - 提交表單

3. **導向支付頁面**
   - 系統會自動導向綠界支付頁面
   - 使用測試卡號完成付款

4. **付款完成**
   - 付款成功後會導回系統
   - 顯示付款成功頁面

## 📊 支付流程

```
客戶提交訂房
    ↓
選擇「線上刷卡」
    ↓
系統建立訂單
    ↓
導向綠界支付頁面
    ↓
客戶完成付款
    ↓
綠界回傳付款結果
    ↓
系統更新訂單狀態
    ↓
顯示付款成功頁面
```

## 🔌 API 端點

### 1. 建立支付表單

```
POST /api/payment/create
```

**請求資料：**
```json
{
  "bookingId": "BK1765202639511"
}
```

**回應：**
```json
{
  "success": true,
  "data": {
    "actionUrl": "https://payment-stage.ecpay.com.tw/...",
    "params": {
      "MerchantID": "...",
      "MerchantTradeNo": "...",
      ...
    }
  }
}
```

### 2. 付款完成回傳（Server POST）

```
POST /api/payment/return
```

綠界會自動 POST 付款結果到此端點。

### 3. 付款完成導向（Client Redirect）

```
GET /api/payment/result
```

付款完成後，客戶會被導向此頁面。

## 📝 資料庫記錄

目前系統會：
- ✅ 儲存訂房資料
- ✅ 記錄付款方式
- ⚠️ 付款狀態需要額外欄位（可選）

如果需要記錄付款狀態，可以在資料庫中新增 `payment_status` 欄位。

## ⚠️ 注意事項

1. **測試環境限制**
   - 測試環境不會真的扣款
   - 僅用於開發測試

2. **正式環境**
   - 必須申請正式商店帳號
   - 需要通過綠界審核
   - 設定正確的回傳網址

3. **安全性**
   - 不要將 HashKey 和 HashIV 提交到公開程式碼
   - 使用環境變數管理敏感資訊
   - 確保回傳資料驗證正確

4. **回傳網址**
   - 測試環境可以使用 localhost
   - 正式環境必須使用 HTTPS
   - 需要在綠界後台設定允許的回傳網址

## 🔍 除錯

### 查看日誌

付款相關的日誌會顯示在終端機：

```
📥 收到綠界付款回傳
時間: [時間]
回傳資料: {...}
付款結果: {...}
```

### 常見問題

**問題：無法導向支付頁面**
- 檢查環境變數設定
- 確認 MerchantID、HashKey、HashIV 正確

**問題：付款驗證失敗**
- 檢查 CheckMacValue 計算是否正確
- 確認回傳資料格式

**問題：無法接收回傳**
- 檢查回傳網址設定
- 確認伺服器可以接收 POST 請求

## 📚 參考資料

- 綠界技術文件：https://developers.ecpay.com.tw/
- 測試環境說明：https://www.ecpay.com.tw/Service/API_Dwnld

