# å‰ç«¯ Bad Request (400) éŒ¯èª¤èªªæ˜

## ğŸ“ å•é¡Œæè¿°

åœ¨ booking-system çš„å‰ç«¯ï¼ˆå®¢æˆ¶ç«¯ï¼‰å‡ºç¾ Bad Request éŒ¯èª¤ï¼Œé€šå¸¸ç™¼ç”Ÿåœ¨æäº¤è¨‚æˆ¿è¡¨å–®æ™‚ã€‚

## ğŸ” éŒ¯èª¤ç™¼ç”Ÿæµç¨‹

### 1. å‰ç«¯é©—è­‰ï¼ˆ`script.js` ç¬¬ 724-787 è¡Œï¼‰

å‰ç«¯æœƒå…ˆé€²è¡ŒåŸºæœ¬é©—è­‰ï¼š
- âœ… æ—¥æœŸé¸æ“‡é©—è­‰
- âœ… æˆ¿å‹é¸æ“‡é©—è­‰
- âœ… å§“åé©—è­‰
- âœ… æ‰‹æ©Ÿè™Ÿç¢¼é©—è­‰ï¼ˆ09 é–‹é ­ï¼Œ10 ç¢¼ï¼‰
- âœ… Email é©—è­‰ï¼ˆåŸºæœ¬æ ¼å¼ï¼‰

**å¦‚æœå‰ç«¯é©—è­‰å¤±æ•—ï¼Œæœƒç›´æ¥é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼Œä¸æœƒç™¼é€åˆ°ä¼ºæœå™¨ã€‚**

### 2. ç™¼é€åˆ°ä¼ºæœå™¨ï¼ˆ`script.js` ç¬¬ 868-873 è¡Œï¼‰

```javascript
const response = await fetch('/api/booking', {
    method: 'POST',
    headers: headers,
    credentials: 'include',
    body: JSON.stringify(formData)
});
```

### 3. ä¼ºæœå™¨é©—è­‰ï¼ˆ`server.js`ï¼‰

ä¼ºæœå™¨æœƒé€²è¡Œæ›´åš´æ ¼çš„é©—è­‰ï¼š
1. **è¼¸å…¥æ¸…ç†ä¸­é–“ä»¶** (`sanitizeInput`) - æª¢æŸ¥ SQL Injection å’Œ XSS
2. **é©—è­‰ä¸­é–“ä»¶** (`validateBooking`) - é©—è­‰æ ¼å¼å’Œç¯„åœ
3. **API å…§éƒ¨é©—è­‰** - æª¢æŸ¥æ¥­å‹™é‚è¼¯

### 4. éŒ¯èª¤è™•ç†ï¼ˆ`script.js` ç¬¬ 906-910 è¡Œï¼‰

```javascript
if (response.ok) {
    // æˆåŠŸè™•ç†
} else {
    alert('è¨‚æˆ¿å¤±æ•—ï¼š' + (result.message || 'è«‹ç¨å¾Œå†è©¦'));
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<span>ç¢ºèªè¨‚æˆ¿</span>';
}
```

## âš ï¸ å¸¸è¦‹åŸå› 

### åŸå›  1ï¼šæ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼å•é¡Œ

**å‰ç«¯é©—è­‰**ï¼ˆ`script.js` ç¬¬ 766 è¡Œï¼‰ï¼š
```javascript
const taiwanPhoneRegex = /^09\d{8}$/;
```

**å¾Œç«¯é©—è­‰**ï¼ˆ`validators.js` ç¬¬ 85-94 è¡Œï¼‰ï¼š
```javascript
function sanitizePhone(input) {
    const str = String(input).trim().replace(/[-\s]/g, '');
    const phoneRegex = /^09\d{8}$/;
    if (!phoneRegex.test(str)) {
        return null;
    }
    return str;
}
```

**å•é¡Œ**ï¼š
- å‰ç«¯å¯èƒ½å…è¨±å¸¶æœ‰ `-` æˆ–ç©ºæ ¼çš„æ‰‹æ©Ÿè™Ÿç¢¼
- ä½†å¾Œç«¯æœƒç§»é™¤é€™äº›å­—å…ƒå¾Œå†é©—è­‰
- å¦‚æœç§»é™¤å¾Œä¸ç¬¦åˆæ ¼å¼ï¼Œæœƒè¿”å› 400 éŒ¯èª¤

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- ç¢ºä¿æ‰‹æ©Ÿè™Ÿç¢¼æ˜¯ç´”æ•¸å­—ï¼Œ09 é–‹é ­ï¼Œ10 ç¢¼
- ä¾‹å¦‚ï¼š`0912345678` âœ…
- ä¾‹å¦‚ï¼š`0912-345-678` âš ï¸ï¼ˆå¯èƒ½åœ¨å‰ç«¯é€šéï¼Œä½†å¾Œç«¯æœƒè™•ç†ï¼‰

### åŸå›  2ï¼šEmail æ ¼å¼å•é¡Œ

**å‰ç«¯é©—è­‰**ï¼ˆ`script.js` ç¬¬ 779 è¡Œï¼‰ï¼š
```javascript
const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
```

**å¾Œç«¯é©—è­‰**ï¼ˆ`validators.js` ç¬¬ 68-80 è¡Œï¼‰ï¼š
```javascript
function sanitizeEmail(input) {
    const str = String(input).trim().toLowerCase();
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(str)) {
        return null;
    }
    if (str.length > 255) {
        return null;
    }
    return str;
}
```

**å•é¡Œ**ï¼š
- å¾Œç«¯æœƒå°‡ Email è½‰ç‚ºå°å¯«
- å¾Œç«¯æœƒæª¢æŸ¥é•·åº¦ï¼ˆä¸èƒ½è¶…é 255 å­—å…ƒï¼‰
- å¦‚æœä¸ç¬¦åˆï¼Œæœƒè¿”å› 400 éŒ¯èª¤

### åŸå›  3ï¼šæ—¥æœŸæ ¼å¼æˆ–ç¯„åœå•é¡Œ

**å¾Œç«¯é©—è­‰**ï¼ˆ`validators.js` ç¬¬ 174-219 è¡Œï¼‰ï¼š
- å…¥ä½æ—¥æœŸä¸èƒ½æ—©æ–¼ä»Šå¤©
- é€€æˆ¿æ—¥æœŸå¿…é ˆæ™šæ–¼å…¥ä½æ—¥æœŸ
- æœ€å¤šåªèƒ½é è¨‚ 365 å¤©

**å•é¡Œ**ï¼š
- å¦‚æœç”¨æˆ¶é¸æ“‡çš„æ—¥æœŸåœ¨é©—è­‰æ™‚å·²ç¶“éæœŸï¼ˆä¾‹å¦‚ï¼šé¸æ“‡ä»Šå¤©ï¼Œä½†æäº¤æ™‚å·²ç¶“æ˜¯æ˜å¤©ï¼‰
- æœƒè¿”å› 400 éŒ¯èª¤

### åŸå›  4ï¼šSQL Injection æˆ– XSS èª¤åˆ¤

**å¾Œç«¯æª¢æ¸¬**ï¼ˆ`validators.js` ç¬¬ 99-133 è¡Œï¼‰ï¼š
- æª¢æ¸¬ SQL é—œéµå­—ï¼ˆSELECT, INSERT, UPDATE ç­‰ï¼‰
- æª¢æ¸¬ XSS æ”»æ“Šï¼ˆ`<script>`, `<iframe>` ç­‰ï¼‰

**å•é¡Œ**ï¼š
- å¦‚æœå§“åæˆ–å…¶ä»–æ¬„ä½åŒ…å« SQL é—œéµå­—ï¼ˆä¾‹å¦‚ï¼šç”¢å“åç¨±åŒ…å« "SELECT"ï¼‰
- æœƒè¢«èª¤åˆ¤ç‚º SQL Injection æ”»æ“Š
- æœƒè¿”å› 400 éŒ¯èª¤ï¼Œè¨Šæ¯ï¼š`æª¢æ¸¬åˆ° SQL Injection æ”»æ“Šå˜—è©¦ï¼ˆæ¬„ä½: xxxï¼‰`

### åŸå›  5ï¼šCSRF Token å•é¡Œ

**å‰ç«¯è™•ç†**ï¼ˆ`script.js` ç¬¬ 846-858 è¡Œï¼‰ï¼š
```javascript
const tokenResponse = await fetch('/api/csrf-token', {
    credentials: 'include'
});
```

**å•é¡Œ**ï¼š
- å¦‚æœç„¡æ³•å–å¾— CSRF Token
- æˆ– Token å·²éæœŸ
- æœƒè¿”å› 400 éŒ¯èª¤ï¼Œè¨Šæ¯ï¼š`é©—è­‰å¤±æ•—`

### åŸå›  6ï¼šä»˜æ¬¾æ–¹å¼æœªå•Ÿç”¨

**å¾Œç«¯é©—è­‰**ï¼ˆ`server.js` ç¬¬ 720-729 è¡Œï¼‰ï¼š
```javascript
if (paymentMethod === 'transfer' && !enableTransfer) {
    return res.status(400).json({ 
        message: 'åŒ¯æ¬¾è½‰å¸³åŠŸèƒ½ç›®å‰æœªå•Ÿç”¨ï¼Œè«‹é¸æ“‡å…¶ä»–ä»˜æ¬¾æ–¹å¼' 
    });
}
```

**å•é¡Œ**ï¼š
- å¦‚æœé¸æ“‡çš„ä»˜æ¬¾æ–¹å¼åœ¨ç³»çµ±è¨­å®šä¸­æœªå•Ÿç”¨
- æœƒè¿”å› 400 éŒ¯èª¤

## ğŸ› ï¸ å¦‚ä½•è¨ºæ–·

### æ–¹æ³• 1ï¼šæŸ¥çœ‹ç€è¦½å™¨æ§åˆ¶å°

1. æ‰“é–‹ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·ï¼ˆF12ï¼‰
2. åˆ‡æ›åˆ° **Console** æ¨™ç±¤
3. æŸ¥çœ‹æ˜¯å¦æœ‰ä»¥ä¸‹è¨Šæ¯ï¼š
   - `æº–å‚™ç™¼é€è¨‚æˆ¿è³‡æ–™:` - é¡¯ç¤ºç™¼é€çš„è³‡æ–™
   - `æ”¶åˆ°å›æ‡‰ï¼Œç‹€æ…‹ç¢¼: 400` - ç¢ºèªæ˜¯ 400 éŒ¯èª¤
   - `å›æ‡‰è³‡æ–™:` - é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯

### æ–¹æ³• 2ï¼šæŸ¥çœ‹ Network æ¨™ç±¤

1. æ‰“é–‹ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·ï¼ˆF12ï¼‰
2. åˆ‡æ›åˆ° **Network** æ¨™ç±¤
3. æäº¤è¨‚æˆ¿è¡¨å–®
4. æ‰¾åˆ° `/api/booking` è«‹æ±‚
5. æŸ¥çœ‹ï¼š
   - **Request Payload** - ç¢ºèªç™¼é€çš„è³‡æ–™
   - **Response** - æŸ¥çœ‹éŒ¯èª¤è¨Šæ¯

### æ–¹æ³• 3ï¼šæŸ¥çœ‹ä¼ºæœå™¨æ—¥èªŒ

æŸ¥çœ‹ä¼ºæœå™¨æ§åˆ¶å°è¼¸å‡ºï¼š
```
========================================
ğŸ“¥ æ”¶åˆ°è¨‚æˆ¿è«‹æ±‚
æ™‚é–“: 2024-12-01 10:00:00
è«‹æ±‚è³‡æ–™: { ... }
========================================
```

å¦‚æœçœ‹åˆ°ï¼š
- `è¼¸å…¥æ¸…ç†éŒ¯èª¤:` - è¡¨ç¤ºè¼¸å…¥æ¸…ç†å¤±æ•—
- `é©—è­‰éŒ¯èª¤:` - è¡¨ç¤ºé©—è­‰ä¸­é–“ä»¶å¤±æ•—

## ğŸ”§ è§£æ±ºæ–¹æ¡ˆ

### è§£æ±ºæ–¹æ¡ˆ 1ï¼šæ”¹å–„å‰ç«¯é©—è­‰

ç¢ºä¿å‰ç«¯é©—è­‰èˆ‡å¾Œç«¯é©—è­‰ä¸€è‡´ï¼š

```javascript
// æ‰‹æ©Ÿè™Ÿç¢¼ï¼šç§»é™¤æ‰€æœ‰éæ•¸å­—å­—å…ƒå¾Œé©—è­‰
const phone = phoneInput.value.trim().replace(/[-\s]/g, '');
if (!taiwanPhoneRegex.test(phone)) {
    showFieldError('guestPhone', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆ09 é–‹é ­ï¼Œå…± 10 ç¢¼ï¼‰');
    return;
}

// Emailï¼šè½‰ç‚ºå°å¯«ä¸¦æª¢æŸ¥é•·åº¦
const email = emailInput.value.trim().toLowerCase();
if (email.length > 255) {
    showFieldError('guestEmail', 'Email é•·åº¦ä¸èƒ½è¶…é 255 å­—å…ƒ');
    return;
}
```

### è§£æ±ºæ–¹æ¡ˆ 2ï¼šæ”¹å–„éŒ¯èª¤è¨Šæ¯é¡¯ç¤º

ç›®å‰å‰ç«¯åªé¡¯ç¤ºç°¡å–®çš„ alertï¼Œå¯ä»¥æ”¹ç‚ºæ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯ï¼š

```javascript
} else {
    // é¡¯ç¤ºæ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
    const errorMsg = result.message || 'è«‹ç¨å¾Œå†è©¦';
    console.error('è¨‚æˆ¿å¤±æ•—:', errorMsg, result);
    
    // æ ¹æ“šéŒ¯èª¤é¡å‹é¡¯ç¤ºä¸åŒçš„è¨Šæ¯
    if (errorMsg.includes('Email')) {
        showFieldError('guestEmail', errorMsg);
    } else if (errorMsg.includes('æ‰‹æ©Ÿ')) {
        showFieldError('guestPhone', errorMsg);
    } else if (errorMsg.includes('æ—¥æœŸ')) {
        showFieldError('dateRange', errorMsg);
    } else {
        alert('è¨‚æˆ¿å¤±æ•—ï¼š' + errorMsg);
    }
    
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<span>ç¢ºèªè¨‚æˆ¿</span>';
}
```

### è§£æ±ºæ–¹æ¡ˆ 3ï¼šèª¿æ•´å¾Œç«¯é©—è­‰è¦å‰‡

å¦‚æœ SQL Injection æª¢æ¸¬å¤ªåš´æ ¼ï¼Œå¯ä»¥èª¿æ•´è¦å‰‡ï¼ˆ`validators.js` ç¬¬ 122-132 è¡Œï¼‰ã€‚

## ğŸ“ æª¢æŸ¥æ¸…å–®

åœ¨æäº¤è¨‚æˆ¿å‰ï¼Œç¢ºèªï¼š

- [ ] æ—¥æœŸå·²é¸æ“‡ä¸”æœ‰æ•ˆï¼ˆå…¥ä½æ—¥æœŸ >= ä»Šå¤©ï¼Œé€€æˆ¿æ—¥æœŸ > å…¥ä½æ—¥æœŸï¼‰
- [ ] æˆ¿å‹å·²é¸æ“‡
- [ ] å§“åå·²å¡«å¯«ï¼ˆä¸åŒ…å«ç‰¹æ®Šå­—å…ƒï¼‰
- [ ] æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼æ­£ç¢ºï¼ˆ09 é–‹é ­ï¼Œ10 ç¢¼æ•¸å­—ï¼‰
- [ ] Email æ ¼å¼æ­£ç¢ºï¼ˆåŒ…å« @ å’ŒåŸŸåï¼Œé•·åº¦ <= 255ï¼‰
- [ ] äººæ•¸åœ¨åˆç†ç¯„åœå…§ï¼ˆå¤§äºº 1-20ï¼Œå­©ç«¥ 0-20ï¼‰
- [ ] ä»˜æ¬¾æ–¹å¼å·²é¸æ“‡ä¸”å·²å•Ÿç”¨
- [ ] æ²’æœ‰åœ¨æ¬„ä½ä¸­è¼¸å…¥ SQL é—œéµå­—æˆ– HTML æ¨™ç±¤

## ğŸ’¡ å»ºè­°

1. **çµ±ä¸€å‰å¾Œç«¯é©—è­‰è¦å‰‡** - ç¢ºä¿å‰ç«¯é©—è­‰èˆ‡å¾Œç«¯é©—è­‰ä¸€è‡´
2. **æ”¹å–„éŒ¯èª¤è¨Šæ¯** - æä¾›æ›´è©³ç´°ã€æ›´å‹å–„çš„éŒ¯èª¤è¨Šæ¯
3. **è¨˜éŒ„éŒ¯èª¤æ—¥èªŒ** - è¨˜éŒ„æ‰€æœ‰ 400 éŒ¯èª¤ï¼Œæ–¹ä¾¿è¿½è¹¤å•é¡Œ
4. **æ¸¬è©¦å„ç¨®æƒ…æ³** - æ¸¬è©¦é‚Šç•Œæƒ…æ³å’Œç•°å¸¸è¼¸å…¥

## ğŸ”— ç›¸é—œæ–‡ä»¶

- `Bad Request éŒ¯èª¤è¨ºæ–·æŒ‡å—.md` - å®Œæ•´çš„éŒ¯èª¤è¨ºæ–·æŒ‡å—
- `validators.js` - é©—è­‰è¦å‰‡
- `server.js` - ä¼ºæœå™¨ç«¯é©—è­‰
- `script.js` - å‰ç«¯é©—è­‰å’ŒéŒ¯èª¤è™•ç†
