# ä»˜æ¬¾ç‹€æ…‹é‚è¼¯èªªæ˜

## ğŸ“‹ ä»˜æ¬¾ç‹€æ…‹é¡å‹

ç³»çµ±ä¸­çš„ä»˜æ¬¾ç‹€æ…‹ï¼ˆ`payment_status`ï¼‰æœ‰ä»¥ä¸‹å¹¾ç¨®ï¼š

| ç‹€æ…‹å€¼ | é¡¯ç¤ºåç¨± | èªªæ˜ | ä½•æ™‚è¨­å®š |
|--------|---------|------|---------|
| `pending` | å¾…ä»˜æ¬¾ | å°šæœªä»˜æ¬¾æˆ–ç­‰å¾…ä»˜æ¬¾ç¢ºèª | å»ºç«‹è¨‚æˆ¿æ™‚è‡ªå‹•è¨­å®š |
| `paid` | å·²ä»˜æ¬¾ | ä»˜æ¬¾å·²å®Œæˆ | ä»˜æ¬¾å®Œæˆå¾Œè‡ªå‹•æˆ–æ‰‹å‹•æ›´æ–° |
| `failed` | ä»˜æ¬¾å¤±æ•— | ä»˜æ¬¾å¤±æ•—ï¼ˆç›®å‰æœªä½¿ç”¨ï¼‰ | - |
| `refunded` | å·²é€€æ¬¾ | å·²é€€æ¬¾ï¼ˆç›®å‰æœªä½¿ç”¨ï¼‰ | - |

## ğŸ”„ ä»˜æ¬¾ç‹€æ…‹æµç¨‹

### 1. å»ºç«‹è¨‚æˆ¿æ™‚çš„åˆå§‹ç‹€æ…‹

**ä½ç½®**ï¼š`server.js` (490-500è¡Œ)

ç•¶å®¢æˆ¶æäº¤è¨‚æˆ¿è¡¨å–®æ™‚ï¼Œç„¡è«–é¸æ“‡å“ªç¨®ä»˜æ¬¾æ–¹å¼ï¼Œåˆå§‹ä»˜æ¬¾ç‹€æ…‹éƒ½æ˜¯ `pending`ï¼š

```javascript
// åˆ¤æ–·ä»˜æ¬¾ç‹€æ…‹å’Œè¨‚æˆ¿ç‹€æ…‹
let paymentStatus = 'pending';
let bookingStatus = 'active';

if (paymentMethod === 'card') {
    paymentStatus = 'pending'; // åˆ·å¡éœ€è¦ç­‰å¾…ä»˜æ¬¾å®Œæˆ
    bookingStatus = 'reserved'; // ç·šä¸Šåˆ·å¡å…ˆè¨­ç‚ºä¿ç•™
} else if (paymentMethod === 'transfer') {
    paymentStatus = 'pending'; // åŒ¯æ¬¾ä¹Ÿéœ€è¦ç­‰å¾…ç¢ºèª
    bookingStatus = 'reserved'; // åŒ¯æ¬¾è½‰å¸³å…ˆè¨­ç‚ºä¿ç•™ï¼ˆä¿ç•™3å¤©ï¼‰
}
```

**è¦å‰‡**ï¼š
- âœ… **æ‰€æœ‰ä»˜æ¬¾æ–¹å¼**ï¼šåˆå§‹ä»˜æ¬¾ç‹€æ…‹éƒ½æ˜¯ `pending`ï¼ˆå¾…ä»˜æ¬¾ï¼‰
- âœ… **ç·šä¸Šåˆ·å¡**ï¼šè¨‚æˆ¿ç‹€æ…‹ç‚º `reserved`ï¼ˆä¿ç•™ï¼‰ï¼Œç­‰å¾…ä»˜æ¬¾å®Œæˆ
- âœ… **åŒ¯æ¬¾è½‰å¸³**ï¼šè¨‚æˆ¿ç‹€æ…‹ç‚º `reserved`ï¼ˆä¿ç•™ï¼‰ï¼Œç­‰å¾…ç®¡ç†å“¡ç¢ºèªä»˜æ¬¾

### 2. ä»˜æ¬¾å®Œæˆå¾Œçš„ç‹€æ…‹æ›´æ–°

#### æ–¹å¼ Aï¼šç·šä¸Šåˆ·å¡ä»˜æ¬¾å®Œæˆ

**ä½ç½®**ï¼š`server.js` (1467-1473è¡Œ)

ç•¶ç¶ ç•Œæ”¯ä»˜å®Œæˆä¸¦å›å‚³æˆåŠŸæ™‚ï¼š

```javascript
// æ›´æ–°ä»˜æ¬¾ç‹€æ…‹ç‚ºå·²ä»˜æ¬¾ï¼Œä¸¦å°‡è¨‚æˆ¿ç‹€æ…‹æ”¹ç‚ºæœ‰æ•ˆ
await db.updateBooking(bookingId, {
    payment_status: 'paid',
    status: 'active'
});

console.log('âœ… ä»˜æ¬¾ç‹€æ…‹å·²æ›´æ–°ç‚ºã€Œå·²ä»˜æ¬¾ã€ï¼Œè¨‚æˆ¿ç‹€æ…‹å·²æ›´æ–°ç‚ºã€Œæœ‰æ•ˆã€');
```

**è¦å‰‡**ï¼š
- âœ… ä»˜æ¬¾ç‹€æ…‹è‡ªå‹•æ›´æ–°ç‚º `paid`ï¼ˆå·²ä»˜æ¬¾ï¼‰
- âœ… è¨‚æˆ¿ç‹€æ…‹è‡ªå‹•æ›´æ–°ç‚º `active`ï¼ˆæœ‰æ•ˆï¼‰
- âœ… ç³»çµ±æœƒè‡ªå‹•ç™¼é€ç¢ºèªéƒµä»¶çµ¦å®¢æˆ¶

#### æ–¹å¼ Bï¼šåŒ¯æ¬¾è½‰å¸³ä»˜æ¬¾å®Œæˆï¼ˆç®¡ç†å“¡æ‰‹å‹•æ›´æ–°ï¼‰

**ä½ç½®**ï¼š`server.js` (894-901è¡Œ)

ç•¶ç®¡ç†å“¡åœ¨å¾Œå°æ‰‹å‹•æ›´æ–°ä»˜æ¬¾ç‹€æ…‹ç‚ºã€Œå·²ä»˜æ¬¾ã€æ™‚ï¼š

```javascript
// å¦‚æœä»˜æ¬¾ç‹€æ…‹æ›´æ–°ç‚ºå·²ä»˜æ¬¾ï¼Œä¸”è¨‚æˆ¿ç‹€æ…‹ç‚ºä¿ç•™ï¼Œè‡ªå‹•æ”¹ç‚ºæœ‰æ•ˆ
if (updateData.payment_status === 'paid') {
    const booking = await db.getBookingById(bookingId);
    if (booking && booking.status === 'reserved') {
        updateData.status = 'active';
        console.log(`âœ… ä»˜æ¬¾ç‹€æ…‹æ›´æ–°ç‚ºå·²ä»˜æ¬¾ï¼Œè‡ªå‹•å°‡è¨‚æˆ¿ç‹€æ…‹å¾ã€Œä¿ç•™ã€æ”¹ç‚ºã€Œæœ‰æ•ˆã€`);
    }
}
```

**è¦å‰‡**ï¼š
- âœ… ç®¡ç†å“¡æ‰‹å‹•æ›´æ–°ä»˜æ¬¾ç‹€æ…‹ç‚º `paid`ï¼ˆå·²ä»˜æ¬¾ï¼‰
- âœ… å¦‚æœè¨‚æˆ¿ç‹€æ…‹ç‚º `reserved`ï¼ˆä¿ç•™ï¼‰ï¼Œæœƒè‡ªå‹•æ›´æ–°ç‚º `active`ï¼ˆæœ‰æ•ˆï¼‰
- âœ… å¦‚æœè¨‚æˆ¿ç‹€æ…‹å·²ç¶“æ˜¯ `active`ï¼ˆæœ‰æ•ˆï¼‰ï¼Œå‰‡ä¸æœƒæ”¹è®Š

### 3. ä»˜æ¬¾ç‹€æ…‹çš„æŸ¥è©¢å’Œä½¿ç”¨

#### æŸ¥è©¢éœ€è¦ç™¼é€åŒ¯æ¬¾æé†’çš„è¨‚æˆ¿

**ä½ç½®**ï¼š`database.js` (1793-1841è¡Œ)

```javascript
async function getBookingsForPaymentReminder() {
    const sql = `
        SELECT * FROM bookings 
        WHERE payment_method LIKE '%åŒ¯æ¬¾%' 
        AND payment_status = 'pending'  -- åªæŸ¥è©¢å¾…ä»˜æ¬¾çš„è¨‚æˆ¿
        AND status = 'reserved'         -- åªæŸ¥è©¢ä¿ç•™ç‹€æ…‹çš„è¨‚æˆ¿
        AND DATE(created_at) <= DATE(ä»Šå¤©)
    `;
}
```

**æŸ¥è©¢æ¢ä»¶**ï¼š
- ä»˜æ¬¾æ–¹å¼ï¼šåŒ¯æ¬¾è½‰å¸³
- ä»˜æ¬¾ç‹€æ…‹ï¼š`pending`ï¼ˆå¾…ä»˜æ¬¾ï¼‰
- è¨‚æˆ¿ç‹€æ…‹ï¼š`reserved`ï¼ˆä¿ç•™ï¼‰
- åŒ¯æ¬¾æœŸé™ï¼šä»Šå¤©æ˜¯æœ€å¾Œä¸€å¤©

#### æŸ¥è©¢éœ€è¦ç™¼é€å…¥ä½æé†’çš„è¨‚æˆ¿

**ä½ç½®**ï¼š`database.js` (1824-1856è¡Œ)

```javascript
async function getBookingsForCheckinReminder() {
    const sql = `
        SELECT * FROM bookings 
        WHERE check_in_date = æ˜å¤©
        AND status = 'active'           -- åªæŸ¥è©¢æœ‰æ•ˆç‹€æ…‹çš„è¨‚æˆ¿
        AND payment_status = 'paid'    -- åªæŸ¥è©¢å·²ä»˜æ¬¾çš„è¨‚æˆ¿
    `;
}
```

**æŸ¥è©¢æ¢ä»¶**ï¼š
- å…¥ä½æ—¥æœŸï¼šæ˜å¤©
- è¨‚æˆ¿ç‹€æ…‹ï¼š`active`ï¼ˆæœ‰æ•ˆï¼‰
- ä»˜æ¬¾ç‹€æ…‹ï¼š`paid`ï¼ˆå·²ä»˜æ¬¾ï¼‰

#### æŸ¥è©¢éœ€è¦è‡ªå‹•å–æ¶ˆçš„éæœŸä¿ç•™è¨‚æˆ¿

**ä½ç½®**ï¼š`database.js` (1944-1963è¡Œ)

```javascript
async function getBookingsExpiredReservation() {
    const sql = `
        SELECT * FROM bookings 
        WHERE status = 'reserved'      -- åªæŸ¥è©¢ä¿ç•™ç‹€æ…‹çš„è¨‚æˆ¿
        AND payment_status = 'pending' -- åªæŸ¥è©¢å¾…ä»˜æ¬¾çš„è¨‚æˆ¿
    `;
}
```

**æŸ¥è©¢æ¢ä»¶**ï¼š
- è¨‚æˆ¿ç‹€æ…‹ï¼š`reserved`ï¼ˆä¿ç•™ï¼‰
- ä»˜æ¬¾ç‹€æ…‹ï¼š`pending`ï¼ˆå¾…ä»˜æ¬¾ï¼‰

## ğŸ“Š ä»˜æ¬¾ç‹€æ…‹èˆ‡è¨‚æˆ¿ç‹€æ…‹çš„é—œä¿‚

### ç‹€æ…‹çµ„åˆèªªæ˜

| ä»˜æ¬¾ç‹€æ…‹ | è¨‚æˆ¿ç‹€æ…‹ | èªªæ˜ | å¸¸è¦‹æƒ…æ³ |
|---------|---------|------|---------|
| `pending` | `reserved` | å¾…ä»˜æ¬¾ï¼Œä¿ç•™ä¸­ | å‰›å»ºç«‹çš„è¨‚æˆ¿ï¼Œç­‰å¾…ä»˜æ¬¾ |
| `pending` | `active` | å¾…ä»˜æ¬¾ï¼Œä½†å·²ç¢ºèª | ç‰¹æ®Šæƒ…æ³ï¼ˆä¸å¸¸è¦‹ï¼‰ |
| `paid` | `reserved` | å·²ä»˜æ¬¾ï¼Œä½†æœªç¢ºèª | ä»˜æ¬¾å®Œæˆä½†ç®¡ç†å“¡å°šæœªç¢ºèª |
| `paid` | `active` | å·²ä»˜æ¬¾ï¼Œå·²ç¢ºèª | æ­£å¸¸å®Œæˆæµç¨‹ |
| `pending` | `cancelled` | å¾…ä»˜æ¬¾ï¼Œå·²å–æ¶ˆ | éæœŸæœªä»˜æ¬¾è¢«è‡ªå‹•å–æ¶ˆ |

### ç‹€æ…‹è½‰æ›æµç¨‹åœ–

```
å»ºç«‹è¨‚æˆ¿
    â†“
payment_status = 'pending'
status = 'reserved'
    â†“
    â”œâ”€â†’ ç·šä¸Šåˆ·å¡ä»˜æ¬¾å®Œæˆ
    â”‚   â””â”€â†’ payment_status = 'paid'
    â”‚       status = 'active'ï¼ˆè‡ªå‹•ï¼‰
    â”‚
    â”œâ”€â†’ åŒ¯æ¬¾è½‰å¸³ï¼Œç®¡ç†å“¡æ›´æ–°ä»˜æ¬¾ç‹€æ…‹
    â”‚   â””â”€â†’ payment_status = 'paid'
    â”‚       status = 'active'ï¼ˆè‡ªå‹•ï¼Œå¦‚æœåŸæœ¬æ˜¯ reservedï¼‰
    â”‚
    â””â”€â†’ è¶…éä¿ç•™æœŸé™æœªä»˜æ¬¾
        â””â”€â†’ status = 'cancelled'ï¼ˆè‡ªå‹•ï¼‰
            payment_status ä»ç‚º 'pending'
```

## ğŸ”§ ä»˜æ¬¾ç‹€æ…‹çš„æ›´æ–°æ–¹å¼

### 1. è‡ªå‹•æ›´æ–°

#### ç·šä¸Šåˆ·å¡ä»˜æ¬¾å®Œæˆ
- **è§¸ç™¼æ™‚æ©Ÿ**ï¼šç¶ ç•Œæ”¯ä»˜å›å‚³ä»˜æ¬¾æˆåŠŸ
- **æ›´æ–°å…§å®¹**ï¼š
  - `payment_status`: `pending` â†’ `paid`
  - `status`: `reserved` â†’ `active`
- **ä½ç½®**ï¼š`server.js` (1467-1473è¡Œ)

#### è‡ªå‹•å–æ¶ˆéæœŸä¿ç•™è¨‚æˆ¿
- **è§¸ç™¼æ™‚æ©Ÿ**ï¼šæ¯å¤©å‡Œæ™¨ 1:00 å®šæ™‚ä»»å‹™
- **æ›´æ–°å…§å®¹**ï¼š
  - `status`: `reserved` â†’ `cancelled`
  - `payment_status` ä¿æŒ `pending`
- **ä½ç½®**ï¼š`server.js` (1888-1930è¡Œ)

### 2. æ‰‹å‹•æ›´æ–°ï¼ˆç®¡ç†å“¡å¾Œå°ï¼‰

#### æ›´æ–°ä»˜æ¬¾ç‹€æ…‹
- **ä½ç½®**ï¼š`server.js` (889-925è¡Œ)
- **API ç«¯é»**ï¼š`PUT /api/bookings/:bookingId`
- **å¯æ›´æ–°æ¬„ä½**ï¼š
  - `payment_status`: å¯æ”¹ç‚º `paid`
  - å…¶ä»–è¨‚æˆ¿è³‡æ–™ï¼ˆå§“åã€é›»è©±ã€æ—¥æœŸç­‰ï¼‰

**è‡ªå‹•é‚è¼¯**ï¼š
- å¦‚æœå°‡ `payment_status` æ›´æ–°ç‚º `paid`
- ä¸”ç•¶å‰ `status` ç‚º `reserved`
- å‰‡è‡ªå‹•å°‡ `status` æ›´æ–°ç‚º `active`

## ğŸ’¡ ä»˜æ¬¾ç‹€æ…‹çš„ä½¿ç”¨å ´æ™¯

### 1. åŒ¯æ¬¾æé†’éƒµä»¶

**æŸ¥è©¢æ¢ä»¶**ï¼š
- `payment_status = 'pending'`ï¼ˆå¾…ä»˜æ¬¾ï¼‰
- `status = 'reserved'`ï¼ˆä¿ç•™ï¼‰
- åŒ¯æ¬¾æœŸé™æœ€å¾Œä¸€å¤©

**ç›®çš„**ï¼šæé†’å®¢æˆ¶ç›¡å¿«å®ŒæˆåŒ¯æ¬¾

### 2. å…¥ä½æé†’éƒµä»¶

**æŸ¥è©¢æ¢ä»¶**ï¼š
- `payment_status = 'paid'`ï¼ˆå·²ä»˜æ¬¾ï¼‰
- `status = 'active'`ï¼ˆæœ‰æ•ˆï¼‰
- å…¥ä½æ—¥æœŸç‚ºæ˜å¤©

**ç›®çš„**ï¼šåªæé†’å·²ä»˜æ¬¾ä¸”å·²ç¢ºèªçš„è¨‚æˆ¿

### 3. è‡ªå‹•å–æ¶ˆéæœŸè¨‚æˆ¿

**æŸ¥è©¢æ¢ä»¶**ï¼š
- `payment_status = 'pending'`ï¼ˆå¾…ä»˜æ¬¾ï¼‰
- `status = 'reserved'`ï¼ˆä¿ç•™ï¼‰
- è¶…éä¿ç•™æœŸé™

**ç›®çš„**ï¼šè‡ªå‹•æ¸…ç†æœªä»˜æ¬¾çš„ä¿ç•™è¨‚æˆ¿

## ğŸ“ é‡è¦æé†’

### 1. ä»˜æ¬¾ç‹€æ…‹èˆ‡è¨‚æˆ¿ç‹€æ…‹çš„å€åˆ¥

- **ä»˜æ¬¾ç‹€æ…‹**ï¼ˆ`payment_status`ï¼‰ï¼šè¡¨ç¤ºä»˜æ¬¾æ˜¯å¦å®Œæˆ
  - `pending`: å¾…ä»˜æ¬¾
  - `paid`: å·²ä»˜æ¬¾

- **è¨‚æˆ¿ç‹€æ…‹**ï¼ˆ`status`ï¼‰ï¼šè¡¨ç¤ºè¨‚æˆ¿æ˜¯å¦æœ‰æ•ˆ
  - `reserved`: ä¿ç•™ä¸­
  - `active`: æœ‰æ•ˆ
  - `cancelled`: å·²å–æ¶ˆ

### 2. è‡ªå‹•æ›´æ–°è¦å‰‡

- âœ… **ç·šä¸Šåˆ·å¡ä»˜æ¬¾å®Œæˆ**ï¼šè‡ªå‹•æ›´æ–° `payment_status` å’Œ `status`
- âœ… **æ‰‹å‹•æ›´æ–°ä»˜æ¬¾ç‹€æ…‹ç‚ºå·²ä»˜æ¬¾**ï¼šå¦‚æœ `status` ç‚º `reserved`ï¼Œè‡ªå‹•æ›´æ–°ç‚º `active`
- âœ… **è‡ªå‹•å–æ¶ˆéæœŸè¨‚æˆ¿**ï¼šåªæ›´æ–° `status`ï¼Œä¸æ”¹è®Š `payment_status`

### 3. æŸ¥è©¢é‚è¼¯

- åŒ¯æ¬¾æé†’ï¼šåªæŸ¥è©¢ `payment_status = 'pending'` çš„è¨‚æˆ¿
- å…¥ä½æé†’ï¼šåªæŸ¥è©¢ `payment_status = 'paid'` çš„è¨‚æˆ¿
- è‡ªå‹•å–æ¶ˆï¼šåªæŸ¥è©¢ `payment_status = 'pending'` çš„è¨‚æˆ¿

## ğŸ” ç›¸é—œç¨‹å¼ç¢¼ä½ç½®

- **å»ºç«‹è¨‚æˆ¿æ™‚è¨­å®šä»˜æ¬¾ç‹€æ…‹**ï¼š`server.js` ç¬¬ 490-500 è¡Œ
- **ç·šä¸Šåˆ·å¡ä»˜æ¬¾å®Œæˆæ›´æ–°**ï¼š`server.js` ç¬¬ 1467-1473 è¡Œ
- **æ‰‹å‹•æ›´æ–°ä»˜æ¬¾ç‹€æ…‹**ï¼š`server.js` ç¬¬ 894-901 è¡Œ
- **æŸ¥è©¢åŒ¯æ¬¾æé†’è¨‚æˆ¿**ï¼š`database.js` ç¬¬ 1793-1841 è¡Œ
- **æŸ¥è©¢å…¥ä½æé†’è¨‚æˆ¿**ï¼š`database.js` ç¬¬ 1824-1856 è¡Œ
- **æŸ¥è©¢éæœŸä¿ç•™è¨‚æˆ¿**ï¼š`database.js` ç¬¬ 1944-1963 è¡Œ
- **ä»˜æ¬¾ç‹€æ…‹é¡¯ç¤º**ï¼š`admin.js` ç¬¬ 434-452 è¡Œ

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [è¨‚æˆ¿ç‹€æ…‹åˆ¤æ–·èªªæ˜.md](./è¨‚æˆ¿ç‹€æ…‹åˆ¤æ–·èªªæ˜.md) - è¨‚æˆ¿ç‹€æ…‹çš„è©³ç´°èªªæ˜
- [éƒµä»¶ç‹€æ…‹é‚è¼¯èªªæ˜.md](./éƒµä»¶ç‹€æ…‹é‚è¼¯èªªæ˜.md) - éƒµä»¶ç™¼é€é‚è¼¯èªªæ˜

